import{m as p,n as d,a as g,D as P,b as w,t as N}from"./app.beeeec8e.js";import{T as E,P as O}from"./ProjectLog.192d36bc.js";import{T as M}from"./TaskMenu.e16f64e3.js";import{D as z}from"./index.2da9032e.js";import{U as F}from"./UserSelect.336ec81c.js";import{U as R}from"./tip.524aa564.js";import{D as U}from"./DialogWrapper.c933d20f.js";import{l as B}from"./longpress.43ca7fd9.js";import"./ImgUpload.a109c6d2.js";import"./details.50b6ce38.js";var V=function(){var t=this,s=t.$createElement,e=t._self._c||s;return t.rowMode?e("Row",{staticClass:"task-add-row"},[e("Col",{class:["row-add",t.active?"active":""],attrs:{span:"12"}},[e("div",{staticClass:"add-input",on:{mouseenter:function(a){t.mouseEnter=!0},mouseleave:function(a){t.mouseEnter=!1}}},[e("Input",{ref:"input",attrs:{type:"textarea",rows:1,autosize:{minRows:1,maxRows:3},maxlength:255,placeholder:t.$L(t.typeName+"\u63CF\u8FF0\uFF0C\u56DE\u8F66\u521B\u5EFA"),enterkeyhint:"done"},on:{"on-focus":function(a){t.onFocus=!0},"on-blur":function(a){t.onFocus=!1},"on-keydown":t.onKeydown},model:{value:t.addData.name,callback:function(a){t.$set(t.addData,"name",a)},expression:"addData.name"}}),t.parentId==0?e("div",{staticClass:"priority"},[e("ul",t._l(t.taskPriority,function(a,o){return e("li",{key:o},[t.active?e("ETooltip",{attrs:{disabled:t.$isEEUiApp||t.windowTouch,content:t.taskPriorityContent(a)}},[e("i",{staticClass:"taskfont",style:{color:a.color},domProps:{innerHTML:t._s(t.addData.p_name==a.name?"&#xe61d;":"&#xe61c;")},on:{click:function(i){return t.choosePriority(a)}}})]):t._e()],1)}),0),e("Icon",{attrs:{type:"md-settings"},on:{click:t.onPriority}})],1):t._e()],1),e("div",{staticClass:"add-btn",on:{click:t.openAdd}},[e("Icon",{staticClass:"add-icon",attrs:{type:"md-add"}}),t._v(t._s(t.$L("\u6DFB\u52A0"+t.typeName))+" ")],1)]),e("Col",{attrs:{span:"3"}}),e("Col",{attrs:{span:"3"}}),e("Col",{attrs:{span:"3"}}),e("Col",{attrs:{span:"3"}})],1):e("div",{class:["task-add-simple",t.active?"active":""],on:{mouseenter:function(a){t.mouseEnter=!0},mouseleave:function(a){t.mouseEnter=!1}}},[e("Input",{ref:"input",attrs:{type:"textarea",rows:2,autosize:{minRows:2,maxRows:3},maxlength:255,placeholder:t.$L(t.typeName+"\u63CF\u8FF0\uFF0C\u56DE\u8F66\u521B\u5EFA"),enterkeyhint:"done"},on:{"on-focus":function(a){t.onFocus=!0},"on-blur":function(a){t.onFocus=!1},"on-keydown":t.onKeydown},model:{value:t.addData.name,callback:function(a){t.$set(t.addData,"name",a)},expression:"addData.name"}}),e("div",{staticClass:"add-placeholder",on:{click:t.openAdd}},[e("Icon",{attrs:{type:"md-add"}}),t._v(t._s(t.$L("\u6DFB\u52A0"+t.typeName))+" ")],1),e("div",{staticClass:"priority"},[e("ul",t._l(t.taskPriority,function(a,o){return e("li",{key:o},[t.active?e("ETooltip",{attrs:{disabled:t.$isEEUiApp||t.windowTouch,content:t.taskPriorityContent(a)}},[e("i",{staticClass:"taskfont",style:{color:a.color},domProps:{innerHTML:t._s(t.addData.p_name==a.name?"&#xe61d;":"&#xe61c;")},on:{click:function(i){return t.choosePriority(a)}}})]):t._e()],1)}),0),e("Icon",{attrs:{type:"md-settings"},on:{click:t.onPriority}})],1)],1)},H=[];const K={name:"TaskAddSimple",props:{parentId:{type:Number,default:0},projectId:{type:Number,default:0},columnId:{type:Number,default:0},addTop:{type:Boolean,default:!1},autoActive:{type:Boolean,default:!1},rowMode:{type:Boolean,default:!1}},data(){return{addData:{name:"",owner:0,column_id:0,times:[],subtasks:[],p_level:0,p_name:"",p_color:"",visibility_appoint:1,visibility_appointor:[]},active:!1,onFocus:!1,mouseEnter:!1}},mounted(){this.autoActive&&this.$nextTick(this.openAdd)},computed:{...p(["taskPriority"]),typeName(){return this.parentId>0?"\u5B50\u4EFB\u52A1":"\u4EFB\u52A1"}},watch:{active(t){t||this.$emit("on-close")},mouseEnter(){this.chackClose()},onFocus(){this.chackClose()}},methods:{getData(){return this.parentId>0?{task_id:this.parentId,name:this.addData.name}:(this.addData.project_id=this.projectId||this.$store.state.projectId,this.addData.column_id=this.columnId||"",this.addData.owner=[this.userId],this.addData.top=this.addTop?1:0,$A.cloneJSON(this.addData))},openAdd(){this.active=!0,this.defaultPriority(),this.$nextTick(()=>{this.$refs.input.focus()})},chackClose(){this.mouseEnter||this.onFocus||this.addData.name||(this.active=!1)},onPriority(){this.$emit("on-priority",this.getData()),this.active=!1},onKeydown(t){if(t.keyCode===13){if(t.shiftKey)return;t.preventDefault(),this.onAdd()}},onAdd(){if(!this.addData.name){$A.messageWarning("\u8BF7\u8F93\u5165\u4EFB\u52A1\u63CF\u8FF0");return}this.loadIng++;let t=this.parentId>0?"taskAddSub":"taskAdd";this.$store.dispatch(t,this.getData()).then(({msg:s})=>{$A.messageSuccess(s),this.loadIng--,this.active=!1,this.addData={name:"",owner:0,column_id:0,times:[],subtasks:[],p_level:0,p_name:"",p_color:"",visibility_appoint:1,visibility_appointor:[]}}).catch(({msg:s})=>{$A.modalError(s),this.loadIng--})},taskPriorityContent(t){let s=$A.runNum(t.days);return s<=0?t.name+" ("+this.$L("\u65E0\u65F6\u95F4\u9650\u5236")+")":t.name+" ("+s+this.$L("\u5929")+")"},choosePriority(t){if($A.runNum(t.days)>0){let s=new Date,e=new Date(new Date().setDate(s.getDate()+$A.runNum(t.days)));this.$set(this.addData,"times",$A.date2string([s,e]))}else this.$set(this.addData,"times",[]);this.$set(this.addData,"p_level",t.priority),this.$set(this.addData,"p_name",t.name),this.$set(this.addData,"p_color",t.color),this.$nextTick(()=>{this.$refs.input.focus()})},defaultPriority(){this.taskPriority.length!==0&&(this.addData.p_name||this.choosePriority(this.taskPriority[0]))}}},k={};var Y=d(K,V,H,!1,X,null,null,null);function X(t){for(let s in k)this[s]=k[s]}var W=function(){return Y.exports}(),J=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"task-rows"},[t._l(t.list,function(a,o){return e("div",{key:o},[e("Row",{staticClass:"task-row",style:a.color?{backgroundColor:a.color,borderBottomColor:a.color}:{}},[a.p_name?e("em",{staticClass:"priority-color",style:{backgroundColor:a.p_color}}):t._e(),e("Col",{class:["row-name",a.complete_at?"complete":""],attrs:{span:"12"}},[a.sub_num>0&&a.sub_top!==!0||a.parent_id===0&&t.fastAddTask?e("Icon",{class:["sub-icon",t.taskOpen[a.id]?"active":""],attrs:{type:"ios-arrow-forward"},on:{click:function(i){return t.getSublist(a)}}}):t._e(),e("TaskMenu",{ref:`taskMenu_${a.id}`,refInFor:!0,attrs:{task:a}}),e("div",{staticClass:"item-title",on:{click:function(i){return t.openTask(a)}}},[a.flow_item_name?e("span",{class:a.flow_item_status,on:{click:function(i){return i.stopPropagation(),t.openMenu(i,a)}}},[t._v(t._s(a.flow_item_name))]):t._e(),a.sub_top===!0?e("span",[t._v(t._s(t.$L("\u5B50\u4EFB\u52A1")))]):t._e(),a.sub_my&&a.sub_my.length>0?e("span",[t._v("+"+t._s(a.sub_my.length))]):t._e(),t._v(" "+t._s(a.name)+" ")]),e("div",{staticClass:"item-icons",on:{click:function(i){return t.openTask(a)}}},[a.desc?e("div",{staticClass:"item-icon"},[e("i",{staticClass:"taskfont"},[t._v("\uE71A")])]):t._e(),a.file_num>0?e("div",{staticClass:"item-icon"},[e("i",{staticClass:"taskfont"},[t._v("\uE71C")]),e("em",[t._v(t._s(a.file_num))])]):t._e(),a.msg_num>0?e("div",{staticClass:"item-icon"},[e("i",{staticClass:"taskfont"},[t._v("\uE71E")]),e("em",[t._v(t._s(a.msg_num))])]):t._e(),a.sub_num>0?e("div",{staticClass:"item-icon",on:{click:function(i){return i.stopPropagation(),t.getSublist(a)}}},[e("i",{staticClass:"taskfont"},[t._v("\uE71F")]),e("em",[t._v(t._s(a.sub_complete)+"/"+t._s(a.sub_num))])]):t._e()])],1),e("Col",{staticClass:"row-column",attrs:{span:"3"}},[e("EDropdown",{attrs:{trigger:"click",size:"small",placement:"bottom",disabled:a.sub_top===!0},on:{command:function(i){return t.dropTask(a,i)}}},[e("div",{staticClass:"task-column"},[t._v(t._s(t.columnName(a.column_id)))]),e("EDropdownMenu",{attrs:{slot:"dropdown"},slot:"dropdown"},t._l(t.columnList(a.project_id),function(i){return e("EDropdownItem",{key:i.id,attrs:{command:"column::"+i.id}},[t._v(" "+t._s(i.name)+" ")])}),1)],1)],1),e("Col",{staticClass:"row-priority",attrs:{span:"3"}},[e("EDropdown",{attrs:{trigger:"click",size:"small",placement:"bottom",disabled:a.sub_top===!0},on:{command:function(i){return t.dropTask(a,i)}}},[e("TaskPriority",{attrs:{backgroundColor:a.p_color}},[t._v(t._s(a.p_name))]),e("EDropdownMenu",{attrs:{slot:"dropdown"},slot:"dropdown"},t._l(t.taskPriority,function(i,r){return e("EDropdownItem",{key:r,attrs:{command:"priority::"+r}},[e("i",{staticClass:"taskfont",style:{color:i.color},domProps:{innerHTML:t._s(i.p_name==i.name?"&#xe61d;":"&#xe61c;")}}),t._v(" "+t._s(i.name)+" ")])}),1)],1)],1),e("Col",{staticClass:"row-user",attrs:{span:"3"}},[e("ul",{on:{click:function(i){return t.openTask(a)}}},[t._l(t.ownerUser(a.task_user),function(i,r){return r<3?e("li",{key:r},[e("UserAvatar",{attrs:{userid:i.userid,size:"32",borderWitdh:2,borderColor:a.color,showName:t.ownerUser(a.task_user).length===1}})],1):t._e()}),t.ownerUser(a.task_user).length===0?e("li",{staticClass:"no-owner"},[e("Button",{attrs:{type:"primary",size:"small"},on:{click:function(i){return i.stopPropagation(),t.openTask(a,!0)}}},[t._v(t._s(t.$L("\u9886\u53D6\u4EFB\u52A1")))])],1):t._e()],2)]),e("Col",{staticClass:"row-time",attrs:{span:"3"}},[!a.complete_at&&a.end_at?e("ETooltip",{class:["task-time",a.today?"today":"",a.overdue?"overdue":""],attrs:{disabled:t.$isEEUiApp||t.windowTouch,"open-delay":600,content:a.end_at}},[e("div",{on:{click:function(i){return t.openTask(a)}}},[t._v(t._s(t.expiresFormat(a.end_at)))])]):t.showCompleteAt&&a.complete_at?e("div",{attrs:{title:a.complete_at}},[t._v(t._s(t.completeAtFormat(a.complete_at)))]):t._e()],1)],1),t.taskOpen[a.id]===!0?e("TaskRow",{attrs:{list:t.subTask(a.id),"parent-id":a.id,"fast-add-task":a.parent_id===0&&t.fastAddTask,"open-key":t.openKey},on:{command:t.dropTask}}):t._e()],1)}),t.fastAddTask||t.parentId>0?e("TaskAddSimple",{attrs:{"parent-id":t.parentId,"row-mode":""},on:{"on-priority":t.onPriority}}):t._e()],2)},G=[];const q={name:"TaskRow",components:{TaskMenu:M,TaskAddSimple:W,TaskPriority:E},props:{list:{type:Array,default:()=>[]},parentId:{type:Number,default:0},fastAddTask:{type:Boolean,default:!1},openKey:{type:String,default:"default"},showCompleteAt:{type:Boolean,default:!1}},data(){return{nowTime:$A.Time(),nowInterval:null,taskLoad:{},taskOpen:{}}},mounted(){this.nowInterval=setInterval(()=>{this.nowTime=$A.Time()},1e3)},destroyed(){clearInterval(this.nowInterval)},computed:{...p(["cacheTasks","taskPriority","cacheColumns"]),subTask(){return function(t){return this.cacheTasks.filter(s=>s.archived_at?!1:s.parent_id==t).sort((s,e)=>s.id-e.id)}}},methods:{columnName(t){const s=this.cacheColumns.find(({id:e})=>e==t);return s?s.name:""},dropTask(t,s){const e=this.$refs[`taskMenu_${t.id}`];if(!!e){if($A.leftExists(s,"column::")){e[0].updateTask({column_id:$A.leftDelete(s,"column::")});return}if($A.leftExists(s,"priority::")){let a=this.taskPriority[parseInt($A.leftDelete(s,"priority::"))];a&&e[0].updateTask({p_level:a.priority,p_name:a.name,p_color:a.color})}}},onPriority(t){this.$emit("on-priority",t)},getSublist(t){if(t.sub_top===!0){this.openTask(t);return}if(this.taskOpen[t.id]===!0){this.$set(this.taskOpen,t.id,!1);return}this.taskLoad[t.id]!==!0&&(this.$set(this.taskLoad,t.id,!0),this.$store.dispatch("getTaskForParent",t.id).then(()=>{this.$set(this.taskLoad,t.id,!1),this.$set(this.taskOpen,t.id,!0)}).catch(({msg:s})=>{$A.modalError(s),this.$set(this.taskLoad,t.id,!1)}))},columnList(t){return this.cacheColumns.filter(({project_id:s})=>s==t)},openTask(t,s){this.$store.dispatch("openTask",t),s===!0&&setTimeout(()=>{g.Store.set("receiveTask",!0)},300)},openMenu(t,s){const e=this.$refs[`taskMenu_${s.id}`];e&&e[0].handleClick(t)},ownerUser(t){return t.filter(({owner:s})=>s==1).sort((s,e)=>s.id-e.id)},expiresFormat(t){return $A.countDownFormat(t,this.nowTime)},completeAtFormat(t){let s=$A.Date(t,!0);return $A.formatDate("Y")===$A.formatDate("Y",s)?$A.formatDate("m-d H:i",s):$A.formatDate("Y-m-d",s)}}},y={};var Q=d(q,J,G,!1,Z,null,null,null);function Z(t){for(let s in y)this[s]=y[s]}var tt=function(){return Q.exports}(),et=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"task-archived"},[e("div",{staticClass:"archived-title"},[t._v(" "+t._s(t.$L("\u5F52\u6863\u7684\u4EFB\u52A1"))+" "),e("div",{staticClass:"title-icon"},[t.loadIng>0?e("Loading"):t._e()],1)]),e("div",{staticClass:"search-container lr"},[e("ul",[e("li",[e("div",{staticClass:"search-label"},[t._v(" "+t._s(t.$L("\u5173\u952E\u8BCD"))+" ")]),e("div",{staticClass:"search-content"},[e("Input",{attrs:{placeholder:t.$L("ID\u3001\u4EFB\u52A1\u540D..."),clearable:""},model:{value:t.keys.name,callback:function(a){t.$set(t.keys,"name",a)},expression:"keys.name"}})],1)]),e("li",{staticClass:"search-button"},[e("Tooltip",{attrs:{theme:"light",placement:"right","transfer-class-name":"search-button-clear",transfer:""}},[e("Button",{attrs:{loading:t.loadIng>0,type:"primary",icon:"ios-search"},on:{click:t.onSearch}},[t._v(t._s(t.$L("\u641C\u7D22")))]),e("div",{attrs:{slot:"content"},slot:"content"},[t.keyIs?e("Button",{attrs:{type:"text"},on:{click:function(a){t.keyIs=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88\u7B5B\u9009")))]):e("Button",{attrs:{loading:t.loadIng>0,type:"text"},on:{click:t.getLists}},[t._v(t._s(t.$L("\u5237\u65B0")))])],1)],1)],1)])]),e("div",{staticClass:"table-page-box"},[e("Table",{attrs:{columns:t.columns,data:t.list,loading:t.loadIng>0,"no-data-text":t.$L(t.noText),stripe:""}}),e("Page",{attrs:{total:t.total,current:t.page,"page-size":t.pageSize,disabled:t.loadIng>0,simple:t.windowPortrait,"page-size-opts":[10,20,30,50,100],"show-elevator":"","show-sizer":"","show-total":""},on:{"on-change":t.setPage,"on-page-size-change":t.setPageSize}})],1)])},st=[];const at={name:"TaskArchived",props:{projectId:{type:Number,default:0}},data(){return{loadIng:0,keys:{},keyIs:!1,columns:[{title:"ID",key:"id",width:80,render:(t,{row:s,column:e})=>t("TableAction",{props:{column:e,align:"left"}},[t("div",s.id)])},{title:this.$L("\u4EFB\u52A1\u540D\u79F0"),key:"name",minWidth:200,render:(t,{row:s})=>t("AutoTip",{on:{"on-click":()=>{this.$store.dispatch("openTask",s)}}},s.name)},{title:this.$L("\u5B8C\u6210\u65F6\u95F4"),key:"complete_at",width:168,render:(t,{row:s})=>t("div",{style:{color:s.complete_at?"":"#f00"}},s.complete_at||this.$L("\u672A\u5B8C\u6210"))},{title:this.$L("\u5F52\u6863\u65F6\u95F4"),key:"archived_at",width:168},{title:this.$L("\u5F52\u6863\u4EBA\u5458"),key:"archived_userid",minWidth:100,render:(t,{row:s})=>s.archived_userid?t("UserAvatar",{props:{userid:s.archived_userid,size:24,showName:!0}}):t("Tag",this.$L("\u7CFB\u7EDF\u81EA\u52A8"))},{title:this.$L("\u64CD\u4F5C"),align:"center",width:100,render:(t,s)=>{if(this.cacheTasks.find(a=>a.id==s.row.id&&!a.archived_at))return t("div",{style:{color:"#888"}},this.$L("\u5DF2\u8FD8\u539F"));const e=[t("span",{style:{fontSize:"13px",cursor:"pointer",color:"#84C56A"},on:{click:()=>{this.$store.dispatch("openTask",s.row)}}},this.$L("\u67E5\u770B")),t("Poptip",{props:{title:s.row.__restorePoptipTitle,confirm:!0,transfer:!0,placement:"left",okText:this.$L("\u786E\u5B9A"),cancelText:this.$L("\u53D6\u6D88"),value:s.row.__restorePoptipShow,width:220},style:{marginLeft:"6px",fontSize:"13px",cursor:"pointer",color:"#84C56A"},on:{"on-ok":()=>{this.recovery(s.row)},"on-popper-hide":()=>{s.row.__restorePoptipLoadIng=!1,s.row.__restorePoptipTitle=this.$L("\u4F60\u786E\u5B9A\u8981\u8FD8\u539F\u5F52\u6863\u5417\uFF1F"),s.row.__restorePoptipShow=!1}}},[t("span",{on:{click:a=>{a.stopPropagation(),s.row.__restorePoptipLoadIng=!0,this.$store.dispatch("call",{url:"project/column/one",data:{column_id:s.row.column_id,deleted:"all"}}).then(({data:o})=>{o.deleted_at&&(s.row.__restorePoptipTitle=this.$L("\u68C0\u6D4B\u5230\u6240\u5C5E\u7684\u4EFB\u52A1\u5217\u8868\u5DF2\u88AB\u5220\u9664\uFF0C\u8BE5\u64CD\u4F5C\u5C06\u4F1A\u8FD8\u539F\u4EFB\u52A1\u5217\u8868\uFF0C\u4F60\u786E\u5B9A\u8981\u8FD8\u539F\u5F52\u6863\u5417\uFF1F")),s.row.__restorePoptipShow=!0}).catch(({msg:o})=>{$A.modalError({content:o})}).finally(o=>{s.row.__restorePoptipLoadIng=!1})}}},[s.row.__restorePoptipLoadIng?t("Loading",{style:{width:"26px",height:"15px"}}):this.$L("\u8FD8\u539F")])]),t("Poptip",{props:{title:this.$L("\u4F60\u786E\u5B9A\u8981\u5220\u9664\u4EFB\u52A1\u5417\uFF1F"),confirm:!0,transfer:!0,placement:"left",okText:this.$L("\u786E\u5B9A"),cancelText:this.$L("\u53D6\u6D88")},style:{marginLeft:"6px",fontSize:"13px",cursor:"pointer",color:"#f00"},on:{"on-ok":()=>{this.delete(s.row)}}},this.$L("\u5220\u9664"))];return t("TableAction",{props:{column:s.column}},e)}}],list:[],page:1,pageSize:20,total:0,noText:""}},mounted(){},computed:{...p(["cacheTasks"])},watch:{projectId:{handler(){this.getLists()},immediate:!0},keyIs(t){t||(this.keys={},this.setPage(1))}},methods:{onSearch(){this.page=1,this.getLists()},getLists(){!this.projectId||(this.loadIng++,this.keyIs=$A.objImplode(this.keys)!="",this.$store.dispatch("call",{url:"project/task/lists",data:{keys:this.keys,project_id:this.projectId,parent_id:-1,archived:"yes",sorts:{archived_at:"desc"},page:Math.max(this.page,1),pagesize:Math.max($A.runNum(this.pageSize),10)}}).then(({data:t})=>{this.page=t.current_page,this.total=t.total,this.list=t.data.map(s=>(s.__restorePoptipLoadIng=!1,s.__restorePoptipTitle=this.$L("\u4F60\u786E\u5B9A\u8981\u8FD8\u539F\u5F52\u6863\u5417\uFF1F"),s.__restorePoptipShow=!1,s)),this.noText="\u6CA1\u6709\u76F8\u5173\u7684\u6570\u636E"}).catch(()=>{this.noText="\u6570\u636E\u52A0\u8F7D\u5931\u8D25"}).finally(t=>{this.loadIng--}))},setPage(t){this.page=t,this.getLists()},setPageSize(t){this.page=1,this.pageSize=t,this.getLists()},recovery(t){this.list=this.list.filter(({id:s})=>s!=t.id),this.loadIng++,this.$store.dispatch("archivedTask",{task_id:t.id,type:"recovery"}).then(({msg:s})=>{$A.messageSuccess(s),this.loadIng--,this.getLists(),this.$store.dispatch("openTask",t)}).catch(({msg:s})=>{$A.modalError(s),this.loadIng--,this.getLists()})},delete(t){this.list=this.list.filter(({id:s})=>s!=t.id),this.loadIng++,this.$store.dispatch("removeTask",{task_id:t.id}).then(({msg:s})=>{$A.messageSuccess(s),this.loadIng--,this.getLists()}).catch(({msg:s})=>{$A.modalError(s),this.loadIng--,this.getLists()})}}},C={};var ot=d(at,et,st,!1,it,null,null,null);function it(t){for(let s in C)this[s]=C[s]}var rt=function(){return ot.exports}(),nt=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"project-workflow"},[e("div",{staticClass:"workflow-title"},[t._v(" "+t._s(t.$L("\u5DE5\u4F5C\u6D41\u8BBE\u7F6E"))+" "),e("div",{staticClass:"title-icon"},[t.loadIng>0?e("Loading"):e("Icon",{attrs:{type:"ios-refresh"},on:{click:t.getData}})],1)]),t.list.length>0?e("div",{staticClass:"workflow-content"},[e("Collapse",{attrs:{accordion:""},model:{value:t.openIndex,callback:function(a){t.openIndex=a},expression:"openIndex"}},t._l(t.list,function(a){return e("Panel",{key:a.id,attrs:{name:"index_"+a.id}},[e("div",{staticClass:"workflow-item"},[e("div",{staticClass:"workflow-name"},[t._v(t._s(a.name))]),e("div",{staticClass:"workflow-status"},t._l(a.project_flow_item,function(o){return e("div",{class:o.status},[t._v(t._s(o.name))])}),0),e("div",{staticClass:"workflow-save",on:{click:function(o){o.stopPropagation()}}},[t.contrast(a.project_flow_item,a.project_flow_bak)?[e("Button",{attrs:{loading:t.loadIng>0,type:"primary"},on:{click:function(o){return t.onSave(a)}}},[t._v(t._s(t.$L("\u4FDD\u5B58")))]),a.id>0?e("Button",{attrs:{disabled:t.loadIng>0,type:"primary",ghost:""},on:{click:function(o){return t.onReduction(a,o)}}},[t._v(t._s(t.$L("\u8FD8\u539F")))]):t._e()]:t._e(),e("Button",{attrs:{disabled:t.loadIng>0,type:"error",ghost:""},on:{click:function(o){return t.onDelete(a)}}},[t._v(t._s(t.$L("\u5220\u9664")))])],2)]),e("div",{staticClass:"taskflow-config",attrs:{slot:"content"},slot:"content"},[e("div",{staticClass:"taskflow-config-table"},[e("div",{staticClass:"taskflow-config-table-left-container"},[e("div",{staticClass:"taskflow-config-table-column-header left-header"},[t._v(t._s(t.$L("\u914D\u7F6E\u9879")))]),e("div",{ref:`overlay_${a.id}`,refInFor:!0,staticClass:"taskflow-config-table-column-body"},[e("div",{staticClass:"taskflow-config-table-block"},[e("div",{staticClass:"taskflow-config-table-block-title"},[t._v(t._s(t.$L("\u8BBE\u7F6E\u72B6\u6001\u4E3A")))]),e("div",{staticClass:"taskflow-config-table-block-item"},[e("div",[e("div",{staticClass:"title"},[t._v(t._s(t.$L("\u5F00\u59CB\u72B6\u6001")))]),e("div",{staticClass:"subtitle"},[t._v(t._s(t.$L("\u65B0\u5EFA\u4EFB\u52A1\u9ED8\u8BA4\u72B6\u6001")))])])]),e("div",{staticClass:"taskflow-config-table-block-item"},[e("div",[e("div",{staticClass:"title"},[t._v(t._s(t.$L("\u8FDB\u884C\u4E2D")))]),e("div",{staticClass:"subtitle"},[t._v(t._s(t.$L("\u53EF\u8BBE\u7F6E\u591A\u4E2A\u72B6\u6001\u4E3A\u8FDB\u884C\u4E2D")))])])]),e("div",{staticClass:"taskflow-config-table-block-item"},[e("div",[e("div",{staticClass:"title"},[t._v(t._s(t.$L("\u9A8C\u6536/\u6D4B\u8BD5")))]),e("div",{staticClass:"subtitle"},[t._v(t._s(t.$L("\u53EA\u80FD\u8BBE\u7F6E\u5355\u4E2A\u72B6\u6001\u4E3A\u9A8C\u6536/\u6D4B\u8BD5")))])])]),e("div",{staticClass:"taskflow-config-table-block-item"},[e("div",[e("div",{staticClass:"title"},[t._v(t._s(t.$L("\u7ED3\u675F\u72B6\u6001")))]),e("div",{staticClass:"subtitle"},[t._v(t._s(t.$L("\u8BE5\u72B6\u6001\u4E0B\u4EFB\u52A1\u81EA\u52A8\u6807\u8BB0\u5B8C\u6210")))])])])]),e("div",{staticClass:"taskflow-config-table-block hr"},[e("div",{staticClass:"taskflow-config-table-block-title"},[t._v(t._s(t.$L("\u53EF\u6D41\u8F6C\u5230")))]),t._l(a.project_flow_item,function(o){return e("div",{staticClass:"taskflow-config-table-block-item"},[e("span",{staticClass:"transform-status-name"},[t._v(t._s(o.name))])])})],2)])]),e("div",{staticClass:"taskflow-config-table-right-container"},[e("Draggable",{staticClass:"taskflow-config-table-list-wrapper",attrs:{list:a.project_flow_item,animation:150,disabled:t.$isEEUiApp||t.windowTouch,tag:"div",draggable:".column-border"},on:{sort:function(o){}}},[t._l(a.project_flow_item,function(o){return e("div",{staticClass:"taskflow-config-table-status-column column-border",class:o.status},[e("div",{staticClass:"taskflow-config-table-status-item taskflow-config-table-column-header"},[e("div",{staticClass:"status-label-with-menu",class:o.status},[e("div",{staticClass:"name"},[t._v(t._s(t.$L(o.name)))]),e("EDropdown",{staticClass:"more",class:{opacity:o.userids.length>0||o.columnid>0},attrs:{trigger:"click"},on:{command:function(i){return t.onMore(i,o)}}},[e("div",{staticClass:"more-icon"},[e("Badge",{attrs:{dot:o.userids.length>0||o.columnid>0}},[e("Icon",{attrs:{type:"ios-more"}})],1)],1),e("EDropdownMenu",{staticClass:"taskflow-config-more-dropdown-menu",attrs:{slot:"dropdown"},slot:"dropdown"},[o.userids.length>0?e("EDropdownItem",{attrs:{command:"user"}},[e("div",{staticClass:"users"},t._l(o.userids,function(i,r){return e("UserAvatar",{key:r,attrs:{userid:i,size:28,borderWitdh:1,showName:o.userids.length===1}})}),1)]):t._e(),e("EDropdownItem",{attrs:{command:"user"}},[e("div",{staticClass:"item"},[e("Icon",{attrs:{type:"md-settings"}}),e("Badge",{attrs:{dot:o.userids.length>0||o.columnid>0}},[t._v(" "+t._s(t.$L("\u72B6\u6001\u8BBE\u7F6E"))+" ")])],1)]),e("EDropdownItem",{attrs:{command:"name"}},[e("div",{staticClass:"item"},[e("Icon",{attrs:{type:"md-create"}}),t._v(t._s(t.$L("\u4FEE\u6539\u540D\u79F0"))+" ")],1)]),e("EDropdownItem",{attrs:{command:"remove"}},[e("div",{staticClass:"item delete"},[e("Icon",{attrs:{type:"md-trash"}}),t._v(t._s(t.$L("\u5220\u9664"))+" ")],1)])],1)],1)],1)]),e("div",{ref:`overlay_${a.id}`,refInFor:!0,staticClass:"taskflow-config-table-column-body"},[e("div",{staticClass:"taskflow-config-table-block"},[e("div",{staticClass:"taskflow-config-table-block-title"}),e("RadioGroup",{model:{value:o.status,callback:function(i){t.$set(o,"status",i)},expression:"item.status"}},[e("Radio",{attrs:{label:"start"}},[e("span")]),e("Radio",{attrs:{label:"progress"}},[e("span")]),e("Radio",{attrs:{label:"test"}},[e("span")]),e("Radio",{attrs:{label:"end"}},[e("span")])],1)],1),e("div",{staticClass:"taskflow-config-table-block"},[e("div",{staticClass:"taskflow-config-table-block-title"}),e("CheckboxGroup",{on:{"on-change":function(i){return t.onTurns(o)}},model:{value:o.turns,callback:function(i){t.$set(o,"turns",i)},expression:"item.turns"}},t._l(a.project_flow_item,function(i){return e("Checkbox",{key:i.id,attrs:{label:i.id,disabled:i.id==o.id}},[e("span")])}),1)],1)])])}),e("div",{staticClass:"taskflow-config-table-status-column addnew",on:{click:function(o){return t.onAdd(a)}}},[t._v(t._s(t.$L("\u6DFB\u52A0\u72B6\u6001")))])],2)],1)])])])}),1)],1):t.loadIng==0?e("div",{staticClass:"workflow-no"},[t._v(" "+t._s(t.$L("\u5F53\u524D\u9879\u76EE\u8FD8\u6CA1\u6709\u521B\u5EFA\u5DE5\u4F5C\u6D41"))+" "),e("Button",{attrs:{type:"primary"},on:{click:t.onCreate}},[t._v(t._s(t.$L("\u521B\u5EFA\u5DE5\u4F5C\u6D41")))])],1):t._e(),e("Modal",{attrs:{styles:{width:"90%",maxWidth:"640px"},title:`${t.$L("\u72B6\u6001\u8BBE\u7F6E")} (${t.settingData.name})`,"mask-closable":!1},model:{value:t.userShow,callback:function(a){t.userShow=a},expression:"userShow"}},[e("Form",{attrs:{model:t.settingData,"label-width":"auto"},nativeOn:{submit:function(a){a.preventDefault()}}},[e("div",{staticClass:"workflow-setting-box"},[e("h3",[t._v(t._s(t.$L("\u72B6\u6001\u8D1F\u8D23\u4EBA")))]),e("div",{staticClass:"form-box"},[e("FormItem",{attrs:{prop:"userids",label:t.$L("\u72B6\u6001\u8D1F\u8D23\u4EBA")}},[e("UserSelect",{attrs:{"project-id":t.projectId,"multiple-max":5,title:t.$L("\u9009\u62E9\u72B6\u6001\u8D1F\u8D23\u4EBA")},model:{value:t.settingData.userids,callback:function(a){t.$set(t.settingData,"userids",a)},expression:"settingData.userids"}})],1),e("FormItem",{attrs:{prop:"usertype",label:t.$L("\u6D41\u8F6C\u6A21\u5F0F")}},[e("RadioGroup",{model:{value:t.settingData.usertype,callback:function(a){t.$set(t.settingData,"usertype",a)},expression:"settingData.usertype"}},[e("Radio",{attrs:{label:"add"}},[t._v(t._s(t.$L("\u6DFB\u52A0\u6A21\u5F0F")))]),e("Radio",{attrs:{label:"replace"}},[t._v(t._s(t.$L("\u6D41\u8F6C\u6A21\u5F0F")))]),e("Radio",{attrs:{label:"merge"}},[t._v(t._s(t.$L("\u5254\u9664\u6A21\u5F0F")))])],1),t.settingData.usertype=="replace"?e("div",{staticClass:"form-tip"},[t._v(t._s(t.$L(`\u6D41\u8F6C\u5230\u3010${t.settingData.name}\u3011\u65F6\u6539\u53D8\u4EFB\u52A1\u8D1F\u8D23\u4EBA\u4E3A\u72B6\u6001\u8D1F\u8D23\u4EBA\uFF0C\u539F\u672C\u7684\u4EFB\u52A1\u8D1F\u8D23\u4EBA\u79FB\u81F3\u534F\u52A9\u4EBA\u5458\u3002`)))]):t.settingData.usertype=="merge"?e("div",{staticClass:"form-tip"},[t._v(t._s(t.$L(`\u6D41\u8F6C\u5230\u3010${t.settingData.name}\u3011\u65F6\u6539\u53D8\u4EFB\u52A1\u8D1F\u8D23\u4EBA\u4E3A\u72B6\u6001\u8D1F\u8D23\u4EBA\uFF08\u5E76\u4FDD\u7559\u64CD\u4F5C\u72B6\u6001\u7684\u4EBA\u5458\uFF09\uFF0C\u539F\u672C\u7684\u4EFB\u52A1\u8D1F\u8D23\u4EBA\u79FB\u81F3\u534F\u52A9\u4EBA\u5458\u3002`)))]):e("div",{staticClass:"form-tip"},[t._v(t._s(t.$L(`\u6D41\u8F6C\u5230\u3010${t.settingData.name}\u3011\u65F6\u6DFB\u52A0\u72B6\u6001\u8D1F\u8D23\u4EBA\u81F3\u4EFB\u52A1\u8D1F\u8D23\u4EBA\u3002`)))])],1),e("FormItem",{attrs:{prop:"userlimit",label:t.$L("\u9650\u5236\u8D1F\u8D23\u4EBA")}},[e("iSwitch",{attrs:{"true-value":1,"false-value":0},model:{value:t.settingData.userlimit,callback:function(a){t.$set(t.settingData,"userlimit",a)},expression:"settingData.userlimit"}}),t.settingData.userlimit===1?e("div",{staticClass:"form-tip"},[t._v(t._s(t.$L(`\u6D41\u8F6C\u5230\u3010${t.settingData.name}\u3011\u65F6\uFF0C[\u4EFB\u52A1\u8D1F\u8D23\u4EBA] \u548C [\u9879\u76EE\u7BA1\u7406\u5458] \u53EF\u4EE5\u4FEE\u6539\u72B6\u6001\u3002`)))]):e("div",{staticClass:"form-tip"},[t._v(t._s(t.$L(`\u6D41\u8F6C\u5230\u3010${t.settingData.name}\u3011\u65F6\uFF0C[\u4EFB\u52A1\u8D1F\u8D23\u4EBA] \u548C [\u9879\u76EE\u7BA1\u7406\u5458] \u53EF\u4EE5\u4FEE\u6539\u72B6\u6001\u3002`)))])],1)],1)]),e("div",{staticClass:"workflow-setting-box"},[e("h3",[t._v(t._s(t.$L("\u5173\u8054\u5217\u8868")))]),e("div",{staticClass:"form-box"},[e("FormItem",{attrs:{prop:"usertype",label:t.$L("\u5173\u8054\u5217\u8868")}},[e("Select",{attrs:{placeholder:t.$L("\u9009\u62E9\u5173\u8054\u5217\u8868"),transfer:""},model:{value:t.settingData.columnid,callback:function(a){t.$set(t.settingData,"columnid",a)},expression:"settingData.columnid"}},t._l(t.columnList,function(a,o){return e("Option",{key:o,attrs:{value:a.id}},[t._v(t._s(a.name))])}),1),e("div",{staticClass:"form-tip"},[t._v(" "+t._s(t.$L(`\u6D41\u8F6C\u5230\u3010${t.settingData.name}\u3011\u65F6\u81EA\u52A8\u5C06\u4EFB\u52A1\u79FB\u52A8\u81F3\u5173\u8054\u5217\u8868\u3002`))+" "),t.settingData.columnid?e("a",{attrs:{href:"javascript:void(0)"},on:{click:function(a){t.settingData.columnid=0}}},[t._v(t._s(t.$L("\u53D6\u6D88\u5173\u8054")))]):t._e()])],1)],1)])]),e("div",{staticClass:"adaption",attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(a){t.userShow=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{type:"primary"},on:{click:t.onUser}},[t._v(t._s(t.$L("\u4FDD\u5B58")))])],1)],1)],1)},lt=[];const ct={name:"ProjectWorkflow",components:{UserSelect:F,Draggable:P},props:{projectId:{type:Number,default:0}},data(){return{loadIng:0,list:[],openIndex:"",userShow:!1,settingData:{}}},mounted(){},computed:{...p(["cacheColumns"]),columnList({projectId:t,cacheColumns:s}){return s.filter(({project_id:e})=>e==t).sort((e,a)=>e.sort!=a.sort?e.sort-a.sort:e.id-a.id).map(e=>({id:e.id,name:e.name}))}},watch:{projectId:{handler(t){t&&this.getData()},immediate:!0}},methods:{getData(){this.loadIng++,this.$store.dispatch("call",{url:"project/flow/list",data:{project_id:this.projectId}}).then(({data:t})=>{this.list=t.map(s=>(s.project_flow_bak=JSON.stringify(s.project_flow_item),s)),this.openIndex=this.list.length===1?"index_"+this.list[0].id:"",this.$nextTick(this.syncScroller)}).catch(({msg:t})=>{$A.modalError(t)}).finally(t=>{this.loadIng--})},syncScroller(){this.list.some(t=>{this.$refs[`overlay_${t.id}`]&&this.$refs[`overlay_${t.id}`].some(s=>{Object.keys(s.attributes).includes("sync-scroller")||(s.setAttribute("sync-scroller",!0),s.addEventListener("scroll",({target:e})=>{let a=e.scrollTop,o=e.scrollLeft;this.$nextTick(()=>{this.$refs[`overlay_${t.id}`].some(i=>{i!=s&&i.scrollTo(o,a)})})}))})})},contrast(t,s){return JSON.stringify(t)!=s},existDiff(){return!!this.list.find(t=>this.contrast(t.project_flow_item,t.project_flow_bak))},onCreate(){let t=-1*$A.randNum(1e3,1e4);this.list.push({id:t,name:"Default",project_flow_item:[{id:-10,name:"\u5F85\u5904\u7406",status:"start",turns:[-10,-11,-12,-13,-14],userids:[],usertype:"add",userlimit:0,columnid:0},{id:-11,name:"\u8FDB\u884C\u4E2D",status:"progress",turns:[-10,-11,-12,-13,-14],userids:[],usertype:"add",userlimit:0,columnid:0},{id:-12,name:"\u5F85\u6D4B\u8BD5",status:"test",turns:[-10,-11,-12,-13,-14],userids:[],usertype:"add",userlimit:0,columnid:0},{id:-13,name:"\u5DF2\u5B8C\u6210",status:"end",turns:[-10,-11,-12,-13,-14],userids:[],usertype:"add",userlimit:0,columnid:0},{id:-14,name:"\u5DF2\u53D6\u6D88",status:"end",turns:[-10,-11,-12,-13,-14],userids:[],usertype:"add",userlimit:0,columnid:0}]}),this.openIndex="index_"+t,this.$nextTick(this.syncScroller)},onDelete(t){$A.modalConfirm({title:"\u5220\u9664\u5DE5\u4F5C\u6D41",content:"\u4F60\u786E\u5B9A\u8981\u5220\u9664\u5DE5\u4F5C\u6D41\u5417\uFF1F",loading:!0,onOk:()=>{if(t.id>0)return new Promise((e,a)=>{this.loadIng++,this.$store.dispatch("call",{url:"project/flow/delete",data:{project_id:this.projectId}}).then(({msg:o})=>{e(o);let i=this.list.findIndex(({id:r})=>r==t.id);i>-1&&this.list.splice(i,1)}).catch(({msg:o})=>{a(o)}).finally(o=>{this.loadIng--})});const s=this.list.findIndex(({id:e})=>e==t.id);s>-1&&this.list.splice(s,1)}})},onMore(t,s){switch(t){case"user":this.$set(this.settingData,"id",s.id),this.$set(this.settingData,"name",s.name),this.$set(this.settingData,"userids",s.userids),this.$set(this.settingData,"usertype",s.usertype),this.$set(this.settingData,"userlimit",s.userlimit),this.$set(this.settingData,"columnid",s.columnid),this.userShow=!0;break;case"name":this.onName(s);break;case"remove":this.onRemove(s);break}},onUser(){this.userShow=!1,this.list.some(t=>{let s=t.project_flow_item.find(e=>e.id==this.settingData.id);s&&(this.$set(s,"userids",this.settingData.userids),this.$set(s,"usertype",this.settingData.usertype),this.$set(s,"userlimit",this.settingData.userlimit),this.$set(s,"columnid",this.settingData.columnid))})},onName(t){$A.modalInput({value:t.name,title:"\u4FEE\u6539\u540D\u79F0",placeholder:"\u8BF7\u8F93\u5165\u6D41\u7A0B\u540D\u79F0",onOk:s=>{if(!s)return"\u8BF7\u8F93\u5165\u6D41\u7A0B\u540D\u79F0";this.$set(t,"name",s)}})},onRemove(t){this.list.some(s=>{let e=s.project_flow_item.findIndex(({id:a})=>a==t.id);e>-1&&s.project_flow_item.splice(e,1)})},onTurns(t){this.$set(t,"turns",t.turns.sort())},onAdd(t){$A.modalInput({title:"\u6DFB\u52A0\u72B6\u6001",placeholder:"\u8BF7\u8F93\u5165\u72B6\u6001\u540D\u79F0",onOk:s=>{if(!s)return"\u8BF7\u8F93\u5165\u72B6\u6001\u540D\u79F0";const e=$A.randNum(1e5,999999)*-1,a=t.project_flow_item.map(({id:o})=>o);t.project_flow_item.push({id:e,name:s,status:"end",turns:a,userids:[],usertype:"add",userlimit:0,columnid:0}),t.project_flow_item.some(o=>{o.turns.push(e)})}})},onReduction(t){this.$set(t,"project_flow_item",JSON.parse(t.project_flow_bak))},onSave(t){let s=0;t.project_flow_item.some(e=>{e.sort=s++}),this.loadIng++,this.$store.dispatch("call",{url:"project/flow/save",data:{project_id:this.projectId,flows:t.project_flow_item},method:"post"}).then(({data:e,msg:a})=>{$.messageSuccess(a),e.project_flow_bak=JSON.stringify(e.project_flow_item);let o=this.list.findIndex(({id:i})=>i==t.id);o>-1?this.list.splice(o,1,e):this.list.push(e),this.openIndex="index_"+e.id,this.$nextTick(this.syncScroller)}).catch(({msg:e})=>{$A.modalError(e)}).finally(e=>{this.loadIng--})},saveAll(){this.list.some(t=>{this.contrast(t.project_flow_item,t.project_flow_bak)&&this.onSave(t)})}}},b={};var dt=d(ct,nt,lt,!1,ut,null,null,null);function ut(t){for(let s in b)this[s]=b[s]}var ht=function(){return dt.exports}(),pt=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"task-deleted"},[e("div",{staticClass:"deleted-title"},[t._v(" "+t._s(t.$L("\u5220\u9664\u7684\u4EFB\u52A1"))+" "),e("div",{staticClass:"title-icon"},[t.loadIng>0?e("Loading"):t._e()],1)]),e("div",{staticClass:"search-container lr"},[e("ul",[e("li",[e("div",{staticClass:"search-label"},[t._v(" "+t._s(t.$L("\u5173\u952E\u8BCD"))+" ")]),e("div",{staticClass:"search-content"},[e("Input",{attrs:{placeholder:t.$L("ID\u3001\u4EFB\u52A1\u540D..."),clearable:""},model:{value:t.keys.name,callback:function(a){t.$set(t.keys,"name",a)},expression:"keys.name"}})],1)]),e("li",{staticClass:"search-button"},[e("Tooltip",{attrs:{theme:"light",placement:"right","transfer-class-name":"search-button-clear",transfer:""}},[e("Button",{attrs:{loading:t.loadIng>0,type:"primary",icon:"ios-search"},on:{click:t.onSearch}},[t._v(t._s(t.$L("\u641C\u7D22")))]),e("div",{attrs:{slot:"content"},slot:"content"},[t.keyIs?e("Button",{attrs:{type:"text"},on:{click:function(a){t.keyIs=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88\u7B5B\u9009")))]):e("Button",{attrs:{loading:t.loadIng>0,type:"text"},on:{click:t.getLists}},[t._v(t._s(t.$L("\u5237\u65B0")))])],1)],1)],1)])]),e("div",{staticClass:"table-page-box"},[e("Table",{attrs:{columns:t.columns,data:t.list,loading:t.loadIng>0,"no-data-text":t.$L(t.noText),stripe:""}}),e("Page",{attrs:{total:t.total,current:t.page,"page-size":t.pageSize,disabled:t.loadIng>0,simple:t.windowPortrait,"page-size-opts":[10,20,30,50,100],"show-elevator":"","show-sizer":"","show-total":""},on:{"on-change":t.setPage,"on-page-size-change":t.setPageSize}})],1)])},mt=[];const ft={name:"TaskDeleted",props:{projectId:{type:Number,default:0}},data(){return{loadIng:0,keys:{},keyIs:!1,columns:[{title:"ID",key:"id",width:80,render:(t,{row:s,column:e})=>t("TableAction",{props:{column:e,align:"left"}},[t("div",s.id)])},{title:this.$L("\u4EFB\u52A1\u540D\u79F0"),key:"name",minWidth:200,render:(t,{row:s})=>t("AutoTip",s.name)},{title:this.$L("\u521B\u5EFA\u65F6\u95F4"),key:"created_at",width:168},{title:this.$L("\u5220\u9664\u65F6\u95F4"),key:"deleted_at",width:168},{title:this.$L("\u5220\u9664\u4EBA\u5458"),key:"deleted_userid",minWidth:100,render:(t,{row:s})=>s.deleted_userid?t("UserAvatar",{props:{userid:s.deleted_userid,size:24,showName:!0}}):t("span","-")},{title:this.$L("\u64CD\u4F5C"),align:"center",width:100,render:(t,s)=>{const e=[t("Poptip",{props:{title:this.$L("\u4F60\u786E\u5B9A\u8981\u8FD8\u539F\u5220\u9664\u5417\uFF1F"),confirm:!0,transfer:!0,placement:"left",okText:this.$L("\u786E\u5B9A"),cancelText:this.$L("\u53D6\u6D88")},style:{fontSize:"13px",cursor:"pointer",color:"#84C56A"},on:{"on-ok":()=>{this.recovery(s.row)}}},this.$L("\u8FD8\u539F"))];return t("TableAction",{props:{column:s.column}},e)}}],list:[],page:1,pageSize:20,total:0,noText:""}},mounted(){},computed:{...p(["cacheTasks"])},watch:{projectId:{handler(){this.getLists()},immediate:!0},keyIs(t){t||(this.keys={},this.setPage(1))}},methods:{onSearch(){this.page=1,this.getLists()},getLists(){!this.projectId||(this.loadIng++,this.keyIs=$A.objImplode(this.keys)!="",this.$store.dispatch("call",{url:"project/task/lists",data:{keys:this.keys,project_id:this.projectId,parent_id:-1,deleted:"yes",sorts:{deleted_at:"desc"},page:Math.max(this.page,1),pagesize:Math.max($A.runNum(this.pageSize),10)}}).then(({data:t})=>{this.page=t.current_page,this.total=t.total,this.list=t.data,this.noText="\u6CA1\u6709\u76F8\u5173\u7684\u6570\u636E"}).catch(()=>{this.noText="\u6570\u636E\u52A0\u8F7D\u5931\u8D25"}).finally(t=>{this.loadIng--}))},setPage(t){this.page=t,this.getLists()},setPageSize(t){this.page=1,this.pageSize=t,this.getLists()},recovery(t){this.list=this.list.filter(({id:s})=>s!=t.id),this.loadIng++,this.$store.dispatch("removeTask",{task_id:t.id,type:"recovery"}).then(({msg:s})=>{$A.messageSuccess(s),this.loadIng--,this.getLists(),this.$store.dispatch("openTask",t)}).catch(({msg:s})=>{$A.modalError(s),this.loadIng--,this.getLists()})}}},j={};var _t=d(ft,pt,mt,!1,vt,null,null,null);function vt(t){for(let s in j)this[s]=j[s]}var $t=function(){return _t.exports}(),gt=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"common-gantt"},[e("div",{staticClass:"gantt-left",style:{width:t.menuWidth+"px"}},[e("div",{staticClass:"gantt-title"},[e("div",{staticClass:"gantt-title-text"},[t._v(t._s(t.$L("\u4EFB\u52A1\u540D\u79F0")))])]),e("ul",{ref:"ganttItem",staticClass:"gantt-item",on:{scroll:t.itemScrollListener,mouseenter:function(a){t.mouseType="item"}}},t._l(t.lists,function(a,o){return e("li",{key:o},[a.overdue?e("div",{staticClass:"item-overdue",on:{click:function(i){return t.clickItem(a)}}},[t._v(t._s(t.$L("\u5DF2\u8D85\u671F")))]):t._e(),e("div",{staticClass:"item-title",class:{complete:a.complete,overdue:a.overdue},on:{click:function(i){return t.clickItem(a)}}},[t._v(t._s(a.label))]),e("Icon",{staticClass:"item-icon",attrs:{type:"ios-locate-outline"},on:{click:function(i){return t.scrollPosition(o)}}})],1)}),0)]),e("div",{ref:"ganttRight",staticClass:"gantt-right"},[e("div",{staticClass:"gantt-chart"},[e("ul",{staticClass:"gantt-month"},t._l(t.monthNum,function(a,o){return e("li",{key:o,style:t.monthStyle(o)},[e("div",{staticClass:"month-format"},[t._v(t._s(t.monthFormat(o)))])])}),0),e("ul",{staticClass:"gantt-date",on:{mousedown:t.dateMouseDown}},t._l(t.dateNum,function(a,o){return e("li",{key:o,style:t.dateStyle(o)},[e("div",{staticClass:"date-format"},[e("div",{staticClass:"format-day"},[t._v(t._s(t.dateFormat(o,"day")))]),t.dateWidth>46?e("div",{staticClass:"format-week"},[t._v(t._s(t.dateFormat(o,"week")))]):t._e()])])}),0),e("ul",{ref:"ganttTimeline",staticClass:"gantt-timeline",on:{scroll:t.timelineScrollListener,mouseenter:function(a){t.mouseType="timeline"}}},t._l(t.lists,function(a,o){return e("li",{key:o},[e("div",{staticClass:"timeline-item",style:t.itemStyle(a),on:{mousedown:function(i){return t.itemMouseDown(i,a)}}},[e("div",{staticClass:"timeline-title",attrs:{title:a.label}},[t._v(t._s(a.label))]),e("div",{staticClass:"timeline-resizer"})])])}),0)])])])},wt=[];const kt={name:"GanttView",props:{lists:{type:Array},menuWidth:{type:Number,default:300},itemWidth:{type:Number,default:100}},data(){return{mouseType:"",mouseWidth:0,mouseScaleWidth:0,dateWidth:100,ganttWidth:0,mouseItem:null,mouseBak:{},dateMove:null}},mounted(){this.dateWidth=this.itemWidth,this.$refs.ganttRight.addEventListener("mousewheel",this.handleScroll,!1),document.addEventListener("mousemove",this.itemMouseMove),document.addEventListener("mouseup",this.itemMouseUp),window.addEventListener("resize",this.handleResize,!1),this.handleResize()},beforeDestroy(){this.$refs.ganttRight.removeEventListener("mousewheel",this.handleScroll,!1),document.removeEventListener("mousemove",this.itemMouseMove),document.removeEventListener("mouseup",this.itemMouseUp),window.removeEventListener("resize",this.handleResize,!1)},watch:{itemWidth(t){this.dateWidth=t}},computed:{monthNum(){const{ganttWidth:t,dateWidth:s}=this;return Math.floor(t/s/30)+2},monthStyle(){const{mouseWidth:t,dateWidth:s}=this;return function(e){let a=t==0?0:t/s,o=new Date,i=new Date(o.getFullYear(),o.getMonth(),o.getDate(),0,0,0),r=new Date(i.getTime()+a*864e5),n=new Date(r.getFullYear(),r.getMonth()+1,0,23,59,59),l=(n-r)/1e3/60/60/24,c=s*l;return e>0&&(n=new Date(r.getFullYear(),r.getMonth()+1+e,0),c=n.getDate()*s),{width:c+"px"}}},monthFormat(){const{mouseWidth:t,dateWidth:s}=this;return function(e){let a=t==0?0:t/s,o=new Date,i=new Date(o.getFullYear(),o.getMonth(),o.getDate(),0,0,0),r=new Date(i.getTime()+a*864e5);return e>0&&(r=new Date(r.getFullYear(),r.getMonth()+1+e,0)),$A.formatDate("Y-m",r)}},dateNum(){const{ganttWidth:t,dateWidth:s}=this;return Math.floor(t/s)+2},dateStyle(){const{mouseWidth:t,dateWidth:s}=this;return function(e){const a={};let o=t==0?0:t/s,i=Math.floor(o)+e;o==Math.floor(o)&&i--;let r=t==0?e-1:i,n=new Date(new Date().getTime()+r*864e5);[0,6].indexOf(n.getDay())!==-1&&(a.backgroundColor="#f9fafb");let l=s;return e==0&&(l=Math.abs((t%l-l)%l)),a.width=l+"px",a}},dateFormat(){const{mouseWidth:t,dateWidth:s}=this;return function(e,a){let o=t==0?0:t/s,i=Math.floor(o)+e;o==Math.floor(o)&&i--;let r=t==0?e-1:i,n=new Date(new Date().getTime()+r*864e5);return a=="day"?n.getDate():a=="week"?this.$L(`\u661F\u671F${"\u65E5\u4E00\u4E8C\u4E09\u56DB\u4E94\u516D".charAt(n.getDay())}`):n}},itemStyle(){const{mouseWidth:t,dateWidth:s,ganttWidth:e}=this;return function(a){const{start:o,end:i}=a.time,{style:r,moveX:n,moveW:l}=a;let c=new Date,u=new Date(c.getFullYear(),c.getMonth(),c.getDate(),0,0,0).getTime(),f=(o-u)/1e3/60/60/24,v=(i-u)/1e3/60/60/24,h=s*f+t*-1,m=s*(v-f);typeof n=="number"&&(h+=n),typeof l=="number"&&(m+=l);const _={left:Math.min(Math.max(h,m*-1.2),e*1.2).toFixed(2)+"px",width:m.toFixed(2)+"px"};return h<0&&Math.abs(h)<m&&(_.paddingLeft=Math.abs(h).toFixed(2)+"px"),h+m>e&&h<e&&(_.paddingRight=Math.abs(h+m-e).toFixed(2)+"px"),typeof r=="object"?Object.assign(_,r):_}}},methods:{itemScrollListener(t){this.mouseType!="timeline"&&(this.$refs.ganttTimeline.scrollTop=t.target.scrollTop)},timelineScrollListener(t){this.mouseType!="item"&&(this.$refs.ganttItem.scrollTop=t.target.scrollTop)},handleScroll(t){if(t.preventDefault(),t.ctrlKey){this.dateWidth=Math.min(600,Math.max(24,this.dateWidth-Math.floor(t.deltaY))),this.mouseWidth=this.ganttWidth/2*((this.dateWidth-100)/100)+this.dateWidth/100*this.mouseScaleWidth;return}if(t.deltaY!=0){const s=this.$refs.ganttTimeline;let e=s.scrollTop+t.deltaY;e<0?e=0:e>s.scrollHeight-s.clientHeight&&(e=s.scrollHeight-s.clientHeight),s.scrollTop!=e&&(this.mouseType="timeline",s.scrollTop=e)}t.deltaX!=0&&(this.mouseWidth+=t.deltaX,this.mouseScaleWidth+=t.deltaX*(100/this.dateWidth))},handleResize(){this.ganttWidth=this.$refs.ganttTimeline.clientWidth},dateMouseDown(t){t.preventDefault(),this.mouseItem=null,this.dateMove={clientX:t.clientX}},itemMouseDown(t,s){t.preventDefault();let e="moveX";t.target.className=="timeline-resizer"&&(e="moveW"),typeof s[e]!="number"&&this.$set(s,e,0),this.mouseBak={type:e,clientX:t.clientX,value:s[e]},this.mouseItem=s,this.dateMove=null},itemMouseMove(t){if(this.mouseItem!=null){t.preventDefault();const s=this.mouseBak.value+(t.clientX-this.mouseBak.clientX);if(this.mouseBak.type==="moveW"){const e=864e5/this.dateWidth,{start:a,end:o}=this.mouseItem.time;let i=s*e;if(o+i-a<=0)return}this.$set(this.mouseItem,this.mouseBak.type,s)}else if(this.dateMove!=null){t.preventDefault();let s=(this.dateMove.clientX-t.clientX)*5;this.dateMove.clientX=t.clientX,this.mouseWidth+=s,this.mouseScaleWidth+=s*(100/this.dateWidth)}},itemMouseUp(t){if(this.mouseItem!=null){const{start:s,end:e}=this.mouseItem.time;let a=!1,o=864e5/this.dateWidth;if(typeof this.mouseItem.moveX=="number"&&this.mouseItem.moveX!=0){let i=this.mouseItem.moveX*o;this.$set(this.mouseItem.time,"start",s+i),this.$set(this.mouseItem.time,"end",e+i),this.$set(this.mouseItem,"moveX",0),a=!0}if(typeof this.mouseItem.moveW=="number"&&this.mouseItem.moveW!=0){let i=this.mouseItem.moveW*o;this.$set(this.mouseItem.time,"end",e+i),this.$set(this.mouseItem,"moveW",0),a=!0}a?this.$emit("on-change",this.mouseItem):t.target.className=="timeline-title"&&this.clickItem(this.mouseItem),this.mouseItem=null}else this.dateMove!=null&&(this.dateMove=null)},scrollPosition(t){let s=new Date,e=new Date(s.getFullYear(),s.getMonth(),s.getDate(),0,0,0),a=864e5/this.dateWidth,o=(this.lists[t].time.start-e)/a-this.dateWidth-this.mouseWidth;this.mouseWidth+=o,this.mouseScaleWidth+=o*(100/this.dateWidth)},clickItem(t){this.$emit("on-click",t)}}},D={};var yt=d(kt,gt,wt,!1,Ct,null,null,null);function Ct(t){for(let s in D)this[s]=D[s]}var bt=function(){return yt.exports}(),jt=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"project-gstc-gantt"},[e("GanttView",{attrs:{lists:t.lists,menuWidth:t.menuWidth,itemWidth:80},on:{"on-change":t.onChange,"on-click":t.onClick}}),e("Dropdown",{staticClass:"project-gstc-dropdown-filtr",style:t.dropStyle,attrs:{trigger:"click"},on:{"on-click":t.onSwitchColumn}},[e("Icon",{staticClass:"project-gstc-dropdown-icon",class:{filtr:t.filtrProjectId>0},attrs:{type:"md-funnel"}}),e("DropdownMenu",{attrs:{slot:"list"},slot:"list"},[e("DropdownItem",{class:{"dropdown-active":t.filtrProjectId==0},attrs:{name:0}},[t._v(t._s(t.$L("\u5168\u90E8")))]),t._l(t.projectColumn,function(a,o){return e("DropdownItem",{key:o,class:{"dropdown-active":t.filtrProjectId==a.id},attrs:{name:a.id}},[t._v(" "+t._s(a.name)+" "),a.tasks?e("span",[t._v("("+t._s(t.filtrLength(a.tasks))+")")]):t._e()])})],2)],1),e("div",{staticClass:"project-gstc-edit",class:{info:t.editShowInfo,visible:t.editData&&t.editData.length>0}},[e("div",{staticClass:"project-gstc-edit-info"},[e("Table",{attrs:{size:"small","max-height":"600",columns:t.editColumns,data:t.editData}}),e("div",{staticClass:"project-gstc-edit-btns"},[e("Button",{attrs:{loading:t.editLoad>0,size:"small",type:"text"},on:{click:function(a){return t.editSubmit(!1)}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{loading:t.editLoad>0,size:"small",type:"primary"},on:{click:function(a){return t.editSubmit(!0)}}},[t._v(t._s(t.$L("\u4FDD\u5B58")))]),e("Icon",{staticClass:"zoom",attrs:{type:"md-arrow-dropright"},on:{click:function(a){t.editShowInfo=!1}}})],1)],1),e("div",{staticClass:"project-gstc-edit-small"},[e("div",{staticClass:"project-gstc-edit-text",on:{click:function(a){t.editShowInfo=!0}}},[t._v(t._s(t.$L("\u672A\u4FDD\u5B58\u8BA1\u5212\u65F6\u95F4"))+": "),t.editData?e("span",[t._v(t._s(t.editData.length))]):t._e()]),e("Button",{attrs:{loading:t.editLoad>0,size:"small",type:"text"},on:{click:function(a){return t.editSubmit(!1)}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{loading:t.editLoad>0,size:"small",type:"primary"},on:{click:function(a){return t.editSubmit(!0)}}},[t._v(t._s(t.$L("\u4FDD\u5B58")))])],1)])],1)},Dt=[];const Tt={name:"ProjectGantt",components:{GanttView:bt},props:{projectColumn:{default:[]},flowInfo:{default:{}}},data(){return{lists:[],filtrProjectId:0,editColumns:[{title:this.$L("\u4EFB\u52A1\u540D\u79F0"),key:"label",minWidth:150,ellipsis:!0},{title:this.$L("\u539F\u8BA1\u5212\u65F6\u95F4"),minWidth:135,align:"center",render:(t,{row:s})=>s.notime===!0?t("span","-"):t("div",{style:{}},[t("div",$A.formatDate("Y-m-d H:i",Math.round(s.baktime.start/1e3))),t("div",$A.formatDate("Y-m-d H:i",Math.round(s.baktime.end/1e3)))])},{title:this.$L("\u65B0\u8BA1\u5212\u65F6\u95F4"),minWidth:135,align:"center",render:(t,{row:s})=>t("div",{style:{}},[t("div",$A.formatDate("Y-m-d H:i",Math.round(s.newTime.start/1e3))),t("div",$A.formatDate("Y-m-d H:i",Math.round(s.newTime.end/1e3)))])}],editData:[],editLoad:0,editShowInfo:!1}},mounted(){this.initData()},computed:{...p(["taskPriority"]),...w(["projectData"]),menuWidth(){return this.windowWidth<1440?180:260},dropStyle(){return this.windowWidth<1440?{left:"142px"}:{}},completedTask(){return this.projectData.cacheParameter.completedTask}},watch:{projectColumn:{handler(){this.initData()},deep:!0},flowInfo:{handler(){this.initData()},deep:!0},completedTask(){this.initData()}},methods:{initData(){this.lists=[],this.projectColumn&&this.projectColumn.some(this.checkAdd)},flowTask(t){return $A.leftExists(this.flowInfo.value,"user:")&&!t.task_user.find(({userid:s,owner:e})=>s===this.flowInfo.userid&&e)?!0:this.flowInfo.value>0&&t.flow_item_id!==this.flowInfo.value},filtrLength(t){return t.filter(s=>!(s.complete_at&&!this.completedTask||this.flowTask(s))).length},checkAdd(t){this.filtrProjectId>0&&t.id!=this.filtrProjectId||t.tasks&&t.tasks.some(s=>{let e=!s.start_at||!s.end_at,a=this.getTimeObj(s),o=a.start,i=a.end;if(s.complete_at&&!this.completedTask||this.flowTask(s))return!1;let r="#058ce4";this.taskPriority.some(u=>{if(u.priority===s.p_level)return r=u.color,!0});let n={start:o,end:i},l=$A.cloneJSON(n),c=this.editData.find(({id:u})=>u==s.id);c&&(n=$A.cloneJSON(c.newTime)),this.lists.push({id:s.id,label:s.name,complete:s.complete_at,overdue:s.overdue,time:n,notime:e,baktime:l,style:{background:r}})})},onChange(t){const{time:s,baktime:e}=t;if(Math.abs(e.end-s.end)>1e3||Math.abs(e.start-s.start)>1e3){let a=this.editData.find(({id:o})=>o==t.id);a?a.newTime=s:this.editData.push({id:t.id,label:t.label,notime:t.notime,baktime:t.baktime,newTime:s})}},onClick(t){this.$store.dispatch("openTask",t)},editSubmit(t){this.editData&&this.editData.forEach(s=>{let e=this.lists.find(({id:a})=>a==s.id);if(t){this.editLoad++;let a=$A.formatDate("Y-m-d H:i",Math.round(s.newTime.start/1e3)),o=$A.formatDate("Y-m-d H:i",Math.round(s.newTime.end/1e3)),i={task_id:s.id,times:[a,o]};this.$store.dispatch("taskUpdate",i).then(({msg:r})=>{this.editLoad--,this.editLoad===0&&$A.messageSuccess(r),e&&this.$set(e,"baktime",$A.cloneJSON(e.time))}).catch(({msg:r})=>{this.editLoad--,this.editLoad===0&&$A.modalError(r),e&&this.$set(e,"time",$A.cloneJSON(e.baktime))})}else e&&this.$set(e,"time",$A.cloneJSON(e.baktime))}),this.editData=[]},getTimeObj(t){let s=$A.Time(t.start_at)||$A.Time(t.created_at),e=$A.Time(t.end_at)||$A.Time(t.created_at)+86400;return e==s&&(e=Math.round(new Date($A.formatDate("Y-m-d 23:59:59",e)).getTime()/1e3)),e=Math.max(e,s+60),s*=1e3,e*=1e3,{start:s,end:e}},onSwitchColumn(t){this.filtrProjectId=$A.runNum(t),this.initData()}}},T={};var Lt=d(Tt,jt,Dt,!1,It,null,null,null);function It(t){for(let s in T)this[s]=T[s]}var xt=function(){return Lt.exports}(),St=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"markdown-preview-nostyle",domProps:{innerHTML:t._s(t.html)}})},At=[];const Pt={name:"markdown-preview-nostyle",props:{initialValue:{type:String,default:""}},data(){return{html:""}},mounted(){this.translateMarkdown()},methods:{translateMarkdown(){this.html=N(this.initialValue,{sanitize:!1}).replace(/href="/gi,'target="_blank" href="')}},watch:{initialValue(){this.translateMarkdown()}}},L={};var Et=d(Pt,St,At,!1,Mt,null,null,null);function Mt(t){for(let s in L)this[s]=L[s]}var Ft=function(){return Et.exports}(),Wt=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"project-panel",class:[t.tabTypeActive]},[e("PageTitle",{attrs:{title:t.projectData.name}}),e("div",{staticClass:"project-titbox"},[e("div",{staticClass:"project-title"},[e("div",{staticClass:"project-back",on:{click:t.onBack}},[e("i",{staticClass:"taskfont"},[t._v("\uE676")])]),e("h1",{on:{click:t.showName}},[t._v(t._s(t.projectData.name))]),t.loading?e("div",{staticClass:"project-load"},[e("Loading")],1):t._e()]),e("ul",{staticClass:"project-icons"},[e("li",{staticClass:"project-avatar",class:{"cursor-default":t.projectData.owner_userid!==t.userId},on:{click:function(a){return t.projectDropdown("user")}}},[e("ul",[e("li",[e("UserAvatarTip",{attrs:{userid:t.projectData.owner_userid,size:36,borderWitdh:2,openDelay:0}},[e("p",[t._v(t._s(t.$L("\u9879\u76EE\u8D1F\u8D23\u4EBA")))])]),(t.windowWidth<=980||t.projectData.cacheParameter.chat)&&t.projectUser.length>0?e("Badge",{attrs:{type:"normal","overflow-count":999,count:t.projectData.project_user.length}}):t._e()],1),t._l(t.projectUser,function(a){return!(t.windowWidth<=980||t.projectData.cacheParameter.chat)&&t.projectUser.length>0?[a.userid===-1?e("li",{staticClass:"more"},[e("ETooltip",{attrs:{disabled:t.$isEEUiApp||t.windowTouch,content:t.$L("\u5171"+t.projectData.project_user.length+"\u4E2A\u6210\u5458")}},[e("Icon",{attrs:{type:"ios-more"}})],1)],1):e("li",[e("UserAvatarTip",{attrs:{userid:a.userid,size:36,borderWitdh:2,openDelay:0}})],1)]:t._e()})],2)]),e("li",{staticClass:"project-icon",on:{click:function(a){return t.addTaskOpen(0)}}},[e("ETooltip",{attrs:{disabled:t.$isEEUiApp||t.windowTouch,content:t.$L("\u6DFB\u52A0\u4EFB\u52A1")}},[e("Icon",{staticClass:"menu-icon",attrs:{type:"md-add"}})],1)],1),e("li",{class:["project-icon",t.searchText!=""?"active":""]},[e("Tooltip",{attrs:{always:t.searchText!="",theme:"light",rawIndex:10},on:{"on-popper-show":t.searchFocus}},[e("Icon",{staticClass:"menu-icon",attrs:{type:"ios-search"},on:{click:t.searchFocus}}),e("div",{attrs:{slot:"content"},slot:"content"},[e("Input",{ref:"searchInput",staticClass:"search-input",attrs:{placeholder:t.$L("ID\u3001\u540D\u79F0\u3001\u63CF\u8FF0..."),clearable:""},model:{value:t.searchText,callback:function(a){t.searchText=a},expression:"searchText"}})],1)],1)],1),e("li",{class:["project-icon",t.windowLandscape&&t.projectData.cacheParameter.chat?"active":""],on:{click:function(a){return t.toggleParameter("chat")}}},[e("Icon",{staticClass:"menu-icon",attrs:{type:"ios-chatbubbles"}}),e("Badge",{staticClass:"menu-badge",attrs:{"overflow-count":999,count:t.msgUnread}})],1),e("li",{staticClass:"project-icon"},[e("EDropdown",{attrs:{trigger:"click",transfer:""},on:{command:t.projectDropdown}},[e("Icon",{staticClass:"menu-icon",attrs:{type:"ios-more"}}),t.projectData.owner_userid===t.userId?e("EDropdownMenu",{attrs:{slot:"dropdown"},slot:"dropdown"},[e("EDropdownItem",{attrs:{command:"setting"}},[t._v(t._s(t.$L("\u9879\u76EE\u8BBE\u7F6E")))]),e("EDropdownItem",{attrs:{command:"workflow"}},[t._v(t._s(t.$L("\u5DE5\u4F5C\u6D41\u8BBE\u7F6E")))]),e("EDropdownItem",{attrs:{command:"user",divided:""}},[t._v(t._s(t.$L("\u6210\u5458\u7BA1\u7406")))]),e("EDropdownItem",{attrs:{command:"invite"}},[t._v(t._s(t.$L("\u9080\u8BF7\u94FE\u63A5")))]),e("EDropdownItem",{attrs:{command:"log",divided:""}},[t._v(t._s(t.$L("\u9879\u76EE\u52A8\u6001")))]),e("EDropdownItem",{attrs:{command:"archived_task"}},[t._v(t._s(t.$L("\u5DF2\u5F52\u6863\u4EFB\u52A1")))]),e("EDropdownItem",{attrs:{command:"deleted_task"}},[t._v(t._s(t.$L("\u5DF2\u5220\u9664\u4EFB\u52A1")))]),e("EDropdownItem",{attrs:{command:"transfer",divided:""}},[t._v(t._s(t.$L("\u79FB\u4EA4\u9879\u76EE")))]),e("EDropdownItem",{attrs:{command:"archived"}},[t._v(t._s(t.$L("\u5F52\u6863\u9879\u76EE")))]),e("EDropdownItem",{staticStyle:{color:"#f40"},attrs:{command:"delete"}},[t._v(t._s(t.$L("\u5220\u9664\u9879\u76EE")))])],1):e("EDropdownMenu",{attrs:{slot:"dropdown"},slot:"dropdown"},[e("EDropdownItem",{attrs:{command:"log"}},[t._v(t._s(t.$L("\u9879\u76EE\u52A8\u6001")))]),e("EDropdownItem",{attrs:{command:"archived_task"}},[t._v(t._s(t.$L("\u5DF2\u5F52\u6863\u4EFB\u52A1")))]),e("EDropdownItem",{attrs:{command:"deleted_task"}},[t._v(t._s(t.$L("\u5DF2\u5220\u9664\u4EFB\u52A1")))]),e("EDropdownItem",{staticStyle:{color:"#f40"},attrs:{command:"exit",divided:""}},[t._v(t._s(t.$L("\u9000\u51FA\u9879\u76EE")))])],1)],1)],1)])]),e("div",{staticClass:"project-subbox"},[e("div",{staticClass:"project-subtitle",on:{click:t.showDesc}},[e("MarkdownPreviewNostyle",{ref:"descPreview",attrs:{initialValue:t.projectData.desc}})],1),e("div",{staticClass:"project-switch"},[t.completedCount>0?e("div",{staticClass:"project-checkbox"},[e("Checkbox",{attrs:{value:t.projectData.cacheParameter.completedTask},on:{"on-change":t.toggleCompleted}},[t._v(t._s(t.$L("\u663E\u793A\u5DF2\u5B8C\u6210")))])],1):t._e(),t.flowList.length>0?e("div",{staticClass:"project-select"},[e("Cascader",{ref:"flow",attrs:{data:t.flowData,"transfer-class-name":"project-panel-flow-cascader",transfer:""},on:{"on-change":t.flowChange}},[e("span",{class:`project-flow ${t.flowInfo.status||""}`},[t._v(t._s(t.flowTitle))])])],1):t._e(),e("div",{staticClass:"project-switch-button"},[e("div",{staticClass:"slider",style:t.tabTypeStyle}),e("div",{class:{active:t.tabTypeActive==="column"},on:{click:function(a){return t.tabTypeChange("column")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE60C")])]),e("div",{class:{active:t.tabTypeActive==="table"},on:{click:function(a){return t.tabTypeChange("table")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE66A")])]),e("div",{class:{active:t.tabTypeActive==="gantt"},on:{click:function(a){return t.tabTypeChange("gantt")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE797")])])])])]),t.tabTypeActive==="column"?e("div",{staticClass:"project-column"},[e("Draggable",{staticClass:"column-list",attrs:{list:t.columnList,animation:150,disabled:t.sortDisabled||t.$isEEUiApp||t.windowTouch,tag:"ul",draggable:".column-item"},on:{sort:function(a){return t.sortUpdate(!0)}}},[t._l(t.columnList,function(a){return e("li",{staticClass:"column-item"},[e("div",{class:["column-head",a.color?"custom-color":""],style:a.color?{backgroundColor:a.color}:{}},[e("div",{staticClass:"column-head-title"},[e("AutoTip",[t._v(t._s(a.name))]),e("em",[t._v("("+t._s(t.panelTask(a.tasks).length)+")")])],1),e("div",{staticClass:"column-head-icon"},[t.columnLoad[a.id]===!0?e("div",{staticClass:"loading"},[e("Loading")],1):e("EDropdown",{attrs:{trigger:"click",size:"small"},on:{command:function(o){return t.dropColumn(a,o)}}},[e("Icon",{attrs:{type:"ios-more"}}),e("EDropdownMenu",{staticClass:"project-panel-more-dropdown-menu",attrs:{slot:"dropdown"},slot:"dropdown"},[e("EDropdownItem",{attrs:{command:"title"}},[e("div",{staticClass:"item"},[e("Icon",{attrs:{type:"md-create"}}),t._v(t._s(t.$L("\u4FEE\u6539"))+" ")],1)]),e("EDropdownItem",{attrs:{command:"remove"}},[e("div",{staticClass:"item"},[e("Icon",{attrs:{type:"md-trash"}}),t._v(t._s(t.$L("\u5220\u9664"))+" ")],1)]),t._l(t.$store.state.columnColorList,function(o,i){return e("EDropdownItem",{key:i,attrs:{divided:i==0,command:o}},[e("div",{staticClass:"item"},[e("i",{staticClass:"taskfont",style:{color:o.color||"#ddd"},domProps:{innerHTML:t._s(o.color==a.color?"&#xe61d;":"&#xe61c;")}}),t._v(t._s(t.$L(o.name))+" ")])])})],2)],1),e("Icon",{staticClass:"last",attrs:{type:"md-add"},on:{click:function(o){return t.addTopShow(a.id,!0)}}})],1)]),e("Scrollbar",{staticClass:"column-task"},[t.columnTopShow[a.id]?e("div",{staticClass:"task-item additem"},[e("TaskAddSimple",{attrs:{"column-id":a.id,"project-id":t.projectId,"add-top":!0,"auto-active":""},on:{"on-close":function(o){return t.addTopShow(a.id,!1)},"on-priority":t.addTaskOpen}})],1):t._e(),e("Draggable",{staticClass:"task-list",attrs:{list:a.tasks,animation:150,disabled:t.sortDisabled||t.$isEEUiApp||t.windowTouch,draggable:".task-draggable",filter:".complete",group:"task"},on:{sort:t.sortUpdate,remove:t.sortUpdate}},[t._l(a.tasks,function(o){return e("div",{class:["task-item task-draggable",o.complete_at?"complete":"",t.taskIsHidden(o)?"hidden":""],style:o.color?{backgroundColor:o.color}:{},on:{click:function(i){return t.openTask(o)}}},[e("div",{class:["task-head",o.desc?"has-desc":""]},[e("div",{staticClass:"task-title"},[o.flow_item_name?e("span",{class:o.flow_item_status,on:{click:function(i){return i.stopPropagation(),t.openMenu(i,o)}}},[t._v(t._s(o.flow_item_name))]):t._e(),e("pre",[t._v(t._s(o.name))])]),e("div",{staticClass:"task-menu",on:{click:function(i){i.stopPropagation()}}},[e("TaskMenu",{ref:`taskMenu_${o.id}`,refInFor:!0,attrs:{task:o,icon:"ios-more"}})],1)]),o.desc?e("div",{staticClass:"task-desc"},[e("pre",{domProps:{innerHTML:t._s(o.desc)}})]):t._e(),o.task_tag.length>0?e("div",{staticClass:"task-tags"},t._l(o.task_tag,function(i,r){return e("Tag",{key:r,attrs:{color:i.color}},[t._v(t._s(i.name))])}),1):t._e(),e("div",{staticClass:"task-users"},[e("ul",[t._l(t.ownerUser(o.task_user),function(i,r){return e("li",{key:r},[e("UserAvatar",{attrs:{userid:i.userid,size:"32",borderWitdh:2,borderColor:o.color}})],1)}),t.ownerUser(o.task_user).length===0?e("li",{staticClass:"no-owner"},[e("Button",{attrs:{type:"primary",size:"small",ghost:""},on:{click:function(i){return i.stopPropagation(),t.openTask(o,!0)}}},[t._v(t._s(t.$L("\u9886\u53D6\u4EFB\u52A1")))])],1):t._e()],2),o.file_num>0?e("div",{staticClass:"task-icon"},[t._v(t._s(o.file_num)),e("Icon",{attrs:{type:"ios-link-outline"}})],1):t._e(),o.msg_num>0?e("div",{staticClass:"task-icon"},[t._v(t._s(o.msg_num)),e("Icon",{attrs:{type:"ios-chatbubbles-outline"}})],1):t._e()]),e("div",{staticClass:"task-progress"},[o.sub_num>0?e("div",{staticClass:"task-sub-num"},[t._v(t._s(o.sub_complete)+"/"+t._s(o.sub_num))]):t._e(),e("Progress",{attrs:{percent:o.percent,"stroke-width":6}}),o.end_at?e("ETooltip",{class:["task-time",o.today?"today":"",o.overdue?"overdue":""],attrs:{disabled:t.$isEEUiApp||t.windowTouch,"open-delay":600,content:o.end_at}},[o.complete_at?t._e():e("div",[e("i",{staticClass:"taskfont"},[t._v("\uE71D")]),t._v(t._s(t.expiresFormat(o.end_at)))])]):t._e()],1),o.p_name?e("em",{staticClass:"priority-color",style:{backgroundColor:o.p_color}}):t._e()])}),e("div",{staticClass:"task-item additem"},[e("TaskAddSimple",{attrs:{"column-id":a.id,"project-id":t.projectId},on:{"on-priority":t.addTaskOpen}})],1)],2)],1)],1)}),e("li",{class:["add-column",t.addColumnShow?"show-input":""]},[e("div",{staticClass:"add-column-text",on:{click:t.addColumnOpen}},[e("Icon",{attrs:{type:"md-add"}}),t._v(t._s(t.$L("\u6DFB\u52A0\u5217\u8868"))+" ")],1),e("div",{staticClass:"add-column-input"},[e("Input",{ref:"addColumnName",attrs:{placeholder:t.$L("\u5217\u8868\u540D\u79F0\uFF0C\u56DE\u8F66\u521B\u5EFA"),clearable:""},on:{"on-blur":t.addColumnBlur,"on-enter":t.addColumnSubmit,"on-clear":function(a){t.addColumnShow=!1}},model:{value:t.addColumnName,callback:function(a){t.addColumnName=a},expression:"addColumnName"}})],1)])],2)],1):t.tabTypeActive==="table"?e("Scrollbar",{staticClass:"project-table",attrs:{"enable-x":""}},[e("div",{staticClass:"project-table-head"},[e("Row",{staticClass:"task-row"},[e("Col",{attrs:{span:"12"}},[t._v("# "+t._s(t.$L("\u4EFB\u52A1\u540D\u79F0")))]),e("Col",{attrs:{span:"3"}},[t._v(t._s(t.$L("\u5217\u8868")))]),e("Col",{attrs:{span:"3"}},[e("div",{staticClass:"sort",on:{click:function(a){return t.onSort("level")}}},[t._v(" "+t._s(t.$L("\u4F18\u5148\u7EA7"))+" "),e("div",{staticClass:"task-sort"},[e("Icon",{class:{on:t.sortField=="level"&&t.sortType=="asc"},attrs:{type:"md-arrow-dropup"}}),e("Icon",{class:{on:t.sortField=="level"&&t.sortType=="desc"},attrs:{type:"md-arrow-dropdown"}})],1)])]),e("Col",{attrs:{span:"3"}},[t._v(t._s(t.$L("\u8D1F\u8D23\u4EBA")))]),e("Col",{attrs:{span:"3"}},[e("div",{staticClass:"sort",on:{click:function(a){return t.onSort("end_at")}}},[t._v(" "+t._s(t.$L("\u5230\u671F\u65F6\u95F4"))+" "),e("div",{staticClass:"task-sort"},[e("Icon",{class:{on:t.sortField=="end_at"&&t.sortType=="asc"},attrs:{type:"md-arrow-dropup"}}),e("Icon",{class:{on:t.sortField=="end_at"&&t.sortType=="desc"},attrs:{type:"md-arrow-dropdown"}})],1)])])],1)],1),e("div",{class:["project-table-body",t.projectData.cacheParameter.showMy?"":"project-table-hide"]},[e("Row",{staticClass:"task-row"},[e("Col",{staticClass:"row-title",attrs:{span:"12"}},[e("i",{staticClass:"taskfont",on:{click:function(a){return t.toggleParameter("showMy")}}},[t._v("\uE689")]),e("div",{staticClass:"row-h1"},[t._v(t._s(t.$L("\u6211\u7684\u4EFB\u52A1")))]),e("div",{staticClass:"row-num"},[t._v("("+t._s(t.myList.length)+")")])]),e("Col",{attrs:{span:"3"}}),e("Col",{attrs:{span:"3"}}),e("Col",{attrs:{span:"3"}}),e("Col",{attrs:{span:"3"}})],1),t.projectData.cacheParameter.showMy?e("TaskRow",{attrs:{list:t.transforTasks(t.myList),"open-key":"my","fast-add-task":""},on:{"on-priority":t.addTaskOpen}}):t._e()],1),t.helpList.length?e("div",{class:["project-table-body",t.projectData.cacheParameter.showHelp?"":"project-table-hide"]},[e("Row",{staticClass:"task-row"},[e("Col",{staticClass:"row-title",attrs:{span:"12"}},[e("i",{staticClass:"taskfont",on:{click:function(a){return t.toggleParameter("showHelp")}}},[t._v("\uE689")]),e("div",{staticClass:"row-h1"},[t._v(t._s(t.$L("\u534F\u52A9\u7684\u4EFB\u52A1")))]),e("div",{staticClass:"row-num"},[t._v("("+t._s(t.helpList.length)+")")])]),e("Col",{attrs:{span:"3"}}),e("Col",{attrs:{span:"3"}}),e("Col",{attrs:{span:"3"}}),e("Col",{attrs:{span:"3"}})],1),t.projectData.cacheParameter.showHelp?e("TaskRow",{attrs:{list:t.helpList,"open-key":"help"},on:{"on-priority":t.addTaskOpen}}):t._e()],1):t._e(),t.projectData.task_num>0?e("div",{class:["project-table-body",t.projectData.cacheParameter.showUndone?"":"project-table-hide"]},[e("Row",{staticClass:"task-row"},[e("Col",{staticClass:"row-title",attrs:{span:"12"}},[e("i",{staticClass:"taskfont",on:{click:function(a){return t.toggleParameter("showUndone")}}},[t._v("\uE689")]),e("div",{staticClass:"row-h1"},[t._v(t._s(t.$L("\u672A\u5B8C\u6210\u4EFB\u52A1")))]),e("div",{staticClass:"row-num"},[t._v("("+t._s(t.unList.length)+")")])]),e("Col",{attrs:{span:"3"}}),e("Col",{attrs:{span:"3"}}),e("Col",{attrs:{span:"3"}}),e("Col",{attrs:{span:"3"}})],1),t.projectData.cacheParameter.showUndone?e("TaskRow",{attrs:{list:t.unList,"open-key":"undone"},on:{"on-priority":t.addTaskOpen}}):t._e()],1):t._e(),t.projectData.task_num>0?e("div",{class:["project-table-body",t.projectData.cacheParameter.showCompleted?"":"project-table-hide"]},[e("Row",{staticClass:"task-row"},[e("Col",{staticClass:"row-title",attrs:{span:"12"}},[e("i",{staticClass:"taskfont",on:{click:function(a){return t.toggleParameter("showCompleted")}}},[t._v("\uE689")]),e("div",{staticClass:"row-h1"},[t._v(t._s(t.$L("\u5DF2\u5B8C\u6210\u4EFB\u52A1")))]),e("div",{staticClass:"row-num"},[t._v("("+t._s(t.completedList.length)+")")])]),e("Col",{attrs:{span:"3"}}),e("Col",{attrs:{span:"3"}}),e("Col",{attrs:{span:"3"}}),e("Col",{attrs:{span:"3"}},[t._v(t._s(t.projectData.task_num>0&&t.projectData.cacheParameter.showCompleted?t.$L("\u5B8C\u6210\u65F6\u95F4"):""))])],1),t.projectData.cacheParameter.showCompleted?e("TaskRow",{attrs:{list:t.completedList,"open-key":"completed",showCompleteAt:""},on:{"on-priority":t.addTaskOpen}}):t._e()],1):t._e()]):t.tabTypeActive==="gantt"?e("div",{staticClass:"project-gantt"},[e("ProjectGantt",{attrs:{projectColumn:t.columnList,flowInfo:t.flowInfo}})],1):t._e(),e("Modal",{attrs:{title:t.$L("\u9879\u76EE\u8BBE\u7F6E"),"mask-closable":!1},model:{value:t.settingShow,callback:function(a){t.settingShow=a},expression:"settingShow"}},[e("Form",{attrs:{model:t.settingData,"label-width":"auto"},nativeOn:{submit:function(a){a.preventDefault()}}},[e("FormItem",{attrs:{prop:"name",label:t.$L("\u9879\u76EE\u540D\u79F0")}},[e("Input",{ref:"projectName",attrs:{type:"text",maxlength:32,placeholder:t.$L("\u5FC5\u586B")},model:{value:t.settingData.name,callback:function(a){t.$set(t.settingData,"name",a)},expression:"settingData.name"}})],1),e("FormItem",{attrs:{prop:"desc",label:t.$L("\u9879\u76EE\u4ECB\u7ECD")}},[e("Input",{ref:"projectDesc",attrs:{type:"textarea",autosize:{minRows:3,maxRows:5},maxlength:255,placeholder:`${t.$L("\u9009\u586B")} (${t.$L("\u652F\u6301 Markdown \u683C\u5F0F")})`},model:{value:t.settingData.desc,callback:function(a){t.$set(t.settingData,"desc",a)},expression:"settingData.desc"}})],1)],1),e("div",{staticClass:"adaption",attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(a){t.settingShow=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{type:"primary",loading:t.settingLoad>0},on:{click:t.onSetting}},[t._v(t._s(t.$L("\u4FEE\u6539")))])],1)],1),e("Modal",{attrs:{title:t.$L("\u6210\u5458\u7BA1\u7406"),"mask-closable":!1},model:{value:t.userShow,callback:function(a){t.userShow=a},expression:"userShow"}},[e("Form",{attrs:{model:t.userData,"label-width":"auto"},nativeOn:{submit:function(a){a.preventDefault()}}},[e("FormItem",{attrs:{prop:"userids",label:t.$L("\u9879\u76EE\u6210\u5458")}},[e("UserSelect",{attrs:{uncancelable:t.userData.uncancelable,"multiple-max":100,title:t.$L("\u9009\u62E9\u9879\u76EE\u6210\u5458")},model:{value:t.userData.userids,callback:function(a){t.$set(t.userData,"userids",a)},expression:"userData.userids"}})],1)],1),e("div",{staticClass:"adaption",attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(a){t.userShow=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),t.userWaitRemove.length>0?e("Poptip",{staticStyle:{"margin-left":"8px"},attrs:{confirm:"",placement:"bottom","ok-text":t.$L("\u786E\u5B9A"),"cancel-text":t.$L("\u53D6\u6D88"),transfer:""},on:{"on-ok":t.onUser}},[e("div",{attrs:{slot:"title"},slot:"title"},[e("p",[e("strong",[t._v(t._s(t.$L("\u79FB\u9664\u6210\u5458\u8D1F\u8D23\u7684\u4EFB\u52A1\u5C06\u53D8\u6210\u65E0\u8D1F\u8D23\u4EBA\uFF0C")))])]),e("p",[t._v(t._s(t.$L("\u6CE8\u610F\u6B64\u64CD\u4F5C\u4E0D\u53EF\u9006\uFF01")))]),e("ul",{staticClass:"project-panel-wait-remove"},[e("li",[t._v(t._s(t.$L("\u5373\u5C06\u79FB\u9664"))+"\uFF1A")]),t._l(t.userWaitRemove,function(a){return e("li",{key:a},[e("UserAvatar",{attrs:{userid:a,size:20,showName:""}})],1)})],2)]),e("Button",{attrs:{type:"primary",loading:t.userLoad>0}},[t._v(t._s(t.$L("\u4FDD\u5B58")))])],1):e("Button",{attrs:{type:"primary",loading:t.userLoad>0},on:{click:t.onUser}},[t._v(t._s(t.$L("\u4FDD\u5B58")))])],1)],1),e("Modal",{attrs:{title:t.$L("\u9080\u8BF7\u94FE\u63A5"),"mask-closable":!1},model:{value:t.inviteShow,callback:function(a){t.inviteShow=a},expression:"inviteShow"}},[e("Form",{attrs:{model:t.inviteData,"label-width":"auto"},nativeOn:{submit:function(a){a.preventDefault()}}},[e("FormItem",{attrs:{label:t.$L("\u94FE\u63A5\u5730\u5740")}},[e("Input",{ref:"inviteInput",attrs:{type:"textarea",rows:3,readonly:""},on:{"on-focus":t.inviteFocus},model:{value:t.inviteData.url,callback:function(a){t.$set(t.inviteData,"url",a)},expression:"inviteData.url"}}),e("div",{staticClass:"form-tip"},[t._v(" "+t._s(t.$L("\u53EF\u901A\u8FC7\u6B64\u94FE\u63A5\u76F4\u63A5\u52A0\u5165\u9879\u76EE\u3002"))+" "),e("Poptip",{attrs:{confirm:"",placement:"bottom","ok-text":t.$L("\u786E\u5B9A"),"cancel-text":t.$L("\u53D6\u6D88"),transfer:""},on:{"on-ok":function(a){return t.inviteGet(!0)}}},[e("div",{attrs:{slot:"title"},slot:"title"},[e("p",[e("strong",[t._v(t._s(t.$L("\u6CE8\u610F\uFF1A\u5237\u65B0\u5C06\u5BFC\u81F4\u539F\u6765\u7684\u9080\u8BF7\u94FE\u63A5\u5931\u6548\uFF01")))])])]),e("a",{attrs:{href:"javascript:void(0)"}},[t._v(t._s(t.$L("\u5237\u65B0\u94FE\u63A5")))])])],1)],1)],1),e("div",{staticClass:"adaption",attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(a){t.inviteShow=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{type:"primary",loading:t.inviteLoad>0},on:{click:t.inviteCopy}},[t._v(t._s(t.$L("\u590D\u5236")))])],1)],1),e("Modal",{attrs:{title:t.$L("\u79FB\u4EA4\u9879\u76EE"),"mask-closable":!1},model:{value:t.transferShow,callback:function(a){t.transferShow=a},expression:"transferShow"}},[e("Form",{attrs:{model:t.transferData,"label-width":"auto"},nativeOn:{submit:function(a){a.preventDefault()}}},[e("FormItem",{attrs:{prop:"owner_userid",label:t.$L("\u65B0\u9879\u76EE\u8D1F\u8D23\u4EBA")}},[e("UserSelect",{attrs:{"multiple-max":1,title:t.$L("\u9009\u62E9\u9879\u76EE\u8D1F\u8D23\u4EBA")},model:{value:t.transferData.owner_userid,callback:function(a){t.$set(t.transferData,"owner_userid",a)},expression:"transferData.owner_userid"}})],1)],1),e("div",{staticClass:"adaption",attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(a){t.transferShow=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{type:"primary",loading:t.transferLoad>0},on:{click:t.onTransfer}},[t._v(t._s(t.$L("\u79FB\u4EA4")))])],1)],1),e("DrawerOverlay",{attrs:{placement:"right",beforeClose:t.workflowBeforeClose,size:1280},model:{value:t.workflowShow,callback:function(a){t.workflowShow=a},expression:"workflowShow"}},[t.workflowShow?e("ProjectWorkflow",{ref:"workflow",attrs:{"project-id":t.projectId}}):t._e()],1),e("DrawerOverlay",{attrs:{placement:"right",size:720},model:{value:t.logShow,callback:function(a){t.logShow=a},expression:"logShow"}},[t.logShow?e("ProjectLog",{attrs:{"project-id":t.projectId}}):t._e()],1),e("DrawerOverlay",{attrs:{placement:"right",size:1e3},model:{value:t.archivedTaskShow,callback:function(a){t.archivedTaskShow=a},expression:"archivedTaskShow"}},[t.archivedTaskShow?e("TaskArchived",{attrs:{"project-id":t.projectId}}):t._e()],1),e("DrawerOverlay",{attrs:{placement:"right",size:1e3},model:{value:t.deletedTaskShow,callback:function(a){t.deletedTaskShow=a},expression:"deletedTaskShow"}},[t.deletedTaskShow?e("TaskDeleted",{attrs:{"project-id":t.projectId}}):t._e()],1)],1)},Nt=[];const Ot={name:"ProjectPanel",components:{UserAvatarTip:R,UserSelect:F,MarkdownPreviewNostyle:Ft,TaskMenu:M,ProjectWorkflow:ht,DrawerOverlay:z,ProjectLog:O,TaskArchived:rt,TaskRow:tt,Draggable:P,TaskAddSimple:W,TaskPriority:E,TaskDeleted:$t,ProjectGantt:xt},data(){return{loading:!1,nowTime:$A.Time(),nowInterval:null,columnLoad:{},columnTopShow:{},sortField:"end_at",sortType:"desc",searchText:"",addColumnShow:!1,addColumnName:"",sortData:[],sortDisabled:!1,settingShow:!1,settingData:{},settingLoad:0,userShow:!1,userData:{},userLoad:0,inviteShow:!1,inviteData:{},inviteLoad:0,transferShow:!1,transferData:{},transferLoad:0,workflowShow:!1,logShow:!1,archivedTaskShow:!1,deletedTaskShow:!1,flowInfo:{},flowList:[]}},mounted(){this.nowInterval=setInterval(()=>{this.nowTime=$A.Time()},1e3)},destroyed(){clearInterval(this.nowInterval)},computed:{...p(["cacheDialogs","projectId","projectLoad","cacheTasks","cacheColumns","taskCompleteTemps","cacheUserBasic"]),...w(["projectData","transforTasks"]),tabTypeActive(){return this.projectData.cacheParameter.menuType},tabTypeStyle(){const t={};switch(this.tabTypeActive){case"column":t.left="0";break;case"table":t.left="33.33%";break;case"gantt":t.left="66.66%";break;default:t.display="none"}return t},userWaitRemove(){const{userids:t,useridbak:s}=this.userData;if(!t)return[];let e=[];return s.some(a=>{t.includes(a)||e.push(a)}),e},msgUnread(){const{cacheDialogs:t,projectData:s}=this,e=t.find(({id:a})=>a===s.dialog_id);return $A.getDialogNum(e)},panelTask(){const{searchText:t,flowInfo:s}=this;return function(e){return this.projectData.cacheParameter.completedTask||(e=e.filter(({complete_at:a})=>!a)),$A.leftExists(s.value,"user:")?e=e.filter(({task_user:a})=>a.find(({userid:o,owner:i})=>o===s.userid&&i)):s.value>0?e=e.filter(({flow_item_id:a})=>a===s.value):s.value==-1&&(e=e.filter(({start_at:a})=>!a)),t&&(e=e.filter(({id:a,name:o,desc:i})=>a==t||$A.strExists(`${o} ${i}`,t))),e}},projectUser(){const{projectData:t,windowWidth:s}=this;if(!t.project_user)return[];let e=s>1200?8:3,a=t.project_user.filter(({userid:i})=>i!=t.owner_userid);if(a.length<=e)return a;let o=a.slice(0,e-1);return o.push({userid:-1}),o.push(a[a.length-1]),o},allTask(){const{cacheTasks:t,projectId:s}=this;return t.filter(e=>e.archived_at||!e.created_at?!1:e.project_id==s)},columnList(){const{projectId:t,cacheColumns:s,allTask:e}=this,a=s.filter(({project_id:o})=>o==t).sort((o,i)=>o.sort!=i.sort?o.sort-i.sort:o.id-i.id);return a.forEach(o=>{o.tasks=this.transforTasks(e.filter(i=>i.column_id==o.id)).sort((i,r)=>i.complete_at||r.complete_at?$A.Date(i.complete_at)-$A.Date(r.complete_at):i.sort!=r.sort?i.sort-r.sort:i.id-r.id)}),a},myList(){const{allTask:t,taskCompleteTemps:s,sortField:e,sortType:a}=this;let o=t.filter(i=>this.myFilter(i));if(s.length>0){let i=t.filter(r=>s.includes(r.id)&&this.myFilter(r,!1));i.length>0&&(o=$A.cloneJSON(o),o.push(...i))}return o.sort((i,r)=>{if(a=="asc"&&([i,r]=[r,i]),e=="level")return i.p_level-r.p_level;if(e=="end_at")return i.end_at==r.end_at?i.p_level-r.p_level:$A.Date(i.end_at||"2099-12-31 23:59:59")-$A.Date(r.end_at||"2099-12-31 23:59:59")})},helpList(){const{allTask:t,taskCompleteTemps:s,sortField:e,sortType:a}=this;let o=t.filter(i=>this.helpFilter(i));if(s.length>0){let i=t.filter(r=>s.includes(r.id)&&this.helpFilter(r,!1));i.length>0&&(o=$A.cloneJSON(o),o.push(...i))}return o.sort((i,r)=>{if(a=="asc"&&([i,r]=[r,i]),e=="level")return i.p_level-r.p_level;if(e=="end_at")return i.end_at==r.end_at?i.p_level-r.p_level:$A.Date(i.end_at||"2099-12-31 23:59:59")-$A.Date(r.end_at||"2099-12-31 23:59:59")})},unList(){const{allTask:t,searchText:s,sortField:e,sortType:a}=this;return t.filter(i=>i.parent_id>0||this.flowTask(i)||s&&i.id!=s&&!$A.strExists(i.name,s)&&!$A.strExists(i.desc,s)?!1:!i.complete_at).sort((i,r)=>{if(a=="asc"&&([i,r]=[r,i]),e=="level")return i.p_level-r.p_level;if(e=="end_at")return i.end_at==r.end_at?i.p_level-r.p_level:$A.Date(i.end_at||"2099-12-31 23:59:59")-$A.Date(r.end_at||"2099-12-31 23:59:59")})},completedList(){const{allTask:t,searchText:s}=this;return t.filter(a=>a.parent_id>0||this.flowTask(a)||s&&a.id!=s&&!$A.strExists(a.name,s)&&!$A.strExists(a.desc,s)?!1:a.complete_at).sort((a,o)=>{let i=$A.Date(a.complete_at);return $A.Date(o.complete_at)-i})},completedCount(){const{allTask:t}=this;return t.filter(s=>s.parent_id>0?!1:s.complete_at).length},flowTitle(){const{flowInfo:t,flowData:s,allTask:e}=this;if(t.value==-1)return t.label;if(t.value){const a=s.find(o=>o.value===t.value);return a?a.label:t.label}return`${this.$L("\u5168\u90E8")} (${e.length})`},flowData(){const{flowList:t,allTask:s,cacheUserBasic:e}=this,a=[{value:0,label:`${this.$L("\u5168\u90E8")} (${s.length})`,children:[]}];a.push({value:-1,label:`${this.$L("\u672A\u8BA1\u5212")} (${s.filter(({start_at:r})=>!r).length})`,children:[]});const o=t.map(r=>({value:r.id,label:r.name,status:r.status,children:r.project_flow_item.map(n=>{const l=s.filter(({flow_item_id:c})=>c==n.id).length;return{value:n.id,label:`${n.name} (${l})`,status:n.status,class:n.status}})}));o.length===1?a.push(...o[0].children):o.length>0&&a.push(...o);const{project_user:i}=this.projectData;if($A.isArray(i)){const r=i.map((n,l)=>{const c=e.find(({userid:f})=>f===n.userid)||{},u=s.filter(({task_user:f,complete_at:v})=>!this.projectData.cacheParameter.completedTask&&v?!1:f.find(({userid:h,owner:m})=>h===n.userid&&m)).length;return{value:`user:${c.userid}`,label:`${c.nickname} (${u})`,class:`user-${l}`,userid:c.userid||0,length:u}}).filter(({userid:n,length:l})=>n>0&&l>0);r.length>0&&a.push(...r)}return a}},watch:{projectData(){this.sortData=this.getSort()},projectLoad(t){this._loadTimeout&&clearTimeout(this._loadTimeout),t>0?this._loadTimeout=setTimeout(()=>{this.loading=!0},1e3):this.loading=!1},projectId:{handler(t){t>0&&this.getFlowData()},immediate:!0}},methods:{showName(){this.windowLandscape||$A.modalInfo({language:!1,title:this.$L("\u9879\u76EE\u540D\u79F0"),content:this.projectData.name})},showDesc(){this.windowLandscape||$A.modalInfo({language:!1,title:this.$L("\u9879\u76EE\u63CF\u8FF0"),content:this.$refs.descPreview.$el.innerHTML})},searchFocus(){this.$nextTick(()=>{this.$refs.searchInput.focus({cursor:"end"})})},getSort(){const t=[];return this.columnList.forEach(s=>{t.push({id:s.id,task:s.tasks.map(({id:e})=>e)})}),t},sortUpdate(t){const s=this.sortData,e=this.getSort();if(JSON.stringify(s)===JSON.stringify(e))return;this.sortData=e;const a={project_id:this.projectId,sort:this.sortData,only_column:t===!0?1:0};this.sortDisabled=!0,this.$store.dispatch("call",{url:"project/sort",data:a,method:"post"}).then(({msg:o})=>{$A.messageSuccess(o),this.sortDisabled=!1;let i,r=[];a.only_column?(i=-1,a.sort.forEach(n=>{i++,r.push({id:n.id,sort:i})}),this.$store.dispatch("saveColumn",r)):(a.sort.forEach(n=>{i=-1,r.push(...n.task.map(l=>(i++,r.push(...this.allTask.filter(c=>c.parent_id==l).map(({id:c})=>({id:c,sort:i,column_id:n.id}))),{id:l,sort:i,column_id:n.id})))}),this.$store.dispatch("saveTask",r))}).catch(({msg:o})=>{$A.modalError(o),this.sortDisabled=!1,this.$store.dispatch("getTaskForProject",this.projectId).catch(()=>{})})},addTopShow(t,s){this.$set(this.columnTopShow,t,s)},addTaskOpen(t){g.Store.set("addTask",t)},addColumnOpen(){this.addColumnShow=!0,this.$nextTick(()=>{this.$refs.addColumnName.focus()})},addColumnBlur(){this.addColumnName===""&&(this.addColumnShow=!1)},addColumnSubmit(){let t=this.addColumnName.trim();t!==""&&this.$store.dispatch("call",{url:"project/column/add",data:{project_id:this.projectId,name:t}}).then(({data:s,msg:e})=>{$A.messageSuccess(e),this.addColumnName="",this.$store.dispatch("saveColumn",s)}).catch(({msg:s})=>{$A.modalError(s)})},dropColumn(t,s){s==="title"?this.titleColumn(t):s==="remove"?this.removeColumn(t):s.name&&this.updateColumn(t,{color:s.color}).catch(e=>{$A.modalError(e)})},titleColumn(t){$A.modalInput({value:t.name,title:"\u4FEE\u6539\u5217\u8868",placeholder:"\u8F93\u5165\u5217\u8868\u540D\u79F0",onOk:s=>s?this.updateColumn(t,{name:s}):"\u5217\u8868\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A"})},updateColumn(t,s){return new Promise((e,a)=>{if(this.columnLoad[t.id]===!0){e();return}this.$set(this.columnLoad,t.id,!0),Object.keys(s).forEach(o=>this.$set(t,o,s[o])),this.$store.dispatch("call",{url:"project/column/update",data:Object.assign(s,{column_id:t.id})}).then(({data:o})=>{this.$set(this.columnLoad,t.id,!1),this.$store.dispatch("saveColumn",o),e()}).catch(({msg:o})=>{this.$set(this.columnLoad,t.id,!1),this.$store.dispatch("getColumns",this.projectId).catch(()=>{}),a(o)})})},removeColumn(t){$A.modalConfirm({title:"\u5220\u9664\u5217\u8868",content:"\u4F60\u786E\u5B9A\u8981\u5220\u9664\u5217\u8868\u3010"+t.name+"\u3011\u53CA\u5217\u8868\u5185\u7684\u4EFB\u52A1\u5417\uFF1F",loading:!0,onOk:()=>{if(this.columnLoad[t.id]!==!0)return this.$set(this.columnLoad,t.id,!0),new Promise((s,e)=>{this.$store.dispatch("removeColumn",t.id).then(({msg:a})=>{s(a)}).catch(({msg:a})=>{e(a)}).finally(a=>{this.$set(this.columnLoad,t.id,!1)})})}})},onSort(t){this.sortField=t,this.sortType=this.sortType=="desc"?"asc":"desc"},onSetting(){this.settingLoad++,this.$store.dispatch("call",{url:"project/update",data:Object.assign(this.settingData,{project_id:this.projectId})}).then(({data:t,msg:s})=>{$A.messageSuccess(s),this.settingShow=!1,this.$store.dispatch("saveProject",t)}).catch(({msg:t})=>{$A.modalError(t)}).finally(t=>{this.settingLoad--})},onUser(){this.userLoad++,this.$store.dispatch("call",{url:"project/user",data:{project_id:this.projectId,userid:this.userData.userids}}).then(({msg:t})=>{$A.messageSuccess(t),this.userShow=!1,this.$store.dispatch("getProjectOne",this.projectId).catch(()=>{}),this.$store.dispatch("getTaskForProject",this.projectId).catch(()=>{})}).catch(({msg:t})=>{$A.modalError(t)}).finally(t=>{this.userLoad--})},onTransfer(){this.transferLoad++,this.$store.dispatch("call",{url:"project/transfer",data:{project_id:this.projectId,owner_userid:this.transferData.owner_userid[0]}}).then(({msg:t})=>{$A.messageSuccess(t),this.transferShow=!1,this.$store.dispatch("getProjectOne",this.projectId).catch(()=>{}),this.$store.dispatch("getTaskForProject",this.projectId).catch(()=>{})}).catch(({msg:t})=>{$A.modalError(t)}).finally(t=>{this.transferLoad--})},onArchived(){$A.modalConfirm({title:"\u5F52\u6863\u9879\u76EE",content:"\u4F60\u786E\u5B9A\u8981\u5F52\u6863\u9879\u76EE\u3010"+this.projectData.name+"\u3011\u5417\uFF1F",loading:!0,onOk:()=>new Promise((t,s)=>{this.$store.dispatch("archivedProject",this.projectId).then(({msg:e})=>{t(e)}).catch(({msg:e})=>{s(e)})})})},onDelete(){$A.modalConfirm({title:"\u5220\u9664\u9879\u76EE",content:"\u4F60\u786E\u5B9A\u8981\u5220\u9664\u9879\u76EE\u3010"+this.projectData.name+"\u3011\u5417\uFF1F",loading:!0,onOk:()=>new Promise((t,s)=>{this.$store.dispatch("removeProject",this.projectId).then(({msg:e})=>{t(e)}).catch(({msg:e})=>{s(e)})})})},onExit(){$A.modalConfirm({title:"\u9000\u51FA\u9879\u76EE",content:"\u4F60\u786E\u5B9A\u8981\u9000\u51FA\u9879\u76EE\u3010"+this.projectData.name+"\u3011\u5417\uFF1F",loading:!0,onOk:()=>new Promise((t,s)=>{this.$store.dispatch("exitProject",this.projectId).then(({msg:e})=>{t(e)}).catch(({msg:e})=>{s(e)})})})},projectDropdown(t){switch(t){case"setting":this.$set(this.settingData,"name",this.projectData.name),this.$set(this.settingData,"desc",this.projectData.desc),this.settingShow=!0,this.$nextTick(()=>{this.$refs.projectName.focus(),setTimeout(this.$refs.projectDesc.resizeTextarea,0)});break;case"user":if(this.projectData.owner_userid!==this.userId)return;const s=this.projectData.project_user.map(({userid:e})=>e);this.$set(this.userData,"userids",s),this.$set(this.userData,"useridbak",s),this.$set(this.userData,"uncancelable",[this.projectData.owner_userid]),this.userShow=!0;break;case"invite":this.inviteData={},this.inviteShow=!0,this.inviteGet();break;case"workflow":this.workflowShow=!0;break;case"log":this.logShow=!0;break;case"archived_task":this.archivedTaskShow=!0;break;case"deleted_task":this.deletedTaskShow=!0;break;case"transfer":this.$set(this.transferData,"owner_userid",[]),this.transferShow=!0;break;case"archived":this.onArchived();break;case"delete":this.onDelete();break;case"exit":this.onExit();break}},openTask(t,s){this.$store.dispatch("openTask",t),s===!0&&setTimeout(()=>{g.Store.set("receiveTask",!0)},300)},openMenu(t,s){const e=this.$refs[`taskMenu_${s.id}`];e&&e[0].handleClick(t)},taskIsHidden(t){const{id:s,name:e,desc:a,complete_at:o}=t,{searchText:i}=this;return!!(!this.projectData.cacheParameter.completedTask&&o||this.flowTask(t)||i&&s!=i&&!$A.strExists(`${e} ${a}`,i))},ownerUser(t){return t.filter(({owner:s})=>s==1).sort((s,e)=>s.id-e.id)},inviteGet(t){this.inviteLoad++,this.$store.dispatch("call",{url:"project/invite",data:{project_id:this.projectId,refresh:t===!0?"yes":"no"}}).then(({data:s})=>{this.inviteData=s,this.inviteCopy()}).catch(({msg:s})=>{$A.modalError(s)}).finally(s=>{this.inviteLoad--})},getFlowData(){this.flowInfo={},this.$store.dispatch("call",{url:"project/flow/list",data:{project_id:this.projectId}}).then(({data:t})=>{var s;this.flowList=t,(s=this.$refs.flow)==null||s.clearSelect()}).catch(()=>{this.flowList=[]})},flowChange(t,s){this.flowInfo=s.pop()||{}},inviteCopy(){!this.inviteData.url||(this.inviteFocus(),this.$copyText(this.inviteData.url).then(t=>{$A.messageSuccess("\u590D\u5236\u6210\u529F")}).catch(t=>{$A.messageError("\u590D\u5236\u5931\u8D25")}))},inviteFocus(){this.$nextTick(t=>{this.$refs.inviteInput.focus({cursor:"all"})})},toggleCompleted(){this.toggleParameter("completedTask")},workflowBeforeClose(){return new Promise(t=>{if(!this.$refs.workflow){t();return}if(!this.$refs.workflow.existDiff()){t();return}$A.modalConfirm({content:"\u8BBE\u7F6E\u5C1A\u672A\u4FDD\u5B58\uFF0C\u662F\u5426\u653E\u5F03\u4FEE\u6539\uFF1F",cancelText:"\u53D6\u6D88",okText:"\u653E\u5F03",onOk:()=>{t()}})})},myFilter(t,s=!0){return!this.projectData.cacheParameter.completedTask&&s===!0&&t.complete_at||this.flowTask(t)||this.searchText&&t.id!=this.searchText&&!$A.strExists(t.name,this.searchText)&&!$A.strExists(t.desc,this.searchText)?!1:t.owner==1},helpFilter(t,s=!0){return t.parent_id>0||!this.projectData.cacheParameter.completedTask&&s===!0&&t.complete_at||this.flowTask(t)||this.searchText&&t.id!=this.searchText&&!$A.strExists(t.name,this.searchText)&&!$A.strExists(t.desc,this.searchText)?!1:t.task_user&&t.task_user.find(({userid:e,owner:a})=>e==this.userId&&a==0)},flowTask(t){return $A.leftExists(this.flowInfo.value,"user:")&&!t.task_user.find(({userid:s,owner:e})=>s===this.flowInfo.userid&&e)||this.flowInfo.value>0&&t.flow_item_id!==this.flowInfo.value?!0:!!(this.flowInfo.value==-1&&t.start_at)},expiresFormat(t){return $A.countDownFormat(t,this.nowTime)},tabTypeChange(t){switch(t){case"column":this.toggleParameter({project_id:this.projectId,key:"menuType",value:"column"});break;case"table":this.toggleParameter({project_id:this.projectId,key:"menuType",value:"table"});break;case"gantt":this.toggleParameter({project_id:this.projectId,key:"menuType",value:"gantt"});break}},toggleParameter(t){if(t==="completedTask")this.$store.dispatch("forgetTaskCompleteTemp",!0);else if(t==="chat"&&this.windowPortrait){this.$store.dispatch("openDialog",this.projectData.dialog_id);return}this.$store.dispatch("toggleProjectParameter",t)},onBack(){const{name:t,params:s}=this.$store.state.routeHistoryLast;t===this.$route.name&&/^\d+$/.test(s.projectId)?this.goForward({name:this.$route.name,params:{projectId:"all"}}):this.goBack()}}},I={};var zt=d(Ot,Wt,Nt,!1,Rt,null,null,null);function Rt(t){for(let s in I)this[s]=I[s]}var Ut=function(){return zt.exports}(),Bt=function(){var t=this,s=t.$createElement,e=t._self._c||s;return t.dialogShow?e("DialogWrapper",{staticClass:"project-dialog",attrs:{"dialog-id":t.projectData.dialog_id}},[e("template",{slot:"head"},[e("div",{staticClass:"dialog-user"},[e("div",{staticClass:"member-head"},[e("div",{staticClass:"member-title"},[t._v(t._s(t.$L("\u9879\u76EE\u6210\u5458"))),e("span",{on:{click:function(a){t.memberShowAll=!t.memberShowAll}}},[t._v("("+t._s(t.projectData.project_user.length)+")")])]),e("div",{staticClass:"member-close",on:{click:t.onClose}},[e("Icon",{attrs:{type:"ios-close"}})],1)]),e("ul",{class:["member-list",t.memberShowAll?"member-all":""]},t._l(t.projectData.project_user,function(a){return e("li",[e("UserAvatar",{attrs:{userid:a.userid,size:36}})],1)}),0)]),e("div",{staticClass:"nav-wrapper"},[e("div",{staticClass:"dialog-title"},[e("h2",[t._v(t._s(t.$L("\u7FA4\u804A")))])])])])],2):t._e()},Vt=[];const Ht={name:"ProjectDialog",components:{DialogWrapper:U},data(){return{loadIng:!1,memberShowAll:!1}},computed:{...w(["projectData"]),dialogShow(){return this.windowLandscape&&this.projectData.dialog_id&&this.projectData.cacheParameter.chat}},methods:{onClose(){this.$store.dispatch("toggleProjectParameter","chat")}}},x={};var Kt=d(Ht,Bt,Vt,!1,Yt,null,null,null);function Yt(t){for(let s in x)this[s]=x[s]}var Xt=function(){return Kt.exports}(),Jt=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"project-list"},[e("PageTitle",{attrs:{title:t.$L("\u9879\u76EE")}}),e("div",{staticClass:"list-search"},[e("div",{staticClass:"search-wrapper"},[e("Input",{attrs:{placeholder:t.$L(t.loadProjects?"\u66F4\u65B0\u4E2D...":"\u641C\u7D22\u9879\u76EE"),clearable:""},model:{value:t.projectKeyValue,callback:function(a){t.projectKeyValue=a},expression:"projectKeyValue"}},[e("div",{staticClass:"search-pre",attrs:{slot:"prefix"},slot:"prefix"},[t.loadProjects?e("Loading"):e("Icon",{attrs:{type:"ios-search"}})],1)])],1)]),e("ul",{on:{scroll:function(a){t.operateVisible=!1}}},[t.projectLists.length===0?[t.projectKeyLoading>0?e("li",{staticClass:"loading"},[e("Loading")],1):e("li",{staticClass:"nothing"},[t._v(" "+t._s(t.$L(t.projectKeyValue?`\u6CA1\u6709\u4EFB\u4F55\u4E0E"${t.projectKeyValue}"\u76F8\u5173\u7684\u9879\u76EE`:"\u6CA1\u6709\u4EFB\u4F55\u9879\u76EE"))+" ")])]:t._e(),t._l(t.projectLists,function(a,o){return e("li",{directives:[{name:"longpress",rawName:"v-longpress",value:t.handleLongpress,expression:"handleLongpress"}],key:o,class:{operate:a.id==t.operateItem.id&&t.operateVisible},attrs:{"data-id":a.id},on:{click:function(i){return t.toggleRoute("project",{projectId:a.id})}}},[e("div",{staticClass:"project-item"},[e("div",{staticClass:"item-left"},[e("div",{staticClass:"project-h1"},[e("div",{staticClass:"project-name"},[t._v(t._s(a.name))]),a.top_at?e("div",{staticClass:"icon-top"}):t._e(),a.task_my_num-a.task_my_complete>0?e("div",{staticClass:"num"},[t._v(t._s(a.task_my_num-a.task_my_complete))]):t._e()]),e("div",{staticClass:"project-h2"},[t._v(" "+t._s(a.desc)+" ")])]),a.task_num>0?e("div",{staticClass:"item-right",on:{click:function(i){return i.stopPropagation(),t.modalPercent(a)}}},[e("iCircle",{attrs:{type:"circle","trail-color":"rgba(132, 197, 106, 0.2)","trail-width":7,"stroke-color":a.task_percent===100?"rgba(132, 197, 106, 0)":"#84C56A","stroke-width":7,percent:a.task_percent,size:44}},[a.task_percent===100?e("Icon",{attrs:{type:"ios-checkmark"}}):e("span",{staticClass:"percent-text"},[t._v(t._s(a.task_percent)+"%")])],1)],1):t._e()])])})],2),e("div",{directives:[{name:"show",rawName:"v-show",value:t.operateVisible,expression:"operateVisible"}],staticClass:"operate-position",style:t.operateStyles},[e("Dropdown",{attrs:{trigger:"custom",placement:t.windowLandscape?"bottom":"top",visible:t.operateVisible,transfer:""},on:{"on-clickoutside":function(a){t.operateVisible=!1}}},[e("div",{style:{userSelect:t.operateVisible?"none":"auto",height:t.operateStyles.height}}),e("DropdownMenu",{attrs:{slot:"list"},slot:"list"},[e("DropdownItem",{nativeOn:{click:function(a){return t.handleTopClick.apply(null,arguments)}}},[t._v(" "+t._s(t.$L(t.operateItem.top_at?"\u53D6\u6D88\u7F6E\u9876":"\u7F6E\u9876\u8BE5\u9879\u76EE"))+" ")])],1)],1)],1)],1)},Gt=[];const qt={name:"ProjectList",directives:{longpress:B},data(){return{projectKeyValue:"",projectKeyLoading:0,operateStyles:{},operateVisible:!1,operateItem:{}}},computed:{...p(["cacheProjects","loadProjects"]),projectLists(){const{projectKeyValue:t,cacheProjects:s}=this,e=$A.cloneJSON(s).sort((a,o)=>a.top_at||o.top_at?$A.Date(o.top_at)-$A.Date(a.top_at):o.id-a.id);return t?e.filter(a=>$A.strExists(`${a.name} ${a.desc}`,t)):e}},watch:{projectKeyValue(t){t!=""&&(this.projectKeyLoading++,setTimeout(()=>{this.projectKeyValue==t&&this.searchProject(),this.projectKeyLoading--},600))}},methods:{searchProject(){this.projectKeyLoading++,this.$store.dispatch("getProjects",{keys:{name:this.projectKeyValue},hideload:!0}).finally(t=>{this.projectKeyLoading--})},toggleRoute(t,s){this.operateVisible||this.goForward({name:"manage-"+t,params:s||{}})},modalPercent(t){if(this.operateVisible)return;let s=`<p><strong>${this.$L("\u603B\u8FDB\u5EA6")}</strong></p>`;s+=`<p>${this.$L("\u603B\u6570\u91CF")}: ${t.task_num}</p>`,s+=`<p>${this.$L("\u5DF2\u5B8C\u6210")}: ${t.task_complete}</p>`,s+=`<p style="margin-top:12px"><strong>${this.$L("\u6211\u7684\u4EFB\u52A1")}</strong></p>`,s+=`<p>${this.$L("\u603B\u6570\u91CF")}: ${t.task_my_num}</p>`,s+=`<p>${this.$L("\u5DF2\u5B8C\u6210")}: ${t.task_my_complete}</p>`,$A.modalInfo({language:!1,title:`${t.name} ${this.$L("\u9879\u76EE\u8FDB\u5EA6")}`,content:s})},handleLongpress(t,s){const e=$A.getAttr(s,"data-id"),a=this.projectLists.find(o=>o.id==e);!a||(this.operateVisible=!1,this.operateItem=$A.isJson(a)?a:{},this.$nextTick(()=>{const o=s.getBoundingClientRect(),i=this.$el.getBoundingClientRect();this.operateStyles={left:`${t.clientX-i.left}px`,top:`${o.top+this.windowScrollY}px`,height:o.height+"px"},this.operateVisible=!0}))},handleTopClick(){this.$store.dispatch("call",{url:"project/top",data:{project_id:this.operateItem.id}}).then(({data:t})=>{this.$store.dispatch("saveProject",t)}).catch(({msg:t})=>{$A.modalError(t)})}}},S={};var Qt=d(qt,Jt,Gt,!1,Zt,null,null,null);function Zt(t){for(let s in S)this[s]=S[s]}var te=function(){return Qt.exports}(),ee=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"page-project"},[t.projectId>0?[e("ProjectPanel"),e("ProjectDialog")]:t._e(),t.windowPortrait?e("ProjectList",{directives:[{name:"show",rawName:"v-show",value:t.projectId===0,expression:"projectId === 0"}]}):t._e()],2)},se=[];const ae={components:{ProjectList:te,ProjectDialog:Xt,ProjectPanel:Ut},deactivated(){this.$store.dispatch("forgetTaskCompleteTemp",!0)},computed:{...p(["cacheProjects","wsOpenNum"]),projectId(){const{projectId:t}=this.$route.params;return parseInt(/^\d+$/.test(t)?t:0)}},watch:{projectId:{handler(){this.getProjectData()},immediate:!0},wsOpenNum(t){t<=1||(this.wsOpenTimeout&&clearTimeout(this.wsOpenTimeout),this.wsOpenTimeout=setTimeout(()=>{this.$route.name=="manage-project"&&this.getProjectData()},5e3))}},methods:{getProjectData(){if(this.projectId<=0)return;const t=this.projectId;this.$nextTick(()=>{this.$store.state.projectId=t,this.$store.dispatch("getProjectOne",t).then(()=>{this.$store.dispatch("getColumns",t).catch(()=>{}),this.$store.dispatch("getTaskForProject",t).catch(()=>{})}).catch(({msg:s})=>{t===this.projectId&&$A.modalWarning({content:s,onOk:()=>{const e=this.cacheProjects.find(({id:a})=>a);e?$A.goForward({name:"manage-project",params:{projectId:e.id}}):$A.goForward({name:"manage-dashboard"})}})}),this.$store.dispatch("forgetTaskCompleteTemp",!0)})}}},A={};var oe=d(ae,ee,se,!1,ie,null,null,null);function ie(t){for(let s in A)this[s]=A[s]}var _e=function(){return oe.exports}();export{_e as default};
