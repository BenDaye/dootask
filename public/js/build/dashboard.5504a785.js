import{m as u,b as m,j as f,a as g,n as _}from"./app.a7bdb4e9.js";import{T as p}from"./TaskMenu.702b37d3.js";import{C as v}from"./Calendar.3464870c.js";var $=function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("div",{staticClass:"home-calendar"},[t("div",{staticClass:"calendar-header"},[t("div",{staticClass:"calendar-header-menu"},[t("h4",[e._v(e._s(e.$L("(*).(*)",e.year,e.month)))])]),t("ButtonGroup",{attrs:{size:"small"}},[t("Button",[t("Icon",{staticClass:"month-less",attrs:{type:"ios-arrow-back"},on:{click:e.prevMonth}})],1),t("Button",[t("Icon",{staticClass:"month-add",attrs:{type:"ios-arrow-forward"},on:{click:e.nextMonth}})],1)],1),t("Button",{staticClass:"calendar-header-back",attrs:{size:"small"},on:{click:e.nowMonth}},[e._v(e._s(e.$L("\u4ECA\u5929")))])],1),t("div",{staticClass:"calendar-content"},[t("transition",{attrs:{name:"slide-up"}},[t("table",{staticClass:"calendar-table"},[t("thead",[t("tr",[t("th",[e._v(e._s(e.$L("\u65E5")))]),t("th",[e._v(e._s(e.$L("\u4E00")))]),t("th",[e._v(e._s(e.$L("\u4E8C")))]),t("th",[e._v(e._s(e.$L("\u4E09")))]),t("th",[e._v(e._s(e.$L("\u56DB")))]),t("th",[e._v(e._s(e.$L("\u4E94")))]),t("th",[e._v(e._s(e.$L("\u516D")))])])]),t("tbody",e._l(e.dateArray,function(r){return t("tr",[e._l(r,function(s){return[s.month?t("td",{class:{today:s.today}},[t("ETooltip",{attrs:{"max-width":"auto",disabled:!0}},[t("div",{attrs:{slot:"content"},domProps:{innerHTML:e._s(e.getTimes(s.date))},slot:"content"}),t("div",{staticClass:"item-day",on:{click:function(n){return e.onDayClick(s)}}},[t("div",[e._v(e._s(s.day))]),s.check?t("i",{staticClass:"badge"}):e._e()])])],1):t("td",{staticClass:"disabled"},[t("div",{staticClass:"item-day",on:{click:function(n){return e.onDayClick(s)}}},[t("div",[e._v(e._s(s.day))])])])]})],2)}),0)])]),e.loadIng?t("div",{staticClass:"calendar-loading"},[t("Loading")],1):e._e(),t("div",{staticClass:"calendar-tui"},[t("Calendar",{ref:"cal",staticStyle:{height:"calc(100% - 7px)"},attrs:{view:e.calendarView,theme:e.calendarTheme,template:e.calendarTemplate,schedules:e.list,taskView:!1,useCreationPopup:!1,"disable-click":""},on:{beforeCreateSchedule:e.onBeforeCreateSchedule,beforeClickSchedule:e.onBeforeClickSchedule,beforeUpdateSchedule:e.onBeforeUpdateSchedule}})],1)],1)])},y=[];const k={name:"HomeCalendar",components:{TaskMenu:p,Calendar:v},props:{checkin:{type:Array}},data(){return{loadIng:0,year:"",month:"",startTime:"",endTime:"",dateArray:[],historys:[],showTable:!0,lists:[],rangeText:"Calendar",rangeTime:[],calendarView:"day",calendarWeek:{},calendarMonth:{},calendarTheme:{},calendarTemplate:{},calendarTask:{},calendarMenuStyles:{top:0,left:0},loadTimeout:null}},created(){const e=new Date;this.year=e.getFullYear(),this.month=e.getMonth()+1,this.generateCalendar(),this.generateCalendarInstance()},computed:{...u(["cacheTasks","taskCompleteTemps","wsOpenNum","themeIsDark"]),...m(["transforTasks"]),list(){const{cacheTasks:e,taskCompleteTemps:a}=this,t=(s,n=!0)=>s.archived_at||s.complete_at&&n===!0||!s.end_at?!1:s.owner==1;let r=e.filter(s=>t(s));if(a.length>0){let s=e.filter(n=>a.includes(n.id)&&t(n,!1));s.length>0&&(r=$A.cloneJSON(r),r.push(...s))}return this.transforTasks(r).map(s=>{const n=$A.rightExists(s.start_at,"00:00:00")&&$A.rightExists(s.end_at,"23:59:59"),i={id:s.id,calendarId:String(s.project_id),title:s.name,body:s.desc,isAllDay:n,category:n?"allday":"time",start:$A.Date(s.start_at).toISOString(),end:$A.Date(s.end_at).toISOString(),color:"#515a6e",bgColor:s.color||"#E3EAFD",borderColor:s.p_color,priority:"",preventClick:!0,preventCheckHide:!0,isChecked:!!s.complete_at,complete_at:s.complete_at,start_at:s.start_at,end_at:s.end_at,_time:s._time};if(s.p_name){let o=`background-color:${s.p_color}`;this.themeIsDark&&(o=`color:${s.p_color};border:1px solid ${s.p_color};padding:1px 3px;`),i.priority=`<span class="priority" style="${o}">${s.p_name}</span>`}return s.sub_my&&s.sub_my.length>0&&(i.title=`[+${s.sub_my.length}] ${i.title}`),s.sub_top===!0&&(i.title=`[${this.$L("\u5B50\u4EFB\u52A1")}] ${i.title}`),s.flow_item_name&&(i.title=`[${s.flow_item_name}] ${i.title}`),s.complete_at?(i.color="#c3c2c2",i.bgColor="#f3f3f3",i.borderColor="#e3e3e3"):s.overdue&&(i.title=`[${this.$L("\u8D85\u671F")}] ${i.title}`,i.color="#f56c6c",i.bgColor=s.color||"#fef0f0",i.priority+=`<span class="overdue">${this.$L("\u8D85\u671F\u672A\u5B8C\u6210")}</span>`),i.borderColor||(i.borderColor=i.bgColor),i})}},methods:{isCheck(e){let a=new Date(e).getTime();return this.list.find(t=>{if(!t.start_at||!t.end_at)return!1;let r=new Date(t.start_at.split(" ")[0].replace(/-/g,"/")).getTime(),s=new Date(t.end_at.split(" ")[0].replace(/-/g,"/")).getTime();return r<=a&&s>=a})},getTimes(e){const a=this.historys.find(t=>t.date==e);return a==null?void 0:a.section.map(t=>`${t[0]} - ${t[1]||"None"}`).join("<br/>")},generateCalendar(e){let a=new Date($A.formatDate("Y/m/d",e)),t=new Date(this.year,this.month-1,1),r=t.getTime()-t.getDay()*86400*1e3,s=[];for(let n=0;n<5;n++){s[n]=[];for(let i=0;i<7;i++){let o=new Date(r),l=o.getMonth()+1;s[n][i]={day:o.getDate(),date:`${o.getFullYear()}/${l}/${o.getDate()}`,today:a.getTime()==o.getTime(),future:a.getTime()<o.getTime(),month:l==this.month},s[n][i].check=this.isCheck(s[n][i].date),r+=86400*1e3}}this.dateArray=s,this.startTime=s[0][0].date,this.endTime=s[4][6].date},nextMonth(){this.month==12?(this.year++,this.month=1):this.month++,this.generateCalendar()},prevMonth(){this.month==1?(this.year--,this.month=12):this.month--,this.generateCalendar()},nowMonth(){this.year=parseInt($A.formatDate("Y")),this.month=parseInt($A.formatDate("m")),this.generateCalendar(),this.$refs.cal.getInstance().setDate(new Date)},onDayClick(e){const a=new Date(e.date);this.year=a.getFullYear(),this.month=a.getMonth()+1,this.generateCalendar(e.date),this.$refs.cal.getInstance().setDate(a)},generateCalendarInstance(){f([{key:"{\u65E5}",zh:"\u65E5",general:"Sun"},{key:"{\u4E00}",zh:"\u4E00",general:"Mon"},{key:"{\u4E8C}",zh:"\u4E8C",general:"Tue"},{key:"{\u4E09}",zh:"\u4E09",general:"Wed"},{key:"{\u56DB}",zh:"\u56DB",general:"Thu"},{key:"{\u4E94}",zh:"\u4E94",general:"Fri"},{key:"{\u516D}",zh:"\u516D",general:"Sat"}]);let e=[this.$L("{\u65E5}"),this.$L("{\u4E00}"),this.$L("{\u4E8C}"),this.$L("{\u4E09}"),this.$L("{\u56DB}"),this.$L("{\u4E94}"),this.$L("{\u516D}")];this.calendarWeek={daynames:e},this.calendarMonth={daynames:e},this.calendarTheme={"common.border":"1px solid rgba(0,0,0,0)","month.dayname.fontSize":"14px","month.dayname.borderLeft":"1px solid rgba(0,0,0,0)","month.dayname.height":"50px"},this.windowLandscape&&(this.calendarTheme={"common.border":"1px solid #f4f5f5","month.dayname.fontSize":"14px","month.dayname.borderLeft":"1px solid #f4f5f5","month.dayname.height":"50px"}),this.calendarTemplate={titlePlaceholder:()=>this.$L("\u4EFB\u52A1\u63CF\u8FF0"),popupSave:()=>this.$L("\u4FDD\u5B58"),popupEdit:()=>this.$L("\u8BE6\u60C5"),popupDelete:()=>this.$L("\u5220\u9664")}},onBeforeCreateSchedule({start:e,end:a,isAllDay:t,guide:r}){t||this.calendarView=="month"?(e=$A.date2string(e.toDate(),"Y-m-d 00:00:00"),a=$A.date2string(a.toDate(),"Y-m-d 23:59:59")):(e=$A.date2string(e.toDate(),"Y-m-d H:i:s"),a=$A.date2string(a.toDate(),"Y-m-d H:i:s")),g.Store.set("addTask",{times:[e,a],owner:[this.userId],beforeClose:()=>r.clearGuideElement()})},onBeforeClickSchedule(e){const{type:a,schedule:t}=e;let r=this.cacheTasks.find(({id:s})=>s===t.id);if(!!r)switch(a){case"check":this.calendarMenuStyles={left:`${this.getElementLeft(e.target)}px`,top:`${this.getElementTop(e.target)-8}px`},this.calendarTask=r,this.$nextTick(this.$refs.calendarTaskMenu.show);break;case"edit":this.$store.dispatch("openTask",r);break;case"delete":$A.modalConfirm({title:"\u5220\u9664\u4EFB\u52A1",content:"\u4F60\u786E\u5B9A\u8981\u5220\u9664\u4EFB\u52A1\u3010"+r.name+"\u3011\u5417\uFF1F",loading:!0,onOk:()=>new Promise((s,n)=>{this.$store.dispatch("removeTask",{task_id:r.id}).then(({msg:i})=>{s(i)}).catch(({msg:i})=>{n(i),this.setRenderRange()})})});break}},onBeforeUpdateSchedule(e){var s,n,i,o;const{changes:a,schedule:t}=e;let r=this.cacheTasks.find(({id:l})=>l===t.id);!r||((s=a==null?void 0:a.start)==null?void 0:s.getTime())==((n=t==null?void 0:t.start)==null?void 0:n.getTime())&&((i=a==null?void 0:a.end)==null?void 0:i.getTime())==((o=t==null?void 0:t.end)==null?void 0:o.getTime())||((a==null?void 0:a.start)||(a==null?void 0:a.end))&&(this.$refs.cal.getInstance().updateSchedule(t.id,t.calendarId,a),this.$store.dispatch("taskUpdate",{task_id:r.id,times:[(a.start||t.start).toDate(),(a.end||t.end).toDate()]}).then(({msg:c})=>{$A.messageSuccess(c)}).catch(({msg:c})=>{$A.modalError(c),this.setRenderRange()}))},getElementLeft(e){let a=e.offsetLeft,t=e.offsetParent;for(;t!==null&&t!=this.$el;)a+=t.offsetLeft+t.clientLeft,t=t.offsetParent;return a},getElementTop(e){let a=e.offsetTop,t=e.offsetParent;for(;t!==null&&t!=this.$el;)a+=t.offsetTop+t.clientTop,t=t.offsetParent;return a}}},d={};var T=_(k,$,y,!1,C,null,null,null);function C(e){for(let a in d)this[a]=d[a]}var b=function(){return T.exports}(),w=function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("div",{staticClass:"page-dashboard"},[t("PageTitle",{attrs:{title:e.$L("\u4EEA\u8868\u76D8")}}),e.warningMsg?t("Alert",{staticClass:"dashboard-warning",attrs:{type:"warning","show-icon":""}},[t("span",{on:{click:function(r){return e.goForward({name:"manage-setting-license"})}}},[e._v(e._s(e.warningMsg))])]):e._e(),t("div",{staticClass:"dashboard-wrapper"},[t("div",{staticClass:"dashboard-hello"},[t("span",{staticClass:"tite"},[e._v(e._s(e.$L("\u6B22\u8FCE\u60A8\uFF0C"+e.userInfo.nickname)))]),t("div",{staticClass:"dashboard-search"},[t("Poptip",{class:[e.searchKey?"has-value":"",e.selectedId?"selected":""],attrs:{disabled:"",placement:"bottom",width:"250"},scopedSlots:e._u([{key:"content",fn:function(){return[t("ul",[e._l(e.searchProjectList,function(r){return t("li",{on:{click:function(s){return e.onSearch(r)}}},[e._v(e._s(r.name))])}),e.searchProjectList.length==0?t("li",{staticClass:"empty"},[e._v(e._s(e.$L("\u65E0\u76F8\u5173\u6570\u636E")))]):e._e()],2)]},proxy:!0}]),model:{value:e.showPoptip,callback:function(r){e.showPoptip=r},expression:"showPoptip"}},[t("div",{on:{click:e.onSearchFocus,mouseenter:e.onSearchFocus}},[t("Input",{ref:"searchInput",attrs:{size:"large",suffix:"ios-search",placeholder:e.$L("\u641C\u7D22\u9879\u76EE\u540D\u79F0"),clearable:""},on:{"on-change":e.onSearchChange},model:{value:e.searchKey,callback:function(r){e.searchKey=r},expression:"searchKey"}})],1)])],1)]),t("div",{staticClass:"dashboard-desc"},[e._v(" "+e._s(e.$L("\u4EE5\u4E0B\u662F\u4F60\u5F53\u524D\u7684\u4EFB\u52A1\u7EDF\u8BA1\u6570\u636E"))+" "),t("transition",{attrs:{name:"dashboard-load"}},[e.loadDashboardTasks?t("div",{staticClass:"dashboard-load"},[t("Loading")],1):e._e()])],1),t("ul",{staticClass:"dashboard-block"},[t("li",{on:{click:function(r){return e.scrollTo("today")}}},[t("div",{staticClass:"block-title"},[e._v(e._s(e.getTitle("today")))]),t("div",{staticClass:"block-data"},[t("div",{staticClass:"block-num"},[e._v(e._s(e.dashboardTask.today_count))]),t("i",{staticClass:"taskfont"},[e._v("\uE6F4")])])]),t("li",{on:{click:function(r){return e.scrollTo("overdue")}}},[t("div",{staticClass:"block-title"},[e._v(e._s(e.getTitle("overdue")))]),t("div",{staticClass:"block-data"},[t("div",{staticClass:"block-num"},[e._v(e._s(e.dashboardTask.overdue_count))]),t("i",{staticClass:"taskfont"},[e._v("\uE603")])])]),t("li",{on:{click:function(r){return e.scrollTo("all")}}},[t("div",{staticClass:"block-title"},[e._v(e._s(e.getTitle("all")))]),t("div",{staticClass:"block-data"},[t("div",{staticClass:"block-num"},[e._v(e._s(e.dashboardTask.all_count))]),t("i",{staticClass:"taskfont"},[e._v("\uE6F9")])])])]),t("Scrollbar",{staticClass:"dashboard-list"},[e._l(e.columns,function(r){return r.list.length>0?[t("div",{ref:`type_${r.type}`,refInFor:!0,staticClass:"dashboard-ref"}),t("div",{staticClass:"dashboard-title"},[e._v(e._s(r.title))]),t("ul",{staticClass:"dashboard-ul"},e._l(r.list,function(s,n){return t("li",{key:n,class:{complete:s.complete_at},style:s.color?{backgroundColor:s.color}:{},on:{click:function(i){return e.openTask(s)}}},[s.p_name?t("em",{staticClass:"priority-color",style:{backgroundColor:s.p_color}}):e._e(),t("div",{staticClass:"item-select",on:{click:function(i){return i.stopPropagation(),e.openMenu(i,s)}}},[t("i",{staticClass:"taskfont",domProps:{innerHTML:e._s(s.complete_at?"&#xe627;":"&#xe625;")}})]),t("div",{staticClass:"item-title"},[s.flow_item_name?t("span",{class:s.flow_item_status,on:{click:function(i){return i.stopPropagation(),e.openMenu(i,s)}}},[e._v(e._s(s.flow_item_name))]):e._e(),s.sub_top===!0?t("span",[e._v(e._s(e.$L("\u5B50\u4EFB\u52A1")))]):e._e(),s.sub_my&&s.sub_my.length>0?t("span",[e._v("+"+e._s(s.sub_my.length))]):e._e(),e._v(" "+e._s(s.name)+" ")]),s.desc?t("div",{staticClass:"item-icon"},[t("i",{staticClass:"taskfont"},[e._v("\uE71A")])]):e._e(),s.sub_num>0?t("div",{staticClass:"item-icon"},[t("i",{staticClass:"taskfont"},[e._v("\uE71F")]),t("em",[e._v(e._s(s.sub_complete)+"/"+e._s(s.sub_num))])]):e._e(),s.end_at?t("ETooltip",{attrs:{disabled:e.$isEEUiApp||e.windowTouch,content:s.end_at,placement:"right"}},[t("div",{class:["item-icon",s.today?"today":"",s.overdue?"overdue":""]},[t("i",{staticClass:"taskfont"},[e._v("\uE71D")]),t("em",[e._v(e._s(e.expiresFormat(s.end_at)))])])]):e._e()],1)}),0)]:e._e()}),e.columns.length<=0?[t("div",{staticClass:"nopage"},[t("div",{staticClass:"nopage-icon"},[t("img",{attrs:{src:e.$A.apiUrl("../images/empty/complete.svg")}})]),t("div",{staticClass:"nopage-text"},[e._v(" "+e._s(e.$L("\u54C7\uFF01\u4F60\u771F\u68D2\uFF01\u6240\u6709\u4EFB\u52A1\u90FD\u51FA\u8272\u5B8C\u6210\u4E86\uFF01"))+" ")])])]:e._e()],2)],1),e.windowPortrait?e._e():t("div",{staticClass:"dashboard-calendar"},[t("HomeCalendar")],1)],1)},L=[];const I={components:{TaskMenu:p,HomeCalendar:b},data(){return{nowTime:$A.Time(),nowInter:null,licenseTimer:null,loadIng:0,dashboard:"today",warningMsg:"",searchKey:"",searchTimeout:null,showPoptip:!1,searchKeyLoading:0,selectedId:0,selectedKey:""}},activated(){this.$store.dispatch("getTaskForDashboard",600),this.loadInterval(!0),this.loadLicense(!0)},deactivated(){this.$store.dispatch("forgetTaskCompleteTemp",!0),this.loadInterval(!1),this.loadLicense(!1)},computed:{...u(["userInfo","userIsAdmin","cacheTasks","taskCompleteTemps","loadDashboardTasks","cacheProjects","loadProjects"]),...m(["dashboardTask","assistTask","transforTasks"]),columns(){const e=[];return["today","overdue","all"].some(a=>{let t=this.transforTasks(this.dashboardTask[a]);this.selectedId&&(t=t.filter(r=>r.project_id==this.selectedId)),e.push({type:a,title:this.getTitle(a),list:t.sort((r,s)=>$A.Date(r.end_at||"2099-12-31 23:59:59")-$A.Date(s.end_at||"2099-12-31 23:59:59"))})}),e.push({type:"assist",title:this.getTitle("assist"),list:this.assistTask.filter(a=>a.project_id==this.selectedId||!this.selectedId).sort((a,t)=>$A.Date(a.end_at||"2099-12-31 23:59:59")-$A.Date(t.end_at||"2099-12-31 23:59:59"))}),e},total(){const{dashboardTask:e}=this;return e.today_count+e.overdue_count+e.all_count},searchProjectList(){if(!this.searchKey)return[];const{searchKey:e,cacheProjects:a}=this;return $A.cloneJSON(a).sort((r,s)=>r.top_at||s.top_at?$A.Date(s.top_at)-$A.Date(r.top_at):s.id-r.id).filter(r=>$A.strExists(`${r.name}`,e))}},watch:{windowActive(e){this.loadInterval(e),this.loadLicense(e)},searchKey(e){this.showPoptip=!!e,e!=this.selectedKey&&(this.selectedKey="",this.selectedId=0),e&&setTimeout(()=>{this.searchKey==e&&this.searchProject()},600)}},methods:{getTitle(e){switch(e){case"today":return this.$L("\u4ECA\u65E5\u5230\u671F");case"overdue":return this.$L("\u8D85\u671F\u4EFB\u52A1");case"all":return this.$L("\u5F85\u5B8C\u6210\u4EFB\u52A1");case"assist":return this.$L("\u534F\u52A9\u7684\u4EFB\u52A1");default:return""}},scrollTo(e){let a=this.$refs[`type_${e}`];a&&$A.scrollToView(a[0],{behavior:"smooth",inline:"end"})},openTask(e){this.$store.dispatch("openTask",e)},openMenu(e,a){this.$store.state.taskOperation={event:e,task:a}},expiresFormat(e){return $A.countDownFormat(e,this.nowTime)},loadInterval(e){this.nowInter&&(clearInterval(this.nowInter),this.nowInter=null),e!==!1&&(this.nowInter=setInterval(a=>{this.nowTime=$A.Time()},1e3))},loadLicense(e){this.licenseTimer&&(clearTimeout(this.licenseTimer),this.licenseTimer=null),!(e===!1||!this.userIsAdmin)&&(this.licenseTimer=setTimeout(a=>{this.$store.dispatch("call",{url:"system/license",data:{type:"get"}}).then(({data:t})=>{this.warningMsg=t.error.length>0?t.error[0]:""}).catch(t=>{this.warningMsg=""})},1500))},searchProject(){setTimeout(()=>{this.searchKeyLoading++},1e3),this.$store.dispatch("getProjects",{keys:{name:this.searchKey}}).finally(e=>{this.searchKeyLoading--})},onSearch(e){this.searchKey=e.name,this.selectedKey=e.name,this.selectedId=e.id,this.$nextTick(()=>{this.showPoptip=!1})},onSearchFocus(){this.$nextTick(()=>{this.$refs.searchInput.focus({cursor:"end"})})},onSearchChange(){this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchKey.trim()!=""&&(this.searchTimeout=setTimeout(()=>{this.loadIng++,this.$store.dispatch("searchFiles",this.searchKey.trim()).then(()=>{this.loadIng--}).catch(()=>{this.loadIng--})},600))}}},h={};var D=_(I,w,L,!1,S,null,null,null);function S(e){for(let a in h)this[a]=h[a]}var P=function(){return D.exports}();export{P as default};
