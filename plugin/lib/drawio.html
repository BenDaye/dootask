<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style>
        html, body, .component-only-office {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .preview-iframe {
            background: 0 0;
            float: left;
            max-width: none;
            border: none;
            width: 100%;
            height: 100%;
        }
        .edit-header{
            display: flex;
            flex-direction: row;
            align-items: center;
            width: 100%;
            height: 42px;
            background-color: #ffffff;
            box-shadow: 0 1px 5px 0 rgba(0, 0, 0, 0.05);
            position: relative;
            z-index: 99;
        }
        .header-title {
            flex: 1;
            color: #303133;
            padding-left: 24px;
            padding-right: 24px;
            line-height: 24px;
            font-size: 16px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .header-user{
            margin-right: 24px;
        }

        /* .edit-header {
            display: flex;
            flex-direction: row;
            align-items: center;
            width: 100%;
            height: 42px;
            background-color: #ffffff;
            box-shadow: 0 1px 5px 0 rgba(0, 0, 0, 0.05);
            position: relative;
            z-index: 99;
            .header-title {
                flex: 1;
                color: $primary-title-color;
                padding-left: 24px;
                padding-right: 24px;
                line-height: 24px;
                font-size: 16px;
                overflow: hidden;
                text-overflow:ellipsis;
                white-space: nowrap;
                .file-unsave-tip {
                    color: $primary-title-color;
                    padding-right: 6px;
                    font-weight: 500;
                    cursor: pointer;
                    transition: color 0.3s;
                    &:hover {
                        color: #000000;
                    }
                }
            }
            .header-user {
                margin-right: 24px;
                > ul {
                    display: flex;
                    align-items: center;
                    > li {
                        list-style: none;
                        margin-right: -4px;
                        &.more {
                            width: 28px;
                            height: 28px;
                            text-align: center;
                            line-height: 24px;
                            font-size: 12px;
                            border: 2px solid #ffffff;
                            background-color: $primary-color;
                            color: #ffffff;
                            z-index: 1;
                            border-radius: 50%;
                        }
                    }
                }
            }
            .header-hint {
                padding-right: 22px;
                font-size: 12px;
                color: #666;
                white-space: nowrap;
                .ivu-btn {
                    font-size: 12px;
                    padding: 0 10px;
                }
                .ivu-dropdown-item {
                    font-size: 12px !important;
                }
            }
            .header-icons {
                margin-left: -4px;
                margin-right: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                .header-icon {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    width: 44px;
                    height: 100%;
                    color: #777777;
                    cursor: pointer;
                    > i {
                        font-size: 20px;
                    }
                }
            }

            .header-button {
                font-size: 12px;
                margin-right: 24px;
            }
        } */
    </style>
    <script src="/office/web-apps/apps/api/documents/api.js"></script>
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
</head>
<body>
    <div class="component-only-office">
        

        <div v-else class="edit-header">
            <div class="header-title">
                <!-- <EPopover v-if="!equalContent" v-model="unsaveTip" class="file-unsave-tip">
                    <div class="task-detail-delete-file-popover">
                        <p>{{$L('未保存当前修改内容？')}}</p>
                        <div class="buttons">
                            <Button size="small" type="text" @click="unSaveGive">{{$L('放弃')}}</Button>
                            <Button size="small" type="primary" @click="onSaveSave">{{$L('保存')}}</Button>
                        </div>
                    </div>
                    <span slot="reference">[{{$L('未保存')}}*]</span>
                </EPopover> -->
                {{fileName}}1
            </div>
            <div class="header-user">
                <ul>
                    <li v-for="(userid, index) in editUser" :key="index" v-if="index <= 10">
                        <UserAvatar :userid="userid" :size="28" :border-witdh="2"/>
                    </li>
                    <li v-if="editUser.length > 10" class="more" :title="editUser.length">{{editUser.length > 999 ? '...' : editUser.length}}</li>
                </ul>
            </div>
            <div v-if="file.type=='document' && contentDetail" class="header-hint">
                <ButtonGroup size="small" shape="circle">
                    <Button :type="`${contentDetail.type=='md'?'primary':'default'}`" @click="setTextType('md')">{{$L('MD编辑器')}}</Button>
                    <Button :type="`${contentDetail.type!='md'?'primary':'default'}`" @click="setTextType('text')">{{$L('文本编辑器')}}</Button>
                </ButtonGroup>
            </div>
            <div v-if="file.type=='mind'" class="header-hint">
                {{$L('选中节点，按enter键添加同级节点，tab键添加子节点')}}
            </div>
            <Dropdown v-if="file.type=='mind'"
                      trigger="click"
                      class="header-hint"
                      @on-click="exportMenu"
                      transfer>
                <a href="javascript:void(0)">{{$L('导出')}}<Icon type="ios-arrow-down"></Icon></a>
                <DropdownMenu slot="list">
                    <DropdownItem name="png">{{$L('导出PNG图片')}}</DropdownItem>
                    <DropdownItem name="pdf">{{$L('导出PDF文件')}}</DropdownItem>
                </DropdownMenu>
            </Dropdown>
            <template v-if="!file.only_view">
                <div class="header-icons">
                    <ETooltip :disabled="$isEEUiApp || windowTouch" :content="$L('文件链接')">
                        <div class="header-icon" @click="handleClick('link')"><i class="taskfont">&#xe785;</i></div>
                    </ETooltip>
                    <EPopover v-model="historyShow" trigger="click">
                        <div class="file-content-history">
                            <FileHistory :value="historyShow" :file="file" @on-restore="onRestoreHistory"/>
                        </div>
                        <ETooltip slot="reference" ref="historyTip" :disabled="$isEEUiApp || windowTouch || historyShow" :content="$L('历史版本')">
                            <div class="header-icon"><i class="taskfont">&#xe71d;</i></div>
                        </ETooltip>
                    </EPopover>
                </div>
                <Button :disabled="equalContent" :loading="loadSave > 0" class="header-button" size="small" type="primary" @click="handleClick('save')">{{$L('保存')}}</Button>
            </template>
        </div>

        <iframe id="iframe" class="preview-iframe" src="/drawio/webapp/index.html?offline=1&pwa=0&embed=1&noLangIcon=1&noExitBtn=1&noSaveBtn=1&saveAndExit=0&spin=1&proto=json" frameborder="0"></iframe>
    </div>

    <script>
        const getRequest = function (id) {
            var url = location.search; //获取url中"?"符后的字串
            var theRequest = new Object();
            if (url.indexOf("?") != -1) {
                var str = url.substr(1);
                var strs = str.split("&");
                for(var i = 0; i < strs.length; i ++) {
                    theRequest[strs[i].split("=")[0]] =  decodeURI(decodeURIComponent( 
                        decodeURI(decodeURIComponent(
                            escape(strs[i].split("=")[1]).replace(/\+/g, '%20')
                        ))
                    ));
                }
            }
            return id ? theRequest[id] : theRequest;
        }
    </script>

    <script>
        const request = getRequest();
        const userid = request.userid || 0;
        const nickname = request.nickname || '';
        const userToken = request.userToken || '';

        let codeId = request.codeId;
        let fileType =  request.fileType;
        let fileName = encodeURIComponent(request.fileName);
        let fileKey = request.documentKey;
        let themeIsDark = request.theme == 'false' ? false : true;
        let lang = request.lang;
        let historyId = request.historyId || 0;
        let readOnly =  request.readOnly == 'false' ? false : true;
        let iframe = document.getElementById('iframe')
        let xml = "";

        console.log(parent.$L('未保存当前修改内容？'))

        // 监听消息
        window.addEventListener('message',function(e){
            data = JSON.parse(e.data);
            
            switch (data.event) {
                case "init":
                    this.loadIng = false;
                    updateContent();
                    break;

                case "load":
                    if(!xml){
                        iframe.contentWindow.postMessage(JSON.stringify({
                            action: "template"
                        }));
                    }
                    break;

                case "autosave":
                    parent.postMessage(data,"*")
                    break;

                case "save":
                    parent.postMessage(data,"*")
                    break;
            }
        })

        // 更新内容
        const updateContent = function(){
            $.ajax(`/api/file/content/?id=${codeId}`,{
                headers:{
                    'Content-Type': 'application/json',
                    'language': lang,
                    'token': userToken,
                },
                success:function(result){
                    xml = result.data.content.xml;
                    iframe.contentWindow.postMessage(JSON.stringify({
                        action: "load",
                        autosave: 1,
                        xml:  xml
                    }));
                    parent.postMessage({source:'drawio',action:"ready",},"*")
                }
            })
           
        }
    </script>
</body>
</html>