<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style>
        html, body, .component-only-office {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        iframe{
            float: left;
        }
        .preview-iframe {
            background: 0 0;
            float: none;
            max-width: none;
            border: none;
        }
    </style>
    <script src="/office/web-apps/apps/api/documents/api.js"></script>
</head>
<body>
    <div class="component-only-office">
        <div id="docsAPI" class="placeholder"></div>
    </div>

    <script>
        const getRequest = function (id) {
            var url = location.search; //获取url中"?"符后的字串
            var theRequest = new Object();
            if (url.indexOf("?") != -1) {
                var str = url.substr(1);
                var strs = str.split("&");
                for(var i = 0; i < strs.length; i ++) {
                    theRequest[strs[i].split("=")[0]] =  decodeURI(decodeURIComponent( 
                        decodeURI(decodeURIComponent(
                            escape(strs[i].split("=")[1]).replace(/\+/g, '%20')
                        ))
                    ));
                }
            }
            return id ? theRequest[id] : theRequest;
        }
    </script>

    <script>
        const request = getRequest();
        const userid = request.userid || 0;
        const nickname = request.nickname || '';
        const userToken = request.userToken || '';

        let codeId = request.codeId;
        let fileType =  request.fileType;
        let fileName = request.fileName;
        let fileKey = request.documentKey;
        let fileUrl = `file/content/?id=${codeId}&token=${userToken}`;
        let themeIsDark = request.theme == 'false' ? false : true;
        let lang = request.lang;
        let historyId = request.historyId || 0;
        let readOnly =  request.readOnly == 'false' ? false : true;

        // 处理类型
        switch (fileType) {
            case 'word':
                fileType = 'docx';
                break;
            case 'excel':
                fileType = 'xlsx';
                break;
            case 'ppt':
                fileType = 'pptx';
                break;
        }


        // 处理语言 
        switch (lang) {
            case 'zh-CHT':
                lang = "zh-TW";
                break;
        }

        // 处理url
        if (parent.$.leftExists(codeId, "msgFile_")) {
            fileUrl = `dialog/msg/download/?msg_id=${parent.$.leftDelete(codeId, "msgFile_")}&token=${this.userToken}`;
        } else if (parent.$.leftExists(codeId, "taskFile_")) {
            fileUrl = `project/task/filedown/?file_id=${parent.$.leftDelete(codeId, "taskFile_")}&token=${this.userToken}`;
        } else if (this.historyId > 0){
            fileUrl += `&history_id=${this.historyId}`
        }

        // 处理key
        fileKey = `${fileType}-${fileKey|| codeId}`;
        if (this.historyId > 0) {
            fileKey += `-${this.historyId}`
        }

        // 配置
        const config = {
            "document": {
                "fileType": fileType,
                "title": fileName,
                "key": fileKey,
                "url": `http://nginx/api/${fileUrl}&down=preview`,
            },
            "editorConfig": {
                "mode": "edit",
                "lang": lang,
                "user": {
                    "id": String(userid),
                    "name": nickname
                },
                "customization": {
                    "uiTheme": themeIsDark ? "theme-dark" : "theme-classic-light",
                    "forcesave": true,
                    "help": false
                },
                "callbackUrl": `http://nginx/api/file/content/office?id=${codeId}&token=${userToken}`,
            },
            "events": {
                "onDocumentReady": function(res){
                    parent.postMessage({source:'onlyoffice',action:"ready"},"*")
                }
            }
        };

        // 只读
        if(readOnly || historyId > 0){
            config.editorConfig.mode = "view";
            config.editorConfig.callbackUrl = null;
            if (!config.editorConfig.user.id) {
                let officeViewer = parent.$.randNum(1000, 99999);
                config.editorConfig.user.id = "viewer_" + officeViewer;
                config.editorConfig.user.name = "Viewer_" + officeViewer
            }
        }

        // 监听消息
        window.addEventListener('message', function({data, source}){
            console.log(data)
            if (data.source === 'onlyoffice') {
                switch (data.action) {
                    case 'ready':
                        source.postMessage("createMenu", "*");
                        break;

                     default:
                        parent.postMessage(data,"*")
                        break;
                }
            }
        })


        window.docEditor = new DocsAPI.DocEditor("docsAPI", config);
    </script>
</body>
</html>