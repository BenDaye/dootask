import{n,d as u,m as h}from"./app.8aa7cdc1.js";import m from"./TEditor.89610e0f.js";import{P as p,T as f}from"./ProjectLog.dd79dd5c.js";import{U as k}from"./UserInput.638d4c17.js";import{C as g,D as v}from"./DialogWrapper.bb3fe320.js";import{T as _}from"./TaskMenu.26da6641.js";import{D}from"./index.bc9f7c3b.js";import{R as w}from"./ReportDetail.ef0e7813.js";var b=function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("Upload",{ref:"upload",attrs:{name:"files",action:"",multiple:"",format:t.uploadFormat,"show-upload-list":!1,"max-size":t.maxSize,"on-format-error":t.handleFormatError,"on-exceeded-size":t.handleMaxSize,"before-upload":t.handleBeforeUpload}})},y=[];const C={name:"TaskUpload",props:{maxSize:{type:Number,default:1024e3}},data(){return{uploadFormat:["jpg","jpeg","webp","png","gif","doc","docx","xls","xlsx","ppt","pptx","txt","esp","pdf","rar","zip","gz","ai","avi","bmp","cdr","eps","mov","mp3","mp4","pr","psd","svg","tif"]}},methods:{handleFormatError(t){$A.modalWarning({title:"\u6587\u4EF6\u683C\u5F0F\u4E0D\u6B63\u786E",content:"\u6587\u4EF6 "+t.name+" \u683C\u5F0F\u4E0D\u6B63\u786E\uFF0C\u4EC5\u652F\u6301\u53D1\u9001\uFF1A"+this.uploadFormat.join(",")})},handleMaxSize(t){$A.modalWarning({title:"\u8D85\u51FA\u6587\u4EF6\u5927\u5C0F\u9650\u5236",content:"\u6587\u4EF6 "+t.name+" \u592A\u5927\uFF0C\u4E0D\u80FD\u53D1\u9001\u8D85\u8FC7"+$A.bytesToSize(this.maxSize*1024)+"\u3002"})},handleBeforeUpload(t){return this.$emit("on-select-file",t),!1},handleClick(){this.$refs.upload.handleClick()}}},l={};var A=n(C,b,y,!1,L,null,null,null);function L(t){for(let a in l)this[a]=l[a]}var x=function(){return A.exports}(),T=function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("div",{staticClass:"relevant-daily"},[e("div",{staticClass:"table-page-box"},[e("Table",{attrs:{columns:t.columns,data:t.lists,loading:t.loadIng>0,"no-data-text":t.$L(t.noDataText),stripe:""}}),e("Page",{attrs:{total:t.listTotal,current:t.listPage,"page-size":t.listPageSize,disabled:t.loadIng>0,simple:"","page-size-opts":[10,20,30,50,100],"show-elevator":"","show-sizer":"","show-total":""},on:{"on-change":t.setPage,"on-page-size-change":t.setPageSize}})],1),e("DrawerOverlay",{attrs:{placement:"right",size:950,transfer:""},model:{value:t.showDetailDrawer,callback:function(s){t.showDetailDrawer=s},expression:"showDetailDrawer"}},[t.showDetailDrawer?e("ReportDetail",{attrs:{data:t.detailData},on:{clickTask:t.clickTask}}):t._e()],1)],1)},I=[];const S={name:"RelevantDaily",components:{DrawerOverlay:D,ReportDetail:w},props:{taskId:0},data(){return{showDetailDrawer:!1,detailData:{},loadIng:0,listTotal:0,listPage:1,listPageSize:10,noDataText:"",lists:[],columns:[{title:this.$L("\u540D\u79F0"),key:"title",width:120},{title:this.$L("\u7C7B\u578B"),key:"type",align:"center",width:90},{title:this.$L("\u6C47\u62A5\u65F6\u95F4"),key:"created_at",align:"center",width:180},{title:this.$L("\u6C47\u62A5\u5BF9\u8C61"),key:"receives",align:"center",width:90,render:(t,{row:a})=>{if(a.receives.length===0)return t("div","-");const e=[];return a.receives.length<=2?a.receives.some(s=>{e.push(t("UserAvatar",{props:{size:22,userid:s}}))}):(e.push(t("UserAvatar",{props:{size:22,userid:a.receives[0]}})),e.push(t("div",{class:"more-avatar"},`+${a.receives.length-1}`))),t("div",{class:"report-table-avatar"},e)}},{title:this.$L("\u64CD\u4F5C"),align:"center",width:100,minWidth:100,render:(t,{column:a,row:e})=>e.id?t("TableAction",{props:{column:a,menu:[{icon:"md-eye",action:"view"}]},on:{action:s=>{s==="view"&&(this.detailData=e,this.showDetailDrawer=!0)}}}):null}]}},mounted(){this.getLists()},methods:{getLists(){this.loadIng++,this.$store.dispatch("call",{url:"project/task/reports",data:{task_id:this.taskId,page:this.listPage,pagesize:this.listPageSize}}).then(({data:t})=>{this.loadIng--,this.lists=t.data,this.listTotal=t.total,this.noDataText="\u6CA1\u6709\u76F8\u5173\u7684\u6570\u636E"}).catch(()=>{this.loadIng--,this.noDataText="\u6570\u636E\u52A0\u8F7D\u5931\u8D25"})},clickTask(){this.showDetailDrawer=!1,this.$nextTick(()=>{this.getLists()})},setPage(t){this.listPage=t,this.getLists()},setPageSize(t){Math.max($A.runNum(this.listPageSize),10)!==t&&(this.listPageSize=t,this.getLists())}}},r={};var F=n(S,T,I,!1,O,"8e61aa1a",null,null);function O(t){for(let a in r)this[a]=r[a]}var z=function(){return F.exports}(),E=function(){var t=this,a=t.$createElement,e=t._self._c||a;return t.ready&&t.taskDetail.parent_id>0?e("li",[e("div",{staticClass:"subtask-icon"},[e("TaskMenu",{ref:`taskMenu_${t.taskDetail.id}`,attrs:{disabled:t.taskId===0,task:t.taskDetail,"load-status":t.taskDetail.loading===!0},on:{"on-update":t.getLogLists}})],1),t.taskDetail.flow_item_name?e("div",{staticClass:"subtask-flow"},[e("span",{class:t.taskDetail.flow_item_status,on:{click:function(s){return s.stopPropagation(),t.openMenu(s,t.taskDetail)}}},[t._v(t._s(t.taskDetail.flow_item_name))])]):t._e(),e("div",{staticClass:"subtask-name"},[e("Input",{ref:"name",attrs:{type:"textarea",rows:1,autosize:{minRows:1,maxRows:8},maxlength:255,enterkeyhint:"done"},on:{"on-blur":function(s){return t.updateBlur("name")},"on-keydown":t.onNameKeydown},model:{value:t.taskDetail.name,callback:function(s){t.$set(t.taskDetail,"name",s)},expression:"taskDetail.name"}})],1),e("DatePicker",{staticClass:"subtask-time",attrs:{open:t.timeOpen,options:t.timeOptions,format:"yyyy/MM/dd HH:mm",type:"datetimerange",placement:"bottom-end",transfer:""},on:{"on-open-change":t.timeChange,"on-clear":t.timeClear,"on-ok":t.timeOk},model:{value:t.timeValue,callback:function(s){t.timeValue=s},expression:"timeValue"}},[!t.taskDetail.complete_at&&t.taskDetail.end_at&&t.taskDetail.end_at!=t.mainEndAt?e("div",{class:["time",t.taskDetail.today?"today":"",t.taskDetail.overdue?"overdue":""],on:{click:t.openTime}},[t._v(" "+t._s(t.expiresFormat(t.taskDetail.end_at))+" ")]):e("Icon",{staticClass:"clock",attrs:{type:"ios-clock-outline"},on:{click:t.openTime}})],1),e("Poptip",{ref:"owner",staticClass:"subtask-avatar",attrs:{"popper-class":"task-detail-user-popper",title:t.$L("\u4FEE\u6539\u8D1F\u8D23\u4EBA"),width:240,placement:"bottom",transfer:""},on:{"on-popper-show":t.openOwner,"on-ok":t.onOwner}},[e("div",{attrs:{slot:"content"},slot:"content"},[e("UserInput",{attrs:{"multiple-max":10,"project-id":t.taskDetail.project_id,placeholder:t.$L("\u9009\u62E9\u4EFB\u52A1\u8D1F\u8D23\u4EBA"),transfer:!1,"max-hidden-select":""},model:{value:t.ownerData.owner_userid,callback:function(s){t.$set(t.ownerData,"owner_userid",s)},expression:"ownerData.owner_userid"}}),e("div",{staticClass:"task-detail-avatar-buttons"},[e("Button",{attrs:{size:"small",type:"primary"},on:{click:function(s){return t.$refs.owner.ok()}}},[t._v(t._s(t.$L("\u786E\u5B9A")))])],1)],1),t.getOwner.length>0?t._l(t.getOwner,function(s){return e("UserAvatar",{key:s.userid,attrs:{userid:s.userid,size:20,tooltipDisabled:""}})}):e("div",[t._v("--")])],2)],1):t.ready?e("div",{class:{"task-detail":!0,"open-dialog":t.hasOpenDialog,completed:t.taskDetail.complete_at},style:t.taskDetailStyle},[e("div",{directives:[{name:"show",rawName:"v-show",value:t.taskDetail.id>0,expression:"taskDetail.id > 0"}],staticClass:"task-info"},[e("div",{staticClass:"head"},[e("TaskMenu",{ref:`taskMenu_${t.taskDetail.id}`,staticClass:"icon",attrs:{disabled:t.taskId===0,task:t.taskDetail,size:"medium","color-show":!1},on:{"on-update":t.getLogLists}}),t.taskDetail.flow_item_name?e("div",{staticClass:"flow"},[e("span",{class:t.taskDetail.flow_item_status,on:{click:function(s){return s.stopPropagation(),t.openMenu(s,t.taskDetail)}}},[t._v(t._s(t.taskDetail.flow_item_name))])]):t._e(),t.taskDetail.archived_at?e("div",{staticClass:"flow"},[e("span",{staticClass:"archived",on:{click:function(s){return s.stopPropagation(),t.openMenu(s,t.taskDetail)}}},[t._v(t._s(t.$L("\u5DF2\u5F52\u6863")))])]):t._e(),e("div",{staticClass:"nav"},[t.projectName?e("p",[e("span",[t._v(t._s(t.projectName))])]):t._e(),t.columnName?e("p",[e("span",[t._v(t._s(t.columnName))])]):t._e(),t.taskDetail.id?e("p",[e("span",[t._v(t._s(t.taskDetail.id))])]):t._e()]),e("div",{staticClass:"function"},[t.getOwner.length===0?e("EPopover",{attrs:{placement:"bottom"},model:{value:t.receiveShow,callback:function(s){t.receiveShow=s},expression:"receiveShow"}},[e("div",{staticClass:"task-detail-receive"},[e("div",{staticClass:"receive-title"},[e("Icon",{attrs:{type:"ios-help-circle"}}),t._v(" "+t._s(t.$L("\u786E\u8BA4\u8BA1\u5212\u65F6\u95F4\u9886\u53D6\u4EFB\u52A1"))+" ")],1),e("div",{staticClass:"receive-time"},[e("DatePicker",{attrs:{options:t.timeOptions,format:"yyyy/MM/dd HH:mm",type:"datetimerange",placeholder:t.$L("\u8BF7\u8BBE\u7F6E\u8BA1\u5212\u65F6\u95F4"),clearable:!1,editable:!1},model:{value:t.timeValue,callback:function(s){t.timeValue=s},expression:"timeValue"}})],1),e("div",{staticClass:"receive-bottom"},[e("Button",{attrs:{size:"small",type:"text"},on:{click:function(s){t.receiveShow=!1}}},[t._v("\u53D6\u6D88")]),e("Button",{attrs:{loading:t.ownerLoad>0,size:"small",type:"primary"},on:{click:function(s){return t.onOwner(!0)}}},[t._v("\u786E\u5B9A")])],1)]),e("Button",{staticClass:"pick",attrs:{slot:"reference",loading:t.ownerLoad>0,type:"primary"},slot:"reference"},[t._v(t._s(t.$L("\u6211\u8981\u9886\u53D6\u4EFB\u52A1")))])],1):t._e(),t.$Electron?e("ETooltip",{attrs:{disabled:t.windowSmall||t.$isEEUiApp,content:t.$L("\u65B0\u7A97\u53E3\u6253\u5F00")}},[e("i",{staticClass:"taskfont open",on:{click:t.openNewWin}},[t._v("\uE776")])]):t._e(),e("div",{staticClass:"menu"},[e("TaskMenu",{attrs:{disabled:t.taskId===0,task:t.taskDetail,icon:"ios-more","completed-icon":"ios-more",size:"medium","color-show":!1},on:{"on-update":t.getLogLists}})],1)],1)],1),e("div",{staticClass:"scroller scrollbar-overlay"},[e("div",{staticClass:"title"},[e("Input",{ref:"name",attrs:{type:"textarea",rows:1,autosize:{minRows:1,maxRows:8},maxlength:255,enterkeyhint:"done"},on:{"on-blur":function(s){return t.updateBlur("name")},"on-keydown":t.onNameKeydown},model:{value:t.taskDetail.name,callback:function(s){t.$set(t.taskDetail,"name",s)},expression:"taskDetail.name"}})],1),e("div",{staticClass:"desc"},[e("TEditor",{ref:"desc",attrs:{value:t.taskContent,plugins:t.taskPlugins,options:t.taskOptions,"option-full":t.taskOptionFull,placeholder:t.$L("\u8BE6\u7EC6\u63CF\u8FF0..."),inline:""},on:{"on-blur":function(s){return t.updateBlur("content")}}})],1),e("Form",{staticClass:"items",attrs:{"label-position":"left","label-width":"auto"},nativeOn:{submit:function(s){s.preventDefault()}}},[t.taskDetail.p_name?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE6EC")]),t._v(t._s(t.$L("\u4F18\u5148\u7EA7"))+" ")]),e("ul",{staticClass:"item-content"},[e("li",[e("EDropdown",{ref:"priority",attrs:{trigger:"click",placement:"bottom"},on:{command:function(s){return t.updateData("priority",s)}}},[e("TaskPriority",{attrs:{backgroundColor:t.taskDetail.p_color}},[t._v(t._s(t.taskDetail.p_name))]),e("EDropdownMenu",{attrs:{slot:"dropdown"},slot:"dropdown"},t._l(t.taskPriority,function(s,i){return e("EDropdownItem",{key:i,attrs:{command:s}},[e("i",{staticClass:"taskfont",style:{color:s.color},domProps:{innerHTML:t._s(t.taskDetail.p_name==s.name?"&#xe61d;":"&#xe61c;")}}),t._v(" "+t._s(s.name)+" ")])}),1)],1)],1)])]):t._e(),t.getOwner.length>0?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE6E4")]),t._v(t._s(t.$L("\u8D1F\u8D23\u4EBA"))+" ")]),e("Poptip",{ref:"owner",staticClass:"item-content user",attrs:{title:t.$L("\u4FEE\u6539\u8D1F\u8D23\u4EBA"),width:240,"popper-class":"task-detail-user-popper",placement:"bottom",transfer:""},on:{"on-popper-show":t.openOwner,"on-ok":t.onOwner}},[e("div",{attrs:{slot:"content"},slot:"content"},[e("UserInput",{attrs:{"multiple-max":10,"project-id":t.taskDetail.project_id,placeholder:t.$L("\u9009\u62E9\u4EFB\u52A1\u8D1F\u8D23\u4EBA"),transfer:!1},model:{value:t.ownerData.owner_userid,callback:function(s){t.$set(t.ownerData,"owner_userid",s)},expression:"ownerData.owner_userid"}}),e("div",{staticClass:"task-detail-avatar-buttons"},[e("Button",{attrs:{size:"small",type:"primary"},on:{click:function(s){return t.$refs.owner.ok()}}},[t._v(t._s(t.$L("\u786E\u5B9A")))])],1)],1),e("div",{staticClass:"user-list"},t._l(t.getOwner,function(s){return e("UserAvatar",{key:s.userid,attrs:{userid:s.userid,size:28,showName:t.getOwner.length===1,tooltipDisabled:""}})}),1)])],1):t._e(),t.getAssist.length>0||t.assistForce?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE63F")]),t._v(t._s(t.$L("\u534F\u52A9\u4EBA\u5458"))+" ")]),e("Poptip",{ref:"assist",staticClass:"item-content user",attrs:{title:t.$L(t.getAssist.length>0?"\u4FEE\u6539\u534F\u52A9\u4EBA\u5458":"\u6DFB\u52A0\u534F\u52A9\u4EBA\u5458"),width:280,"popper-class":"task-detail-user-popper",placement:"bottom",transfer:""},on:{"on-popper-show":t.openAssist,"on-ok":t.onAssist}},[e("div",{attrs:{slot:"content"},slot:"content"},[e("UserInput",{attrs:{"multiple-max":10,"project-id":t.taskDetail.project_id,"disabled-choice":t.assistData.disabled,placeholder:t.$L("\u9009\u62E9\u4EFB\u52A1\u534F\u52A9\u4EBA\u5458"),transfer:!1},model:{value:t.assistData.assist_userid,callback:function(s){t.$set(t.assistData,"assist_userid",s)},expression:"assistData.assist_userid"}}),e("div",{staticClass:"task-detail-avatar-buttons"},[e("Button",{attrs:{size:"small",type:"primary"},on:{click:function(s){return t.$refs.assist.ok()}}},[t._v(t._s(t.$L("\u786E\u5B9A")))])],1)],1),t.getAssist.length>0?e("div",{staticClass:"user-list"},t._l(t.getAssist,function(s){return e("UserAvatar",{key:s.userid,attrs:{userid:s.userid,size:28,showName:t.getAssist.length===1,tooltipDisabled:""}})}),1):e("div",[t._v("--")])])],1):t._e(),t.taskDetail.end_at||t.timeForce?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE6E8")]),t._v(t._s(t.$L("\u622A\u6B62\u65F6\u95F4"))+" ")]),e("ul",{staticClass:"item-content"},[e("li",[e("DatePicker",{attrs:{open:t.timeOpen,options:t.timeOptions,format:"yyyy/MM/dd HH:mm",type:"datetimerange",transfer:""},on:{"on-open-change":t.timeChange,"on-clear":t.timeClear,"on-ok":t.timeOk},model:{value:t.timeValue,callback:function(s){t.timeValue=s},expression:"timeValue"}},[e("div",{staticClass:"picker-time"},[e("div",{staticClass:"time",on:{click:function(s){t.isShowExtension?t.extension():t.openTime()}}},[t._v(t._s(t.taskDetail.end_at?t.cutTime:"--"))]),!t.taskDetail.complete_at&&t.taskDetail.end_at?[t.within24Hours(t.taskDetail.end_at)?e("Tag",{attrs:{color:"blue"}},[e("i",{staticClass:"taskfont"},[t._v("\uE71D")]),t._v(t._s(t.expiresFormat(t.taskDetail.end_at)))]):t._e(),t.isOverdue(t.taskDetail)?e("Tag",{attrs:{color:"red"}},[t._v(t._s(t.$L("\u8D85\u671F\u672A\u5B8C\u6210")))]):t._e()]:t._e(),t.isShowExtension?e("Button",{attrs:{type:"primary",size:"small"},on:{click:t.extension}},[t._v("\u7533\u8BF7\u5EF6\u671F")]):t._e()],2)])],1)])]):t._e(),t.taskDetail.loop&&t.taskDetail.loop!="never"||t.loopForce?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE93F")]),t._v(t._s(t.$L("\u91CD\u590D\u5468\u671F"))+" ")]),e("ul",{staticClass:"item-content"},[e("li",[e("EDropdown",{ref:"loop",attrs:{trigger:"click",placement:"bottom"},on:{command:function(s){return t.updateData("loop",s)}}},[e("ETooltip",{attrs:{disabled:t.windowSmall||t.$isEEUiApp||!t.taskDetail.loop_at,content:`${t.$L("\u4E0B\u4E2A\u5468\u671F")}: ${t.taskDetail.loop_at}`,placement:"right"}},[e("span",[t._v(t._s(t.$L(t.loopLabel(t.taskDetail.loop))))])]),e("EDropdownMenu",{staticClass:"task-detail-loop",attrs:{slot:"dropdown"},slot:"dropdown"},t._l(t.loops,function(s){return e("EDropdownItem",{key:s.key,attrs:{command:s.key}},[t._v(" "+t._s(t.$L(s.label))+" ")])}),1)],1)],1)])]):t._e(),t.fileList.length>0?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE6E6")]),t._v(t._s(t.$L("\u9644\u4EF6"))+" ")]),e("ul",{staticClass:"item-content file"},[t.taskDetail.file_num>50?e("li",{staticClass:"tip"},[t._v(t._s(t.$L(`\u5171${t.taskDetail.file_num}\u4E2A\u6587\u4EF6\uFF0C\u4EC5\u663E\u793A\u6700\u65B050\u4E2A`)))]):t._e(),t._l(t.fileList,function(s){return e("li",[s.id?e("img",{staticClass:"file-ext",attrs:{src:s.thumb}}):e("Loading",{staticClass:"file-load"}),e("div",{staticClass:"file-name"},[t._v(t._s(s.name))]),e("div",{staticClass:"file-size"},[t._v(t._s(t.$A.bytesToSize(s.size)))]),e("div",{staticClass:"file-menu",class:{show:s._show_menu}},[e("Icon",{attrs:{type:"md-eye"},on:{click:function(i){return t.viewFile(s)}}}),e("Icon",{attrs:{type:"md-arrow-round-down"},on:{click:function(i){return t.downFile(s)}}}),e("EPopover",{staticClass:"file-delete",model:{value:s._show_menu,callback:function(i){t.$set(s,"_show_menu",i)},expression:"file._show_menu"}},[e("div",{staticClass:"task-detail-delete-file-popover"},[e("p",[t._v(t._s(t.$L("\u4F60\u786E\u5B9A\u8981\u5220\u9664\u8FD9\u4E2A\u6587\u4EF6\u5417\uFF1F")))]),e("div",{staticClass:"buttons"},[e("Button",{attrs:{size:"small",type:"text"},on:{click:function(i){s._show_menu=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{size:"small",type:"primary"},on:{click:function(i){return t.deleteFile(s)}}},[t._v(t._s(t.$L("\u786E\u5B9A")))])],1)]),e("i",{staticClass:"taskfont del",attrs:{slot:"reference"},slot:"reference"},[t._v("\uE6EA")])])],1)],1)})],2),e("ul",{staticClass:"item-content"},[e("li",[e("div",{staticClass:"add-button",on:{click:function(s){return t.onUploadClick(!0)}}},[e("i",{staticClass:"taskfont"},[t._v("\uE6F2")]),t._v(t._s(t.$L("\u6DFB\u52A0\u9644\u4EF6"))+" ")])])])]):t._e(),t.subList.length>0||t.addsubForce?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE6F0")]),t._v(t._s(t.$L("\u5B50\u4EFB\u52A1"))+" ")]),e("ul",{staticClass:"item-content subtask"},t._l(t.subList,function(s,i){return e("TaskDetail",{key:i,ref:`subTask_${s.id}`,refInFor:!0,attrs:{"task-id":s.id,"open-task":s,"main-end-at":t.taskDetail.end_at,"can-update-blur":t.canUpdateBlur}})}),1),e("ul",{class:["item-content",t.subList.length===0?"nosub":""]},[e("li",[t.addsubShow?e("Input",{ref:"addsub",staticClass:"add-input",class:{loading:t.addsubLoad>0},attrs:{placeholder:t.$L("+ \u8F93\u5165\u5B50\u4EFB\u52A1\uFF0C\u56DE\u8F66\u6DFB\u52A0\u5B50\u4EFB\u52A1"),icon:t.addsubLoad>0?"ios-loading":"",enterkeyhint:"done"},on:{"on-blur":t.addsubChackClose,"on-keydown":t.addsubKeydown},model:{value:t.addsubName,callback:function(s){t.addsubName=s},expression:"addsubName"}}):e("div",{staticClass:"add-button",on:{click:t.addsubOpen}},[e("i",{staticClass:"taskfont"},[t._v("\uE6F2")]),t._v(t._s(t.$L("\u6DFB\u52A0\u5B50\u4EFB\u52A1"))+" ")])],1)])]):t._e()],1),t.menuList.length>0?e("div",{staticClass:"add"},[e("EDropdown",{attrs:{trigger:"click",placement:"bottom"},on:{command:t.dropAdd}},[e("div",{staticClass:"add-button"},[e("i",{staticClass:"taskfont"},[t._v("\uE6F2")]),t._v(" "+t._s(t.$L("\u6DFB\u52A0"))+" "),e("em",[t._v(t._s(t.menuText))])]),e("EDropdownMenu",{attrs:{slot:"dropdown"},slot:"dropdown"},t._l(t.menuList,function(s,i){return e("EDropdownItem",{key:i,attrs:{command:s.command}},[e("div",{staticClass:"item"},[e("i",{staticClass:"taskfont",domProps:{innerHTML:t._s(s.icon)}}),t._v(t._s(t.$L(s.name))+" ")])])}),1)],1)],1):t._e()],1),e("TaskUpload",{ref:"upload",staticClass:"upload",on:{"on-select-file":t.onSelectFile}})],1),e("div",{directives:[{name:"show",rawName:"v-show",value:t.taskDetail.id>0,expression:"taskDetail.id > 0"}],staticClass:"task-dialog",style:t.dialogStyle},[t.hasOpenDialog?[t.taskId>0?e("DialogWrapper",{ref:"dialog",attrs:{"dialog-id":t.taskDetail.dialog_id}},[e("div",{staticClass:"head",attrs:{slot:"head"},slot:"head"},[e("Icon",{staticClass:"icon",attrs:{type:"ios-chatbubbles-outline"}}),e("div",{staticClass:"nav"},[e("p",{class:{active:t.navActive=="dialog"},on:{click:function(s){t.navActive="dialog"}}},[t._v(t._s(t.$L("\u804A\u5929")))]),e("p",{class:{active:t.navActive=="log"},on:{click:function(s){t.navActive="log"}}},[t._v(t._s(t.$L("\u52A8\u6001")))]),t.navActive=="log"?e("div",{staticClass:"refresh"},[t.logLoadIng?e("Loading"):e("Icon",{attrs:{type:"ios-refresh"},on:{click:t.getLogLists}})],1):t._e()])],1)]):t._e(),t.navActive=="log"&&t.taskId>0?e("ProjectLog",{ref:"log",attrs:{"task-id":t.taskDetail.id},on:{"on-load-change":t.logLoadChange}}):t._e()]:e("div",[e("div",{staticClass:"head"},[e("Icon",{staticClass:"icon",attrs:{type:"ios-chatbubbles-outline"}}),e("div",{staticClass:"nav"},[e("p",{class:{active:t.navActive=="dialog"},on:{click:function(s){t.navActive="dialog"}}},[t._v(t._s(t.$L("\u804A\u5929")))]),e("p",{class:{active:t.navActive=="log"},on:{click:function(s){t.navActive="log"}}},[t._v(t._s(t.$L("\u52A8\u6001")))]),t.navActive=="log"?e("div",{staticClass:"refresh"},[t.logLoadIng?e("Loading"):e("Icon",{attrs:{type:"ios-refresh"},on:{click:t.getLogLists}})],1):t._e(),e("p",{class:{active:t.navActive=="daily"},on:{click:function(s){t.navActive="daily"}}},[t._v(t._s(t.$L("\u4EFB\u52A1\u76F8\u5173\u65E5\u62A5")))])]),e("div",{staticClass:"menu"},[t.navActive=="dialog"&&t.taskDetail.msg_num>0?e("div",{staticClass:"menu-item",on:{click:function(s){return s.stopPropagation(),t.onSend("open")}}},[t.openLoad>0?e("div",{staticClass:"menu-load"},[e("Loading")],1):t._e(),t._v(" "+t._s(t.$L("\u4EFB\u52A1\u804A\u5929"))+" "),e("em",[t._v("("+t._s(t.taskDetail.msg_num>999?"999+":t.taskDetail.msg_num)+")")]),e("i",{staticClass:"taskfont"},[t._v("\uE703")])]):t._e()])],1),t.navActive=="log"&&t.taskId>0?e("ProjectLog",{ref:"log",attrs:{"task-id":t.taskDetail.id,"show-load":!1},on:{"on-load-change":t.logLoadChange}}):t._e(),t.navActive=="dialog"?e("div",{staticClass:"no-dialog",on:{drop:function(s){return s.preventDefault(),t.taskPasteDrag(s,"drag")},dragover:function(s){return s.preventDefault(),t.taskDragOver(!0,s)},dragleave:function(s){return s.preventDefault(),t.taskDragOver(!1,s)}}},[e("div",{staticClass:"no-tip"},[t._v(t._s(t.$L("\u6682\u65E0\u6D88\u606F")))]),e("div",{staticClass:"no-input"},[e("ChatInput",{ref:"chatInput",attrs:{"task-id":t.taskId,loading:t.sendLoad>0,maxlength:2e5,placeholder:t.$L("\u8F93\u5165\u6D88\u606F...")},on:{"on-more":t.onEventMore,"on-file":t.onSelectFile,"on-record":t.onRecord,"on-send":t.onSend},model:{value:t.msgText,callback:function(s){t.msgText=s},expression:"msgText"}})],1),t.dialogDrag?e("div",{staticClass:"drag-over",on:{click:function(s){t.dialogDrag=!1}}},[e("div",{staticClass:"drag-text"},[t._v(t._s(t.$L("\u62D6\u52A8\u5230\u8FD9\u91CC\u53D1\u9001")))])]):t._e()]):t._e(),t.navActive=="daily"&&t.taskId>0?e("RelevantDaily",{attrs:{taskId:t.taskId}}):t._e()],1)],2),t.taskDetail.id?t._e():e("div",{staticClass:"task-load"},[e("Loading")],1),e("Modal",{attrs:{title:t.$L("\u7533\u8BF7\u5EF6\u671F"),"mask-closable":!1},model:{value:t.delayShow,callback:function(s){t.delayShow=s},expression:"delayShow"}},[e("Form",{ref:"addDelay",attrs:{model:t.delayData,rules:t.delayRule,"label-width":"auto"},nativeOn:{submit:function(s){s.preventDefault()}}},[e("FormItem",{attrs:{prop:"days",label:t.$L("\u5EF6\u671F\u5929\u6570")}},[e("InputNumber",{attrs:{max:1e4,min:1,formatter:function(s){return`${s}`.replace(/\B(?=(\d{3})+(?!\d))/g,",")},parser:function(s){return s.replace(/\$\s?|(,*\.)/g,"")}},model:{value:t.delayData.days,callback:function(s){t.$set(t.delayData,"days",s)},expression:"delayData.days"}})],1),e("FormItem",{staticStyle:{"margin-bottom":"10px"},attrs:{prop:"reason",label:t.$L("\u5EF6\u671F\u539F\u56E0")}},[e("Input",{attrs:{type:"textarea"},model:{value:t.delayData.reason,callback:function(s){t.$set(t.delayData,"reason",s)},expression:"delayData.reason"}})],1)],1),e("div",{staticClass:"adaption",attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(s){t.delayShow=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{type:"primary",loading:t.loadIng>0},on:{click:t.onDelay}},[t._v(t._s(t.$L("\u786E\u5B9A")))])],1)],1)],1):t._e()},M=[];const j={name:"TaskDetail",components:{ChatInput:g,TaskMenu:_,ProjectLog:p,DialogWrapper:v,TaskUpload:x,UserInput:k,TaskPriority:f,TEditor:m,RelevantDaily:z},props:{taskId:{type:Number,default:0},openTask:{type:Object,default:()=>({})},mainEndAt:{default:null},canUpdateBlur:{type:Boolean,default:!0},modalMode:{type:Boolean,default:!1}},data(){return{ready:!1,taskDetail:{},ownerData:{},ownerLoad:0,receiveShow:!1,assistForce:!1,assistData:{},assistLoad:0,addsubForce:!1,addsubShow:!1,addsubName:"",addsubLoad:0,timeForce:!1,timeOpen:!1,timeValue:[],timeOptions:{shortcuts:$A.timeOptionShortcuts()},loopForce:!1,nowTime:$A.Time(),nowInterval:null,msgText:"",msgFile:[],msgRecord:{},navActive:"dialog",logLoadIng:!1,sendLoad:0,openLoad:0,taskPlugins:["advlist autolink lists link image charmap print preview hr anchor pagebreak","searchreplace visualblocks visualchars code","insertdatetime media nonbreaking save table directionality","emoticons paste codesample","autoresize"],taskOptions:{statusbar:!1,menubar:!1,autoresize_bottom_margin:2,min_height:200,max_height:380,contextmenu:"bold italic underline forecolor backcolor | codesample | uploadImages imagePreview | preview screenload",valid_elements:"a[href|target=_blank],em,strong/b,div[align],span[style],a,br,p,img[src|alt|witdh|height],pre[class],code",toolbar:!1},taskOptionFull:{menubar:"file edit view",valid_elements:"a[href|target=_blank],em,strong/b,div[align],span[style],a,br,p,img[src|alt|witdh|height],pre[class],code",toolbar:"uploadImages | bold italic underline forecolor backcolor | codesample | preview screenload"},dialogDrag:!1,imageAttachment:!0,receiveTaskSubscribe:null,loops:[{key:"never",label:"\u4ECE\u4E0D"},{key:"day",label:"\u6BCF\u5929"},{key:"weekdays",label:"\u6BCF\u4E2A\u5DE5\u4F5C\u65E5"},{key:"week",label:"\u6BCF\u5468"},{key:"twoweeks",label:"\u6BCF\u4E24\u5468"},{key:"month",label:"\u6BCF\u6708"},{key:"year",label:"\u6BCF\u5E74"},{key:"custom",label:"\u81EA\u5B9A\u4E49"}],isShowExtension:!0,delayShow:!1,loadIng:!1,delayData:{task_id:this.taskId,days:1,reason:""},delayRule:{days:[{type:"number",message:this.$L("\u8BF7\u586B\u5199\u5EF6\u671F\u5929\u6570\uFF01"),required:!0,trigger:"change"}],reason:[{required:!0,message:this.$L("\u8BF7\u586B\u5199\u5EF6\u671F\u539F\u56E0\uFF01"),trigger:"change"}]}}},created(){const t=$A.getObject(this.$route.query,"navActive");["dialog","log"].includes(t)&&(this.navActive=t)},mounted(){this.nowInterval=setInterval(()=>{this.nowTime=$A.Time()},1e3),this.receiveTaskSubscribe=u.Store.subscribe("receiveTask",()=>{this.receiveShow=!0})},destroyed(){clearInterval(this.nowInterval),this.receiveTaskSubscribe&&(this.receiveTaskSubscribe.unsubscribe(),this.receiveTaskSubscribe=null)},computed:{...h(["userInfo","cacheProjects","cacheColumns","cacheTasks","taskContents","taskFiles","taskPriority","dialogId"]),projectName(){if(!this.taskDetail.project_id)return"";if(this.taskDetail.project_name)return this.taskDetail.project_name;const t=this.cacheProjects.find(({id:a})=>a==this.taskDetail.project_id);return t?t.name:""},columnName(){if(!this.taskDetail.column_id)return"";if(this.taskDetail.column_name)return this.taskDetail.column_name;const t=this.cacheColumns.find(({id:a})=>a==this.taskDetail.column_id);return t?t.name:""},taskContent(){if(!this.taskId)return"";let t=this.taskContents.find(({task_id:a})=>a==this.taskId);return t?t.content:""},fileList(){return this.taskId?this.taskFiles.filter(({task_id:t})=>t==this.taskId).sort((t,a)=>a.id-t.id):[]},subList(){return this.taskId?this.cacheTasks.filter(t=>t.parent_id==this.taskId).sort((t,a)=>t.id-a.id):[]},hasOpenDialog(){return this.taskDetail.dialog_id>0&&this.windowLarge},dialogStyle(){const{windowHeight:t,hasOpenDialog:a}=this,e=Math.min(1100,t);if(!e)return{};if(!a)return{};const s=e>900?200:70;return{minHeight:e-s-48+"px"}},taskDetailStyle(){const{modalMode:t,windowHeight:a,hasOpenDialog:e}=this,s=Math.min(1100,a);if(t&&e){const i=s>900?200:70;return{maxHeight:s-i-30+"px"}}return{}},cutTime(){const{taskDetail:t}=this;let a=$A.Date(t.start_at,!0),e=$A.Date(t.end_at,!0),s="";return $A.formatDate("Y/m/d",a)==$A.formatDate("Y/m/d",e)?s=$A.formatDate("Y/m/d H:i",a)+" ~ "+$A.formatDate("H:i",e):$A.formatDate("Y",a)==$A.formatDate("Y",e)?(s=$A.formatDate("Y/m/d H:i",a)+" ~ "+$A.formatDate("m/d H:i",e),s=s.replace(/( 00:00| 23:59)/g,"")):(s=$A.formatDate("Y/m/d H:i",a)+" ~ "+$A.formatDate("Y/m/d H:i",e),s=s.replace(/( 00:00| 23:59)/g,"")),s},getOwner(){const{taskDetail:t}=this;return $A.isArray(t.task_user)?t.task_user.filter(({owner:a})=>a===1).sort((a,e)=>a.id-e.id):[]},getAssist(){const{taskDetail:t}=this;return $A.isArray(t.task_user)?t.task_user.filter(({owner:a})=>a!==1).sort((a,e)=>a.id-e.id):[]},menuList(){const{taskDetail:t}=this,a=[];return t.p_name||a.push({command:"priority",icon:"&#xe6ec;",name:"\u4F18\u5148\u7EA7"}),$A.isArray(t.task_user)&&t.task_user.find(({owner:e})=>e!==1)||a.push({command:"assist",icon:"&#xe63f;",name:"\u534F\u52A9\u4EBA\u5458"}),t.end_at||a.push({command:"times",icon:"&#xe6e8;",name:"\u622A\u6B62\u65F6\u95F4"}),(!t.loop||t.loop=="never")&&a.push({command:"loop",icon:"&#xe93f;",name:"\u91CD\u590D\u5468\u671F"}),this.fileList.length==0&&a.push({command:"file",icon:"&#xe6e6;",name:"\u9644\u4EF6"}),this.subList.length==0&&a.push({command:"subtask",icon:"&#xe6f0;",name:"\u5B50\u4EFB\u52A1"}),a},menuText(){const{menuList:t}=this;let a="";return t.length>0&&t.forEach((e,s)=>{s>0&&(a+=" / "),a+=this.$L(e.name)}),a}},watch:{openTask:{handler(t){this.taskDetail=$A.cloneJSON(t),this.__openTask&&clearTimeout(this.__openTask),this.__openTask=setTimeout(a=>{var e;return(e=this.$refs.name)==null?void 0:e.resizeTextarea()},100)},immediate:!0,deep:!0},taskId:{handler(t){t>0?this.ready=!0:(this.windowSmall&&$A.onBlur(),this.timeOpen=!1,this.timeForce=!1,this.loopForce=!1,this.assistForce=!1,this.addsubForce=!1,this.receiveShow=!1,this.$refs.owner&&this.$refs.owner.handleClose(),this.$refs.assist&&this.$refs.assist.handleClose(),this.$refs.chatInput&&this.$refs.chatInput.hidePopover())},immediate:!0},receiveShow(t){t&&(this.timeValue=this.taskDetail.end_at?[this.taskDetail.start_at,this.taskDetail.end_at]:[])}},methods:{within24Hours(t){return $A.Date(t,!0)-this.nowTime<86400},expiresFormat(t){return $A.countDownFormat(t,this.nowTime)},isOverdue(t){return t.overdue?!0:$A.Date(t.end_at,!0)<this.nowTime},loopLabel(t){const a=this.loops.find(e=>e.key===t);return a?a.label:t?`\u6BCF${t}\u5929`:"\u4ECE\u4E0D"},onNameKeydown(t){t.keyCode===13&&(t.shiftKey||(t.preventDefault(),this.updateData("name")))},checkUpdate(t){let a=!1;if(this.openTask.name!=this.taskDetail.name)if(a=!0,t===!0)this.updateData("name");else return t===!1&&this.$refs.name.focus(),!0;if(this.$refs.desc&&this.$refs.desc.getContent()!=this.taskContent)if(a=!0,t===!0)this.updateData("content");else return t===!1&&this.$refs.desc.focus(),!0;if(this.addsubShow&&this.addsubName)if(a=!0,t===!0)this.onAddsub();else return t===!1&&this.$refs.addsub.focus(),!0;return this.subList.some(({id:e})=>{this.$refs[`subTask_${e}`][0].checkUpdate(t)&&(a=!0)}),a},updateBlur(t,a){this.canUpdateBlur&&this.updateData(t,a)},updateData(t,a){let e=null;switch(t){case"priority":this.$set(this.taskDetail,"p_level",a.priority),this.$set(this.taskDetail,"p_name",a.name),this.$set(this.taskDetail,"p_color",a.color),t=["p_level","p_name","p_color"];break;case"times":if(this.taskDetail.start_at&&(Math.abs($A.Time(this.taskDetail.start_at)-$A.Time(a.start_at))>60||Math.abs($A.Time(this.taskDetail.end_at)-$A.Time(a.end_at))>60)&&typeof a.desc=="undefined"){$A.modalInput({title:"\u4FEE\u6539\u4EFB\u52A1\u65F6\u95F4",placeholder:"\u8BF7\u8F93\u5165\u4FEE\u6539\u5907\u6CE8",okText:"\u786E\u5B9A",onOk:o=>o?(this.updateData("times",Object.assign(a,{desc:o})),!1):"\u8BF7\u8F93\u5165\u4FEE\u6539\u5907\u6CE8"});return}this.$set(this.taskDetail,"times",[a.start_at,a.end_at,a.desc]);break;case"loop":if(a==="custom"){this.customLoop();return}this.$set(this.taskDetail,"loop",a);break;case"content":const i=this.$refs.desc.getContent();if(i==this.taskContent)return;this.$set(this.taskDetail,"content",i),e=()=>{this.$store.dispatch("saveTaskContent",{task_id:this.taskId,content:i})};break}let s={task_id:this.taskDetail.id};($A.isArray(t)?t:[t]).forEach(i=>{let o=this.taskDetail[i],c=this.openTask[i];$A.jsonStringify(o)!=$A.jsonStringify(c)&&(s[i]=o)}),!(Object.keys(s).length<=1)&&this.$store.dispatch("taskUpdate",s).then(({msg:i})=>{$A.messageSuccess(i),typeof e=="function"&&e()}).catch(({msg:i})=>{$A.modalError(i)})},customLoop(){let t=this.taskDetail.loop||1;$A.Modal.confirm({render:a=>a("div",[a("div",{style:{fontSize:"16px",fontWeight:"500",marginBottom:"20px"}},this.$L("\u91CD\u590D\u5468\u671F")),a("Input",{style:{width:"160px",margin:"0 auto"},props:{type:"number",value:t,maxlength:3},on:{input:e=>{t=$.runNum(e)}}},[a("span",{slot:"prepend"},this.$L("\u6BCF")),a("span",{slot:"append"},this.$L("\u5929"))])]),onOk:a=>{this.$Modal.remove(),t>0&&this.updateData("loop",t)},loading:!0,okText:this.$L("\u786E\u5B9A"),cancelText:this.$L("\u53D6\u6D88")})},openOwner(){const t=this.getOwner.map(({userid:a})=>a);this.$set(this.taskDetail,"owner_userid",t),this.$set(this.ownerData,"owner_userid",t)},onOwner(t){let a={task_id:this.taskDetail.id,owner:this.ownerData.owner_userid};if(t===!0){if(this.getOwner.length>0){this.receiveShow=!1,$A.messageError("\u4EFB\u52A1\u5DF2\u88AB\u9886\u53D6");return}let e=$A.date2string(this.timeValue,"Y-m-d H:i");if(e[0]&&e[1])$A.rightExists(e[0],"00:00")&&$A.rightExists(e[1],"00:00")&&(e[1]=e[1].replace("00:00","23:59"));else{$A.messageError("\u8BF7\u8BBE\u7F6E\u8BA1\u5212\u65F6\u95F4");return}a.times=e,a.owner=this.ownerData.owner_userid=[this.userId]}$A.jsonStringify(this.taskDetail.owner_userid)!==$A.jsonStringify(this.ownerData.owner_userid)&&($A.count(a.owner)==0&&(a.owner=""),this.ownerLoad++,this.$store.dispatch("taskUpdate",a).then(({msg:e})=>{$A.messageSuccess(e),this.ownerLoad--,this.receiveShow=!1,this.$store.dispatch("getTaskOne",this.taskDetail.id).catch(()=>{})}).catch(({msg:e})=>{$A.modalError(e),this.ownerLoad--,this.receiveShow=!1}))},openAssist(){const t=this.getAssist.map(({userid:a})=>a);this.$set(this.taskDetail,"assist_userid",t),this.$set(this.assistData,"assist_userid",t),this.$set(this.assistData,"disabled",this.getOwner.map(({userid:a})=>a).filter(a=>a!=this.userId))},onAssist(){if($A.jsonStringify(this.taskDetail.assist_userid)!==$A.jsonStringify(this.assistData.assist_userid)){if(this.getOwner.find(({userid:t})=>t===this.userId)&&this.assistData.assist_userid.find(t=>t===this.userId)){$A.modalConfirm({content:"\u4F60\u5F53\u524D\u662F\u8D1F\u8D23\u4EBA\uFF0C\u786E\u5B9A\u8981\u8F6C\u4E3A\u534F\u52A9\u4EBA\u5458\u5417\uFF1F",cancelText:"\u53D6\u6D88",okText:"\u786E\u5B9A",onOk:()=>{this.onAssistConfirm()}});return}this.onAssistConfirm()}},onAssistConfirm(){let t=this.assistData.assist_userid;t.length===0&&(t=!1),this.assistLoad++,this.$store.dispatch("taskUpdate",{task_id:this.taskDetail.id,assist:t}).then(({msg:a})=>{$A.messageSuccess(a),this.assistLoad--,this.$store.dispatch("getTaskOne",this.taskDetail.id).catch(()=>{})}).catch(({msg:a})=>{$A.modalError(a),this.assistLoad--})},openTime(){this.timeOpen=!this.timeOpen,this.timeOpen&&(this.timeValue=this.taskDetail.end_at?[this.taskDetail.start_at,this.taskDetail.end_at]:[])},timeChange(t){t||(this.timeOpen=!1)},timeClear(){this.updateData("times",{start_at:!1,end_at:!1}),this.timeOpen=!1},timeOk(){let t=$A.date2string(this.timeValue,"Y-m-d H:i");t[0]&&t[1]&&$A.rightExists(t[0],"00:00")&&$A.rightExists(t[1],"00:00")&&(t[1]=t[1].replace("00:00","23:59")),this.updateData("times",{start_at:t[0],end_at:t[1]}),this.timeOpen=!1},addsubOpen(){this.addsubShow=!0,this.$nextTick(()=>{this.$refs.addsub.focus()})},addsubChackClose(){this.addsubName==""&&(this.addsubShow=!1)},addsubKeydown(t){if(t.keyCode===13){if(t.shiftKey||this.addsubLoad>0)return;t.preventDefault(),this.onAddsub()}},onAddsub(){if(this.addsubName==""){$A.messageError("\u4EFB\u52A1\u63CF\u8FF0\u4E0D\u80FD\u4E3A\u7A7A");return}this.addsubLoad++,this.$store.dispatch("taskAddSub",{task_id:this.taskDetail.id,name:this.addsubName}).then(({msg:t})=>{$A.messageSuccess(t),this.addsubLoad--,this.addsubName=""}).catch(({msg:t})=>{$A.modalError(t),this.addsubLoad--})},getLogLists(){this.navActive=="log"&&this.$refs.log.getLists(!0)},logLoadChange(t){this.logLoadIng=t},dropAdd(t){switch(t){case"priority":this.$set(this.taskDetail,"p_name",this.$L("\u672A\u8BBE\u7F6E")),this.$nextTick(()=>{this.$refs.priority.show()});break;case"assist":this.assistForce=!0,this.openAssist(),this.$nextTick(()=>{this.$refs.assist.handleClick()});break;case"times":this.timeForce=!0,this.$nextTick(()=>{this.openTime()});break;case"loop":this.loopForce=!0,this.$nextTick(()=>{this.$refs.loop.show()});break;case"file":this.onUploadClick(!0);break;case"subtask":this.addsubForce=!0,this.$nextTick(()=>{this.addsubOpen()});break}},onEventMore(t){["image","file"].includes(t)&&this.onUploadClick(!1)},onUploadClick(t){this.imageAttachment=!!t,this.$refs.upload.handleClick()},msgDialog(t=null,a=!1){this.sendLoad>0||this.openLoad>0||(a===!0?this.openLoad++:this.sendLoad++,this.$store.dispatch("call",{url:"project/task/dialog",data:{task_id:this.taskDetail.id}}).then(({data:e})=>{this.$store.dispatch("saveTask",{id:e.id,dialog_id:e.dialog_id}),this.$store.dispatch("saveDialog",e.dialog_data),$A.isSubElectron?this.resizeDialog().then(()=>{this.sendDialogMsg(t)}):this.$nextTick(()=>{if(this.windowSmall){$A.onBlur();const s={time:$A.Time()+10,msgRecord:this.msgRecord,msgFile:this.msgFile,msgText:typeof t=="string"&&t?t:this.msgText,dialogId:e.dialog_id};this.msgRecord={},this.msgFile=[],this.msgText="",this.$nextTick(i=>{this.dialogId>0&&this.$store.dispatch("openTask",0),this.$store.dispatch("openDialog",e.dialog_id).then(o=>{this.$store.state.dialogMsgTransfer=s})})}else this.sendDialogMsg(t)})}).catch(({msg:e})=>{$A.modalError(e)}).finally(e=>{a===!0?this.openLoad--:this.sendLoad--}))},sendDialogMsg(t=null){this.msgFile.length>0?this.$refs.dialog.sendFileMsg(this.msgFile.map(a=>Object.assign(a,{ajaxExtraData:{image_attachment:this.imageAttachment?1:0}}))):this.msgText?this.$refs.dialog.sendMsg(this.msgText):typeof t=="string"&&t&&this.$refs.dialog.sendMsg(t),this.msgFile=[],this.msgText=""},taskPasteDrag(t,a){this.dialogDrag=!1;const e=a==="drag"?t.dataTransfer.files:t.clipboardData.files;this.msgFile=Array.prototype.slice.call(e),this.msgFile.length>0&&(t.preventDefault(),this.msgDialog())},taskDragOver(t,a){let e=this.__dialogDrag=$A.randomString(8);if(!t)setTimeout(()=>{e===this.__dialogDrag&&(this.dialogDrag=t)},150);else{if(a.dataTransfer.effectAllowed==="move")return;this.dialogDrag=!0}},onSelectFile(t){this.msgFile=$A.isArray(t)?t:[t],this.msgDialog()},onRecord(t){this.msgRecord=t,this.msgDialog()},onSend(t){this.$refs.chatInput&&this.$refs.chatInput.hidePopover(),t==="open"?this.msgDialog(null,!0):this.msgDialog(t)},deleteFile(t){this.$set(t,"_show_menu",!1),this.$store.dispatch("forgetTaskFile",t.id),this.$store.dispatch("call",{url:"project/task/filedelete",data:{file_id:t.id}}).catch(({msg:a})=>{$A.modalError(a),this.$store.dispatch("getTaskFiles",this.taskDetail.id)})},openMenu(t,a){const e=this.$refs[`taskMenu_${a.id}`];e&&e.handleClick(t)},openNewWin(){let t={title:this.taskDetail.name,titleFixed:!0,parent:null,width:Math.min(window.screen.availWidth,this.$el.clientWidth+72),height:Math.min(window.screen.availHeight,this.$el.clientHeight+72),minWidth:600,minHeight:450};this.hasOpenDialog&&(t.minWidth=800,t.minHeight=600),this.$Electron.sendMessage("windowRouter",{name:`task-${this.taskDetail.id}`,path:`/single/task/${this.taskDetail.id}?navActive=${this.navActive}`,force:!1,config:t}),this.$store.dispatch("openTask",0)},resizeDialog(){return new Promise(t=>{this.$Electron.sendMessage("windowSize",{width:Math.max(1100,this.windowWidth),height:Math.max(720,this.windowHeight),minWidth:800,minHeight:600,autoZoom:!0});let a=0,e=setInterval(()=>{a++,(this.$refs.dialog||a>20)&&(clearInterval(e),this.$refs.dialog&&t())},100)})},viewFile(t){if(["jpg","jpeg","webp","gif","png"].includes(t.ext)){const e=this.fileList.filter(i=>["jpg","jpeg","webp","gif","png"].includes(i.ext)),s=e.findIndex(i=>i.id===t.id);s>-1?this.$store.dispatch("previewImage",{index:s,list:e.map(i=>({src:i.path,width:i.width,height:i.height}))}):this.$store.dispatch("previewImage",{index:0,list:[{src:t.path,width:t.width,height:t.height}]});return}const a=`/single/file/task/${t.id}`;this.$Electron?this.$Electron.sendMessage("windowRouter",{name:`file-task-${t.id}`,path:a,userAgent:"/hideenOfficeTitle/",force:!1,config:{title:`${t.name} (${$A.bytesToSize(t.size)})`,titleFixed:!0,parent:null,width:Math.min(window.screen.availWidth,1440),height:Math.min(window.screen.availHeight,900)},webPreferences:{nodeIntegrationInSubFrames:t.ext==="drawio"}}):this.$isEEUiApp?$A.eeuiAppOpenPage({pageType:"app",pageTitle:`${t.name} (${$A.bytesToSize(t.size)})`,url:"web.js",params:{titleFixed:!0,allowAccess:!0,url:$A.rightDelete(window.location.href,window.location.hash)+`#${a}`}}):window.open($A.apiUrl(`..${a}`))},downFile(t){$A.modalConfirm({title:"\u4E0B\u8F7D\u6587\u4EF6",content:`${t.name} (${$A.bytesToSize(t.size)})`,okText:"\u7ACB\u5373\u4E0B\u8F7D",onOk:()=>{this.$store.dispatch("downUrl",$A.apiUrl(`project/task/filedown?file_id=${t.id}`))}})},extension(){this.delayShow=!0},onDelay(){this.$refs.addDelay.validate(t=>{t&&(this.loadIng++,this.$store.dispatch("call",{url:"project/task/delay",data:this.delayData}).then(({data:a,msg:e})=>{$A.messageSuccess(e),this.delayShow=!1,this.$refs.addDelay.resetFields(),this.$store.dispatch("getTaskForProject",this.taskDetail.project_id).catch(()=>{})}).catch(({msg:a})=>{$A.modalError(a)}).finally(a=>{this.loadIng--}))})}}},d={};var P=n(j,E,M,!1,U,null,null,null);function U(t){for(let a in d)this[a]=d[a]}var q=function(){return P.exports}();export{q as T};
